<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Plague Clinic git test</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#111a33;
      --panel2:#0f1730;
      --text:#e9eefc;
      --muted:#9fb0d9;
      --line:rgba(255,255,255,.08);
      --ok:#49d17d;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --accent:#5b7cff;
      --btn:#1b2a55;
      --btn2:#23356b;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,Segoe UI,Roboto,Arial;
      background: radial-gradient(1200px 700px at 30% -20%, rgba(91,124,255,.25), transparent 60%),
                  radial-gradient(900px 600px at 70% 0%, rgba(73,209,125,.14), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:720px; margin:0 auto; padding:16px;}
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px; border:1px solid var(--line); border-radius:16px;
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      margin-bottom:12px;
    }
    .title{display:flex; gap:10px; align-items:center; font-weight:800;}
    .pill{
      padding:6px 10px; border:1px solid var(--line); border-radius:999px;
      background:rgba(255,255,255,.03); display:flex; gap:8px; align-items:center;
      font-weight:700;
    }
    .muted{color:var(--muted); font-weight:500}
    .screen{display:none}
    .screen.active{display:block}
    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      margin:12px 0;
    }
    h2{margin:0 0 10px 0; font-size:18px}
    .card{
      background:rgba(0,0,0,.12);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      margin:10px 0;
    }
    .row{display:flex; gap:10px; align-items:center; justify-content:space-between}
    .btn{
      background:linear-gradient(180deg, var(--btn2), var(--btn));
      color:var(--text);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      font-weight:800;
      cursor:pointer;
      text-align:left;
      width:100%;
    }
    .btn:active{transform:scale(.99)}
    .btn.small{width:auto; padding:8px 10px; border-radius:12px}
    .btn.danger{background:linear-gradient(180deg, rgba(255,107,107,.22), rgba(255,107,107,.12))}
    .btn.ok{background:linear-gradient(180deg, rgba(73,209,125,.22), rgba(73,209,125,.12))}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .tag{
      padding:4px 8px; border:1px solid var(--line); border-radius:999px;
      font-weight:800; font-size:12px; background:rgba(255,255,255,.03);
      display:inline-flex; align-items:center; gap:6px;
    }
    .right{ text-align:right }
    .timer{font-weight:900; letter-spacing:.3px}
    .ok{color:var(--ok)}
    .warn{color:var(--warn)}
    .bad{color:var(--bad)}
    .listBtn{
      background:rgba(0,0,0,.12);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      margin:10px 0;
      cursor:pointer;
    }
    .listBtn:active{transform:scale(.995)}
    .listTitle{font-weight:900; font-size:16px}
    .listSub{color:var(--muted); margin-top:4px}
    .hint{font-size:12px; color:var(--muted); margin-top:8px}
    .sep{height:1px; background:var(--line); margin:10px 0}
  </style>
</head>
<body>
<div class="wrap">

  <!-- TOP -->
  <div class="topbar">
    <div class="title">üß™ –ß—É–º–Ω–∞—è –∫–ª–∏–Ω–∏–∫–∞ </div>
    <div style="display:flex; gap:8px; align-items:center;">
      <div class="pill">üè• –£—Ä. <span id="clinic-level">1</span></div>
      <div class="pill">üí∞ <span id="coins">0</span></div>
      <div class="pill">‚≠ê –†–µ–ø. <span id="rep">0</span></div>
      <div class="pill">üß´ <span id="bio">0</span></div>
      <div class="pill">‚è≥ <span id="shift-timer">--:--</span></div>
    </div>
  </div>

  <!-- SCREEN: CLINIC -->
  <div class="screen active" id="screen-clinic">

    <div class="panel">
      <h2>–ü–∞–ª–∞—Ç—ã</h2>
      <div id="wards"></div>
      <div class="hint">–ü–∞–ª–∞—Ç—ã –ª–µ—á–∞—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ. –ü—Ä–æ–∫–∞—á–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞ –∫–∞–ø–∞–º–∏ –∏ –¥–æ—Ä–æ–∂–∞–µ—Ç.</div>
    </div>

    <div class="panel">
  <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
  <button class="btn" onclick="openStaff()">
    üë• –®—Ç–∞—Ç
    <div class="muted">–°–ø–∏—Å–æ–∫ –≤—Ä–∞—á–µ–π –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞ —Å–º–µ–Ω—É</div>
  </button>
</div>

    <div class="panel">
      <h2>–î–µ–∂—É—Ä–Ω—ã–µ –¥–æ–∫—Ç–æ—Ä–∞</h2>
      <div id="duty"></div>
      <div class="hint">–î–µ–∂—É—Ä–Ω—ã–µ –¥–∞—é—Ç —Å–æ–≤–µ—Ç—ã –∏ —à—Ç—Ä–∞—Ñ—É—é—Ç –º–µ—Ç–æ–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ ‚Äú–Ω–µ —É–º–µ—é—Ç‚Äù.</div>
    </div>

    <div class="panel">
      <h2>–û—á–µ—Ä–µ–¥—å –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤</h2>
      <div id="queue"></div>
      <div class="hint">–ï—Å–ª–∏ –¥–æ–ª–≥–æ –Ω–µ –ª–µ—á–∏—Ç—å: –º–æ–≥—É—Ç —É–π—Ç–∏ –∏–ª–∏ —É–º–µ—Ä–µ—Ç—å –ø—Ä—è–º–æ –≤ –æ—á–µ—Ä–µ–¥–∏. –ñ–∏–∑–Ω—å.</div>
    </div>

  </div>

  <!-- SCREEN: PATIENT -->
  <div class="screen" id="screen-patient">

    <div class="panel">
      <div class="row">
        <div>
          <div class="listTitle" id="patient-title">–ü–∞—Ü–∏–µ–Ω—Ç</div>
          <div class="listSub" id="patient-sub">—Å–∏–º–ø—Ç–æ–º—ã‚Ä¶</div>
        </div>
        <button class="btn small" onclick="backToClinic()">‚Üê –ù–∞–∑–∞–¥</button>
      </div>

      <div class="sep"></div>

      <div class="muted">–ü–æ–¥–æ–∑—Ä–µ–Ω–∏–µ:</div>
      <div id="patient-disease" style="font-weight:900; margin-top:4px;">?</div>

      <div class="sep"></div>

      <div class="muted">–°–æ–≤–µ—Ç—ã –¥–µ–∂—É—Ä–Ω—ã—Ö:</div>
      <div id="doctor-advice" class="hint"></div>
    </div>

      <div class="sep"></div>

<button class="btn" id="btn-lab" onclick="labResearchSelected()">
  üî¨ –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å –≤ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏
  <div class="muted" id="lab-sub">–û—Ç–∫—Ä–æ–µ—Ç –Ω–æ–≤—ã–π —Å–∏–º–ø—Ç–æ–º</div>
</button>
<div class="hint" id="lab-hint"></div>

    <!-- –ù–∞–∑–Ω–∞—á–∏—Ç—å –ª–µ—á–µ–Ω–∏–µ -->
    <div class="panel" id="treat-panel">
      <h2>–ù–∞–∑–Ω–∞—á–∏—Ç—å –ª–µ—á–µ–Ω–∏–µ</h2>
      <div id="treatment-buttons"></div>
      <div class="hint">–í—ã–±–∏—Ä–∞–π –∏–∑ 4 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤. –û–¥–∏–Ω –æ–±—ã—á–Ω–æ –ª—É—á—à–µ, –æ–¥–∏–Ω –æ–±—ã—á–Ω–æ —Ö—É–∂–µ, –¥–≤–∞ –ø—Ä–æ—Å—Ç–æ –ø–æ –ø—Ä–∏–∫–æ–ª—É.</div>
    </div>

    <!-- –ê–∫—Ç–∏–≤–Ω–æ–µ –ª–µ—á–µ–Ω–∏–µ -->
    <div class="panel" id="active-treatment" style="display:none">
      <h2>–õ–µ—á–µ–Ω–∏–µ –∏–¥—ë—Ç</h2>
      <div class="muted">–ú–µ—Ç–æ–¥:</div>
      <div id="active-treatment-name" style="font-weight:900; margin:6px 0 10px 0;">‚Äî</div>
      <div class="muted">–û—Å—Ç–∞–ª–æ—Å—å:</div>
      <div id="active-treatment-timer" class="timer">--:--</div>

    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
    <div class="panel" id="result-panel" style="display:none">
      <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç</h2>
      <div id="result-text"></div>
    </div>
   </div>

   <!-- SCREEN: SHIFT END -->
<div class="screen" id="screen-shiftend">
  <div class="panel">
    <div class="listTitle">–°–º–µ–Ω–∞ –æ–∫–æ–Ω—á–µ–Ω–∞</div>
    <div class="listSub" id="shift-summary">‚Ä¶</div>
    <div class="sep"></div>
    <button class="btn ok" onclick="startNewShift()">
      üîÅ –ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é —Å–º–µ–Ω—É
      <div class="muted">–û—á–µ—Ä–µ–¥—å –æ–±–Ω–æ–≤–∏—Ç—Å—è, —Ç–∞–π–º–µ—Ä —Å–±—Ä–æ—Å–∏—Ç—Å—è</div>
    </button>
  </div>
 </div>
</div>  

<!-- SCREEN: STAFF -->
<div class="screen" id="screen-staff">
  <div class="panel">
    <div class="row">
      <div>
        <div class="listTitle">üë• –®—Ç–∞—Ç</div>
        <div class="listSub">–í—ã–±–µ—Ä–∏ –≤—Ä–∞—á–∞ –∏ –Ω–∞–∑–Ω–∞—á—å –≤ —Å–ª–æ—Ç.</div>
      </div>
      <button class="btn small" onclick="backToClinic()">‚Üê –ù–∞–∑–∞–¥</button>
    </div>
    <div class="sep"></div>
    <div id="staff-list"></div>
  </div>
</div>  

<script>

  let state = null;
/* =========================================================
   0) CONST / ENUMS
========================================================= */

const OUTCOMES = {
  CURE: "cure",
  DISFIGURED: "disfigured",
  INFECTED: "infected",
  WORSENED: "worsened",
  DEATH: "death"
};

const RARITY = {
  COMMON: "common",
  RARE: "rare",
  LEGENDARY: "legendary"
};

const LS_STATE = "plague_state_v4";
const LS_ACTIVE = "plague_active_map_v4";

/* =========================================================
   1) DATA: methods / diseases / doctors / names
========================================================= */

const METHODS = [
  { id:"bloodletting", name:"ü©∏ –ö—Ä–æ–≤–æ–ø—É—Å–∫–∞–Ω–∏–µ" },
  { id:"herbalism", name:"üåø –ù–∞—Å—Ç–æ–π —Ç—Ä–∞–≤" },
  { id:"prayer", name:"üôè –ú–æ–ª–∏—Ç–≤–∞" },
  { id:"demonology", name:"üòà –î–µ–º–æ–Ω–æ–ª–æ–≥–∏—è" },
  { id:"amputation", name:"ü™ì –ê–º–ø—É—Ç–∞—Ü–∏—è" },
  { id:"hypnosis", name:"üåÄ –ì–∏–ø–Ω–æ–∑" },
  { id:"charms", name:"üïØ –ó–∞–≥–æ–≤–æ—Ä—ã" },
];


function methodName(id){
  const m = METHODS.find(x=>x.id===id);
  return m ? m.name : id;
}

  function toFemaleLastName(last){
  // –ù–µ—Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ/–Ω–µ–∏–∑–º–µ–Ω—è–µ–º—ã–µ (–Ω–∞ –≤—Å—è–∫–∏–π)
  const indeclinable = ["–°–∫–≤–æ–∑–Ω—è–∫"];
  if(indeclinable.includes(last)) return last;

  // -—ã–π / -–∏–π -> -–∞—è
  if(last.endsWith("—ã–π")) return last.slice(0, -2) + "–∞—è";
  if(last.endsWith("–∏–π")) return last.slice(0, -2) + "–∞—è";

  // -–æ–π -> -–∞—è (—Ä–µ–¥–∫–æ, –Ω–æ –ø—É—Å—Ç—å –±—É–¥–µ—Ç)
  if(last.endsWith("–æ–π")) return last.slice(0, -2) + "–∞—è";

  // –µ—Å–ª–∏ —É–∂–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ –∂–µ–Ω—Å–∫–æ–µ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
  if(last.endsWith("–∞—è")) return last;

  // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–µ —Ç—Ä–æ–≥–∞–µ–º
  return last;
}

// –ë–æ–ª–µ–∑–Ω–∏: —Å–∏–º–ø—Ç–æ–º—ã + –≤–µ—Å–∞ –º–µ—Ç–æ–¥–æ–≤ (—á–µ–º –≤—ã—à–µ, —Ç–µ–º ‚Äú–ª—É—á—à–µ —à–∞–Ω—Å‚Äù)
const DISEASES = [
  {
    id:"miasma_fever",
    name:"–ú–∏–∞–∑–º–µ–Ω–Ω–∞—è –ª–∏—Ö–æ—Ä–∞–¥–∫–∞",
    rarity: RARITY.COMMON,
    symptoms:["–ñ–∞—Ä","–û–∑–Ω–æ–±","–¢—è–∂–µ—Å—Ç—å –≤ –≥—Ä—É–¥–∏"],
    weights:{ herbalism: 1.2, prayer: 1.0, bloodletting: 0.8, hypnosis: 0.9, charms: 1.0, demonology: 0.6, amputation: 0.2 }
  },
  {
    id:"black_spots",
    name:"–ß—ë—Ä–Ω—ã–µ –ø—è—Ç–Ω–∞",
    rarity: RARITY.RARE,
    symptoms:["–ß—ë—Ä–Ω—ã–µ –ø—è—Ç–Ω–∞","–°–ª–∞–±–æ—Å—Ç—å","–ú—Ä–∞—á–Ω—ã–µ —Ä–µ—á–∏"],
    weights:{ bloodletting: 1.3, demonology: 1.1, herbalism: 0.9, prayer: 0.8, hypnosis: 0.7, charms: 1.0, amputation: 0.3 }
  },
  {
    id:"glass_cough",
    name:"–°—Ç–µ–∫–ª—è–Ω–Ω—ã–π –∫–∞—à–µ–ª—å",
    rarity: RARITY.COMMON,
    symptoms:["–ö–∞—à–µ–ª—å","–°—É—Ö–æ—Å—Ç—å","–ì–æ–ª–æ–≤–Ω–∞—è –º—É—Ç—å"],
    weights:{ herbalism: 1.2, hypnosis: 1.0, prayer: 0.9, bloodletting: 0.7, charms: 0.8, demonology: 0.5, amputation: 0.1 }
  },
  {
    id:"holy_worms",
    name:"–°–≤—è—Ç—ã–µ —á–µ—Ä–≤–∏",
    rarity: RARITY.LEGENDARY,
    symptoms:["–®–µ–ø—á–µ—Ç –º–æ–ª–∏—Ç–≤—ã","–ü—É—Å—Ç–æ–π –≤–∑–≥–ª—è–¥","–ó—É–¥ –ø–æ–¥ –∫–æ–∂–µ–π"],
    weights:{ prayer: 1.3, demonology: 1.2, charms: 1.1, hypnosis: 0.9, herbalism: 0.7, bloodletting: 0.6, amputation: 0.4 }
  },
  {
    id:"bone_mold",
    name:"–ö–æ—Å—Ç—è–Ω–∞—è –ø–ª–µ—Å–µ–Ω—å",
    rarity: RARITY.RARE,
    symptoms:["–ë–æ–ª—å –≤ –∫–æ—Å—Ç—è—Ö","–ü–ª–µ—Å–µ–Ω—å –Ω–∞ –ø–æ–≤—è–∑–∫–∞—Ö","–°–∫—Ä–∏–ø –≤ —Å—É—Å—Ç–∞–≤–∞—Ö"],
    weights:{ amputation: 1.2, herbalism: 0.9, bloodletting: 0.8, prayer: 0.8, demonology: 0.9, hypnosis: 0.6, charms: 0.7 }
  }
];

const FIRST_NAMES = ["–ì–∞–Ω—Å","–ú–∞—Ä—Ç–∞","–ü–∞—Ö–æ–º","–í–∏–ª–ª–µ–º","–ò–≤–∞–Ω","–ó–∏–≥–º—É–Ω–¥","–õ—É–ø–∞","–Ø–Ω","–ê–≤–≥—É—Å—Ç","–ü—É–ø–∞","–ö–∞—Å–ø–∞—Ä","–°–∞–Ω—è","–ú–∏—Ö–∞–∏–ª","–ó–∞—Ä—É–±","–ö–∞—Å–ø–∞—Ä"];
const FEMALE_FIRST_NAMES = new Set(["–ú–∞—Ä—Ç–∞","–§—Ä–∏–¥–∞","–ì—Ä–µ—Ç–∞","–ò–¥–∞","–õ–æ—Ç—Ç–∞","–ó—É—Ö—Ä–∞","–°–∞–Ω–∏–Ω–∞","–ú–∞—Ä–∏—è",]);  
const LAST_NAMES  = ["–°–æ–ø–ª–∏–≤—ã–π","–°–∫–≤–æ–∑–Ω—è–∫","–ù–µ–≤–µ–∑—É—á–∏–π","–®–∞—Ç–∫–∏–π","–ö—Ä–∏–ø–æ–≤—ã–π","–ß–µ—à—É–π—á–∞—Ç—ã–π","–ö–∏—Å–ª—ã–π","–ë–ª–µ–¥–Ω—ã–π","–°–∫—Ä–∏–ø—É—á–∏–π","–ü–ª–µ—Å–Ω–µ–≤—ã–π","–°—É–º—Ä–∞—á–Ω—ã–π","–£–≥—Ä—é–º—ã–π"];

const DOCTOR_POOL = [
  // common: 1 –º–µ—Ç–æ–¥
  { id:"doc_herb",  name:"–î–æ–∫—Ç–æ—Ä –¢—Ä–∞–≤–Ω–∏–∫",   rarity:RARITY.RARE,      methods:["herbalism","charms"], persona:"confident" },
  { id:"doc_blood", name:"–î–æ–∫—Ç–æ—Ä –ü–∏—è–≤–∫–∞",    rarity:RARITY.COMMON,    methods:["bloodletting"], persona:"fanatic" },
  { id:"doc_priest",name:"–û—Ç–µ—Ü –ö–∞–¥–∏–ª–æ",      rarity:RARITY.RARE,      methods:["prayer","charms"], persona:"confident" },
  { id:"doc_demo",  name:"–ú–∞–≥ –ü–µ–ø–µ–ª",        rarity:RARITY.LEGENDARY, methods:["demonology","hypnosis","charms"], persona:"trickster" },
  { id:"doc_amput", name:"–ú–∞—Å—Ç–µ—Ä –ü–∏–ª–∞",      rarity:RARITY.RARE,      methods:["amputation","bloodletting"], persona:"cold" },
  { id:"doc_hypno", name:"–ì–∏–ø–Ω–æ—Ç–∏–∑—ë—Ä –ù–∏—Ç–∫–∞", rarity:RARITY.COMMON,    methods:["hypnosis"], persona:"uncertain" },
];

function rarityLabel(r){
  return r===RARITY.LEGENDARY ? "Legendary" : r===RARITY.RARE ? "Rare" : "Common";
}

/* =========================================================
   2) STATE
========================================================= */

function defaultState(){
  return {
    clinicXP: 0,
    clinicLevel: 1,
    coins: 120,
    reputation: 0,
    biomaterial: 0,
unlocks: {
  wardB: false,
  staffScreen: true // —à—Ç–∞—Ç –≤–∫–ª—é—á–∏–º —Å—Ä–∞–∑—É, –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞ –±–µ–∑ –º–∞–≥–∞–∑–∏–Ω–∞
},
    shift: {
  active: true,
  durationSec: 20*60,     // 8 –º–∏–Ω—É—Ç –Ω–∞ —Ç–µ—Å—Ç
  endAt: now() + 20*60*1000,
  cured: 0,
  deaths: 0,
  left: 0
},

    wards: [
      makeWard("A"),
    ],

    duty: {
      slot1: pickRandomDoctorId(),
  slot2: null, // –≤—Ç–æ—Ä–æ–π —Å–ª–æ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –Ω–∞ —Å—Ç–∞—Ä—Ç–µ
    },

    lab: {
  costCoins: 15,      // —Ü–µ–Ω–∞ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
  maxPerPatient: 2    // —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –º–æ–∂–Ω–æ –∫–æ–≤—ã—Ä—è—Ç—å—Å—è –≤ –æ–¥–Ω–æ–º –ø–∞—Ü–∏–µ–Ω—Ç–µ
},

    patients: [],
    queue: [],
    selectedPatientId: null,

    // –±–∞–ª–∞–Ω—Å
    maxQueue: 6,
    baseWaitSec: 120,     // —Å–∫–æ–ª—å–∫–æ –º–æ–∂–µ—Ç –∂–¥–∞—Ç—å –≤ –æ—á–µ—Ä–µ–¥–∏
    baseTreatSecMin: 120,
    baseTreatSecMax: 300,
  };
}

function makeWard(letter){
  return {
    id: "ward_"+letter,
    name: "–ü–∞–ª–∞—Ç–∞ "+letter,
    level: 1,

    // —Å—Ç–∞—Ç—ã (—Å –∫–∞–ø–∞–º–∏)
    comfort: 1,
    cleanliness: 1,
    ventilation: 1,
    light: 1,

    // –∫–∞–ø—ã
    capComfort: 6,
    capCleanliness: 6,
    capVentilation: 6,
    capLight: 6,

    // –∑–∞–Ω—è—Ç–æ—Å—Ç—å
    occupiedBy: null,      // patientId
    pendingResult: null,   // outcome object after finish
  };
}

function loadState(){
  try{
    const raw = localStorage.getItem(LS_STATE);
    if(!raw) return defaultState();
    const s = JSON.parse(raw);

    // –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ —Å–ª—É—á–∞–π —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π
    if(s.coins==null) s.coins=0;
    if(s.reputation==null) s.reputation=0;
    if(s.biomaterial==null) s.biomaterial=0;
    if(!s.wards || !Array.isArray(s.wards)) s.wards = [makeWard("A"), makeWard("B")];
    if(!s.queue) s.queue=[];
    if(!s.patients) s.patients=[];
    if(!s.duty) s.duty={slot1:pickRandomDoctorId(), slot2:pickRandomDoctorId(true)};
    if(!s.maxQueue) s.maxQueue=6;
    if(!s.baseWaitSec) s.baseWaitSec=120;
    if(!s.baseTreatSecMin) s.baseTreatSecMin=30;
    if(!s.baseTreatSecMax) s.baseTreatSecMax=60;
    if(!s.lab) s.lab = { costCoins: 15, maxPerPatient: 2 };
    if(s.lab.costCoins==null) s.lab.costCoins = 15;
    if(s.lab.maxPerPatient==null) s.lab.maxPerPatient = 2;

    // --- shift migrate ---
if(!s.shift){
  s.shift = {
    active: true,
    durationSec: 8*60,
    endAt: Date.now() + 8*60*1000,
    cured: 0,
    deaths: 0,
    left: 0
  };
}
if(typeof s.shift.active !== "boolean") s.shift.active = true;
if(!s.shift.durationSec) s.shift.durationSec = 8*60;
if(!s.shift.endAt) s.shift.endAt = Date.now() + s.shift.durationSec*1000;
if(s.shift.cured==null) s.shift.cured = 0;
if(s.shift.deaths==null) s.shift.deaths = 0;
if(s.shift.left==null) s.shift.left = 0;

if(!s.unlocks) s.unlocks = { wardB:false, staffScreen:true };
if(typeof s.unlocks.wardB !== "boolean") s.unlocks.wardB = false;
if(typeof s.unlocks.staffScreen !== "boolean") s.unlocks.staffScreen = true;

// –µ—Å–ª–∏ —Ä–∞–Ω—å—à–µ –≤ —Å–µ–π–≤–µ —É–∂–µ –±—ã–ª–∞ –ø–∞–ª–∞—Ç–∞ B, —Å—á–∏—Ç–∞–µ–º —á—Ç–æ –∫—É–ø–ª–µ–Ω–∞
if(Array.isArray(s.wards) && s.wards.some(w => w.id === "ward_B")){
  s.unlocks.wardB = true;
}

    return s;
  }catch{
    return defaultState();
  }
}

function saveState(){
  localStorage.setItem(LS_STATE, JSON.stringify(state));
}

/* =========================================================
   3) ACTIVE MAP (treatments in progress per ward)
========================================================= */

function getActiveMap(){
  try { return JSON.parse(localStorage.getItem(LS_ACTIVE) || "{}") || {}; }
  catch { return {}; }
}
function saveActiveMap(map){
  localStorage.setItem(LS_ACTIVE, JSON.stringify(map || {}));
}
function getActiveForWard(wardId){
  const map = getActiveMap();
  return map[wardId] || null;
}
function setActiveForWard(wardId, obj){
  const map = getActiveMap();
  map[wardId] = obj;
  saveActiveMap(map);
}
function clearActiveForWard(wardId){
  const map = getActiveMap();
  delete map[wardId];
  saveActiveMap(map);
}

/* =========================================================
   4) HELPERS
========================================================= */

function randInt(a,b){ return Math.floor(a + Math.random()*(b-a+1)); }
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function formatLeft(ms){
  ms = Math.max(0, ms);
  const s = Math.floor(ms/1000);
  const m = Math.floor(s/60);
  const r = s%60;
  return `${m}:${String(r).padStart(2,"0")}`;
}

function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}

function now(){ return Date.now(); }

function pickRandomDoctorId(avoidSame=false){
  const all = DOCTOR_POOL.map(d=>d.id);
  if(!avoidSame) return pick(all);
  const base = state ? state.duty?.slot1 : null;
  const filtered = all.filter(x=>x!==base);
  return pick(filtered.length?filtered:all);
}

function getDoctorById(id){
  return DOCTOR_POOL.find(d=>d.id===id) || DOCTOR_POOL[0];
}

function getDiseaseById(id){
  return DISEASES.find(d=>d.id===id) || DISEASES[0];
}

function patientById(id){
  return state.patients.find(p=>p.id===id) || null;
}

function wardById(id){
  return state.wards.find(w=>w.id===id) || null;
}

function findWardByPatient(patientId){
  return state.wards.find(w=>w.occupiedBy===patientId) || null;
}

  

/* =========================================================
   5) PATIENT GENERATION + QUEUE
========================================================= */

function makePatient(){
  const fn = pick(FIRST_NAMES);
const isFemale = FEMALE_FIRST_NAMES.has(fn);

let ln = pick(LAST_NAMES);
if(isFemale) ln = toFemaleLastName(ln);

  // —à–∞–Ω—Å –Ω–∞ —Ä–µ–¥–∫–æ—Å—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞
  const pr = Math.random();
  const patientRarity =
    pr < 0.78 ? RARITY.COMMON :
    pr < 0.95 ? RARITY.RARE :
    RARITY.LEGENDARY;

  // –±–æ–ª–µ–∑–Ω—å —Å —É—á—ë—Ç–æ–º —Ä–µ–¥–∫–æ—Å—Ç–∏ –ø–∞—Ü–∏–µ–Ω—Ç–∞
  const diseasePool = DISEASES.filter(d=>{
    if(patientRarity===RARITY.COMMON) return d.rarity!==RARITY.LEGENDARY;
    if(patientRarity===RARITY.RARE) return true;
    return true;
  });

  // –Ω–µ–±–æ–ª—å—à–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –≤ —Ä–µ–¥–∫–∏–µ –±–æ–ª–µ–∑–Ω–∏ –¥–ª—è —Ä–µ–¥–∫–∏—Ö –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤
  let disease = pick(diseasePool);
  if(patientRarity!==RARITY.COMMON){
    const rarePool = diseasePool.filter(d=>d.rarity!==RARITY.COMMON);
    if(rarePool.length && Math.random()<0.55) disease = pick(rarePool);
  }

  const id = "p"+Math.random().toString(16).slice(2,8);
  const waitSec = state.baseWaitSec + randInt(-20, 40);
  const treatSec = randInt(state.baseTreatSecMin, state.baseTreatSecMax);

  // –≤–∏–¥–∏–º—ã–µ —Å–∏–º–ø—Ç–æ–º—ã: 1-2 —à—Ç—É–∫–∏
  const visCount = Math.random()<0.5 ? 1 : 2;
  const vis = shuffle([...disease.symptoms]).slice(0, visCount);

  return {
    id,
    name: `${fn} ${ln}`,
    gender: isFemale ? "f" : "m",
    rarity: patientRarity,

    trueDiseaseId: disease.id,
    visibleSymptoms: vis,

    // —Ç–∞–π–º–∏–Ω–≥–∏
    createdAt: now(),
    leaveAt: now() + waitSec*1000,
    treatSec,

    // —Ñ–ª–∞–≥ ‚Äú–∏–∑–≤–µ—Å—Ç–Ω–∞—è –±–æ–ª–µ–∑–Ω—å‚Äù
    knownDisease: false,

    treatmentOptions: null,
    doctorAdviceCache: null,
    labUsed: 0,
    
  };
}

function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}

function fillQueue(){
  while(state.queue.length < state.maxQueue){
    const p = makePatient();
    state.patients.push(p);
    state.queue.push(p.id);
  }
}

function processQueueTick(){
  if(!state.shift?.active) return;
  const t = now();
  let changed = false;

  // –ø–∞—Ü–∏–µ–Ω—Ç—ã –≤ –æ—á–µ—Ä–µ–¥–∏ –º–æ–≥—É—Ç —É–º–µ—Ä–µ—Ç—å / —É–π—Ç–∏
  for(let i=state.queue.length-1;i>=0;i--){
    const pid = state.queue[i];
    const p = patientById(pid);
    if(!p){ state.queue.splice(i,1); changed=true; continue; }

    if(t >= p.leaveAt){
      // 20% —à–∞–Ω—Å —É–º–µ—Ä–µ—Ç—å –≤ –æ—á–µ—Ä–µ–¥–∏, –∏–Ω–∞—á–µ —É–π—Ç–∏
      const died = Math.random() < 0.20;
      if(died){
        state.reputation -= 2;
        state.biomaterial += 1;
      }else{
        state.reputation -= 1;
      }
      state.queue.splice(i,1);
      // —É–¥–∞–ª–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é
      state.patients = state.patients.filter(x=>x.id!==pid);
      changed=true;
      
    }
  }

  if(changed){
    fillQueue();
    saveState();
  }
}

/* =========================================================
   6) WARD UPGRADES (caps + scaling cost)
========================================================= */

function wardStatValue(w, stat){
  return w[stat];
}
function wardStatCap(w, stat){
  if(stat==="comfort") return w.capComfort;
  if(stat==="cleanliness") return w.capCleanliness;
  if(stat==="ventilation") return w.capVentilation;
  if(stat==="light") return w.capLight;
  return 6;
}
function upgradeCost(w, stat){
  // —Ä–∞—Å—Ç—É—â–∞—è —Ü–µ–Ω–∞: –±–∞–∑–∞ * (—É—Ä–æ–≤–µ–Ω—å —Å—Ç–∞—Ç–∞+1) * (—É—Ä–æ–≤–µ–Ω—å –ø–∞–ª–∞—Ç—ã)
  const v = wardStatValue(w, stat);
  const base = 20;
  return base * (v+1) * w.level;
}
function canUpgrade(w, stat){
  return wardStatValue(w, stat) < wardStatCap(w, stat);
}

  function buyWardB(){
  if(state.unlocks?.wardB) return;

  const cost = 200;
  if(state.coins < cost) return;

  state.coins -= cost;
  state.unlocks.wardB = true;

  // –¥–æ–±–∞–≤–∏—Ç—å –ø–∞–ª–∞—Ç—É B
  if(!state.wards.some(w => w.id==="ward_B")){
    state.wards.push(makeWard("B"));
  }

  saveState();
  refreshVisibleUI();
}

function upgradeWardStat(wardId, stat){
  const w = wardById(wardId);
  if(!w) return;

  if(!canUpgrade(w, stat)) return;

  const cost = upgradeCost(w, stat);
  if(state.coins < cost) return;

  state.coins -= cost;
  w[stat] += 1;

  // –ø–∞–ª–∞—Ç–∞ —Ä–∞—Å—Ç—ë—Ç –ø–æ —Å—É–º–º–µ —Å—Ç–∞—Ç–æ–≤
  const sum = w.comfort + w.cleanliness + w.ventilation + w.light;
  w.level = 1 + Math.floor(sum/8);

  saveState();
  refreshVisibleUI();
}

/* =========================================================
   7) DOCTORS: advice + skill penalties
========================================================= */

function dutyDoctors(){
  const d1 = getDoctorById(state.duty.slot1);
  const d2 = state.duty.slot2 ? getDoctorById(state.duty.slot2) : null;
  return [d1, d2];
}

function doctorConfidence(persona){
  if(persona==="fanatic") return 0.90;
  if(persona==="confident") return 0.75;
  if(persona==="trickster") return 0.65;
  if(persona==="cold") return 0.60;
  return 0.45; // uncertain
}

function doctorAdviceText(doc, options){
  if(!doc) return `‚Äî <b>–ü—É—Å—Ç–æ–π —Å–ª–æ—Ç</b>: ‚Äú–ù–∞–∑–Ω–∞—á—å –≤—Ä–∞—á–∞, –∏–Ω–∞—á–µ –ª–µ—á–∏ –Ω–∞ –æ—â—É–ø—å.‚Äù`;
  // doc —Å–æ–≤–µ—Ç—É–µ—Ç –º–µ—Ç–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –æ–Ω –∑–Ω–∞–µ—Ç, –µ—Å–ª–∏ –æ–Ω –≤ options
  const knows = options.filter(o=>doc.methods.includes(o));
  const conf = doctorConfidence(doc.persona);

  if(knows.length && Math.random() < conf){
    const m = pick(knows);
    return `‚Äî <b>${escapeHtml(doc.name)}</b>: ‚Äú–Ø –±—ã –≤–∑—è–ª <b>${escapeHtml(methodName(m))}</b>.‚Äù`;
  }

  // –∏–Ω–æ–≥–¥–∞ –∫—Ä–∏—Ç–∏–∫—É–µ—Ç –º–µ—Ç–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –ª—é–±–∏—Ç (–ø—Ä–æ—Å—Ç–æ –≤—ã–±–∏—Ä–∞–µ–º —Ä–∞–Ω–¥–æ–º–Ω—ã–π –Ω–µ-–µ–≥–æ)
  if(Math.random() < 0.35){
    const m = pick(options);
    if(!doc.methods.includes(m)){
      return `‚Äî <b>${escapeHtml(doc.name)}</b>: ‚Äú–¢–æ–ª—å–∫–æ –Ω–µ <b>${escapeHtml(methodName(m))}</b>‚Ä¶ —ç—Ç–æ –ø–∞—Ö–Ω–µ—Ç –ø—Ä–æ–≤–∞–ª–æ–º.‚Äù`;
    }
  }

  return `‚Äî <b>${escapeHtml(doc.name)}</b>: ‚Äú–°–∏—Ç—É–∞—Ü–∏—è‚Ä¶ –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω–∞—è. –†–µ—à–∞–π —Å–∞–º.‚Äù`;
}

function doctorSkillPenalty(selectedMethod){
  // –µ—Å–ª–∏ –Ω–∏ –æ–¥–∏–Ω –¥–µ–∂—É—Ä–Ω—ã–π –Ω–µ —É–º–µ–µ—Ç –º–µ—Ç–æ–¥ ‚Äî —à—Ç—Ä–∞—Ñ
  const docs = dutyDoctors().filter(Boolean); // <-- –≤–∞–∂–Ω–æ
  const any = docs.some(d => d.methods.includes(selectedMethod));
  return any ? 1.0 : 0.78;
}

/* =========================================================
   8) TREATMENT OPTIONS (4 buttons: best, worst, 2 random)
========================================================= */

function scoreMethodForDisease(methodId, disease){
  return disease.weights?.[methodId] ?? 0.5;
}

function pickTreatmentOptions(patient){
  const d = getDiseaseById(patient.trueDiseaseId);

  const scored = METHODS.map(m=>{
    return { id:m.id, score:scoreMethodForDisease(m.id,d) };
  }).sort((a,b)=>b.score-a.score);

  const best = scored[0].id;
  const worst = scored[scored.length-1].id;

  const middle = scored.slice(1, scored.length-1).map(x=>x.id);
  shuffle(middle);

  const opt = [best, worst, middle[0] || best, middle[1] || worst];
  // –ø–µ—Ä–µ–º–µ—à–∞–µ–º, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ø–∞–ª–µ–≤–Ω–æ
  shuffle(opt);
  return opt;
}

/* =========================================================
   9) OUTCOMES (black comedy)
========================================================= */

function makeFlavor(kind, treatmentId){
  const t = methodName(treatmentId);

  const pool = {
    [OUTCOMES.CURE]: [
      "–ü–∞—Ü–∏–µ–Ω—Ç –≤—ã–∂–∏–ª –∏ –¥–∞–∂–µ —É–ª—ã–±–∞–µ—Ç—Å—è. –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ.",
      "–°–∏–º–ø—Ç–æ–º—ã —É—à–ª–∏. –ß—É–≤—Å—Ç–≤–æ –≤–∏–Ω—ã –æ—Å—Ç–∞–ª–æ—Å—å.",
      `–ö–∞–∫ –Ω–∏ —Å—Ç—Ä–∞–Ω–Ω–æ, ${t} –ø–æ–º–æ–≥–ª–æ.`
    ],
    [OUTCOMES.DISFIGURED]: [
      `–£—Å–ø–µ—à–Ω–æ‚Ä¶ –Ω–æ —Ç–µ–ø–µ—Ä—å –±–µ–∑ –ø–∞—Ä—ã –¥–µ—Ç–∞–ª–µ–π. –ú–µ—Ç–æ–¥: ${t}.`,
      "–ü—Ä–æ–±–ª–µ–º—É —Ä–µ—à–∏–ª–∏. –≠—Å—Ç–µ—Ç–∏–∫—É –Ω–µ –æ–±–µ—â–∞–ª–∏.",
      "–û—Å–Ω–æ–≤–Ω—É—é –±–µ–¥—É —É–±—Ä–∞–ª–∏. –ü–æ–±–æ—á–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –æ—Å—Ç–∞–≤–∏–ª–∏."
    ],
    [OUTCOMES.INFECTED]: [
      "–û—Å–Ω–æ–≤–Ω–∞—è –±–æ–ª–µ–∑–Ω—å —É—à–ª–∞. –ó–∞—Ç–æ –ø–æ—è–≤–∏–ª–∞—Å—å –Ω–æ–≤–∞—è. –ë–µ—Å–ø–ª–∞—Ç–Ω–æ.",
      "–í–æ –≤—Ä–µ–º—è –ø—Ä–æ—Ü–µ–¥—É—Ä –∑–∞–Ω–µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –æ—á–µ–Ω—å –∂–∏–≤–æ–µ.",
      `–ü–æ—Å–ª–µ ${t} –ø–∞—Ü–∏–µ–Ω—Ç —á—É–≤—Å—Ç–≤—É–µ—Ç‚Ä¶ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ.`
    ],
    [OUTCOMES.WORSENED]: [
      "–°—Ç–∞–ª–æ —Ö—É–∂–µ. –ü–∞—Ü–∏–µ–Ω—Ç —Å–º–æ—Ç—Ä–∏—Ç –∫–∞–∫ –∫—Ä–µ–¥–∏—Ç–æ—Ä.",
      "–ù—É–∂–Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞. –ò –º–æ–ª–∏—Ç–≤–∞. –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ —Ç–≤–æ—è.",
      "–õ–µ—á–µ–Ω–∏–µ –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ. –î–ª—è –±–æ–ª–µ–∑–Ω–∏."
    ],
    [OUTCOMES.DEATH]: [
      "–ü–∞—Ü–∏–µ–Ω—Ç —É–º–µ—Ä. –ë—É–º–∞–≥–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω—ã –∏–¥–µ–∞–ª—å–Ω–æ.",
      "–°–º–µ—Ä—Ç—å –Ω–∞—Å—Ç—É–ø–∏–ª–∞ –≤–Ω–µ–∑–∞–ø–Ω–æ. –î–ª—è –ø–∞—Ü–∏–µ–Ω—Ç–∞.",
      "–ó–∞—Ç–æ —Ç–µ–ø–µ—Ä—å –æ–Ω —Ç–æ—á–Ω–æ –Ω–µ –∂–∞–ª—É–µ—Ç—Å—è."
    ]
  };

  const arr = pool[kind] || ["–ò—Å—Ö–æ–¥ –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω. –ö–∞–∫ –∏ —Ç–≤–æ—è —Å—É–¥—å–±–∞ –≤—Ä–∞—á–∞."];
  return pick(arr);
}

function rollOutcome(patientId, treatmentId, wardId){
  const p = patientById(patientId);
  const w = wardById(wardId);
  const disease = getDiseaseById(p.trueDiseaseId);

  // –±–∞–∑–æ–≤—ã–π ‚Äú–∫–∞—á–µ—Å—Ç–≤–æ –≤—ã–±–æ—Ä–∞‚Äù –æ—Ç –º–µ—Ç–æ–¥–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –±–æ–ª–µ–∑–Ω–∏
  const methodScore = scoreMethodForDisease(treatmentId, disease); // 0.2..1.3
  // –ø–∞–ª–∞—Ç–∞ –Ω–µ–º–Ω–æ–≥–æ –±—É—Å—Ç–∏—Ç —É—Å–ø–µ—Ö (–ø–æ —Å—É–º–º–µ —Å—Ç–∞—Ç–æ–≤)
  const wardPower = (w.comfort + w.cleanliness + w.ventilation + w.light) / 24; // ~0.16..?
  // —à—Ç—Ä–∞—Ñ –µ—Å–ª–∏ –¥–µ–∂—É—Ä–Ω—ã–µ –Ω–µ —É–º–µ—é—Ç –º–µ—Ç–æ–¥
  const docMul = doctorSkillPenalty(treatmentId);

  // –∏—Ç–æ–≥–æ–≤–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ö–æ—Ä–æ—à–∏—Ö –∏—Å—Ö–æ–¥–æ–≤
  // clamp –≤ —Ä–∞–∑—É–º–Ω—ã–µ —Ä–∞–º–∫–∏
  let goodFactor = (0.55 * methodScore) + (0.20 * wardPower);
  goodFactor = Math.max(0.15, Math.min(0.95, goodFactor));
  goodFactor *= docMul;

  const r = Math.random();

  // —Ä–∞—Å–∫–ª–∞–¥—ã–≤–∞–µ–º –∏—Å—Ö–æ–¥—ã:
  // –±–æ–ª—å—à–µ goodFactor -> –±–æ–ª—å—à–µ —à–∞–Ω—Å–æ–≤ cure/disfigured/infected
  // –º–µ–Ω—å—à–µ -> worsened/death
  let kind;

  // –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Å–º–µ—Ä—Ç–∏ —Ä–∞—Å—Ç—ë—Ç –ø—Ä–∏ –ø–ª–æ—Ö–∏—Ö —É—Å–ª–æ–≤–∏—è—Ö
  const deathChance = Math.max(0.04, 0.18 - goodFactor*0.12); // –ø—Ä–∏–º–µ—Ä–Ω–æ 4%..18%
  const worsenChance = Math.max(0.10, 0.38 - goodFactor*0.25);

  // —á–∞—Å—Ç—å ‚Äú—É—Å–ø–µ—Ö–æ–≤‚Äù –Ω–∞–º–µ—Ä–µ–Ω–Ω–æ —Å–æ–º–Ω–∏—Ç–µ–ª—å–Ω–∞—è (—á—ë—Ä–Ω–∞—è –∫–æ–º–µ–¥–∏—è)
  const cureChance = Math.max(0.18, goodFactor*0.45);
  const disfigChance = Math.max(0.12, goodFactor*0.30);
  const infectChance = Math.max(0.10, goodFactor*0.22);

  // –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Å—É–º–º—ã
  const sum = deathChance + worsenChance + cureChance + disfigChance + infectChance;
  const a = deathChance/sum;
  const b = worsenChance/sum;
  const c = cureChance/sum;
  const d = disfigChance/sum;
  const e = infectChance/sum;

  const x = r;
  if(x < a) kind = OUTCOMES.DEATH;
  else if(x < a+b) kind = OUTCOMES.WORSENED;
  else if(x < a+b+c) kind = OUTCOMES.CURE;
  else if(x < a+b+c+d) kind = OUTCOMES.DISFIGURED;
  else kind = OUTCOMES.INFECTED;

  // –Ω–∞–≥—Ä–∞–¥—ã/—à—Ç—Ä–∞—Ñ—ã: –¥–µ–Ω—å–≥–∏ –∑–∞–≤–∏—Å—è—Ç –∏ –æ—Ç —Ä–µ–ø—É—Ç–∞—Ü–∏–∏ (—á–µ–º –≤—ã—à–µ ‚Äî —Ç–µ–º –¥–æ—Ä–æ–∂–µ —É—Å–ª—É–≥–∏)
  const repMul = 1 + Math.max(-10, Math.min(50, state.reputation)) * 0.01;

  let coinsDelta=0, repDelta=0, bioDelta=0;

  switch(kind){
    case OUTCOMES.CURE:
      coinsDelta = Math.round(10 * repMul);
      repDelta = +2;
      break;
    case OUTCOMES.DISFIGURED:
      coinsDelta = Math.round(16 * repMul);
      repDelta = -2;
      break;
    case OUTCOMES.INFECTED:
      coinsDelta = Math.round(20 * repMul);
      repDelta = -4;
      break;
    case OUTCOMES.WORSENED:
      coinsDelta = Math.round(2 * repMul);
      repDelta = -5;
      break;
    case OUTCOMES.DEATH:
      coinsDelta = Math.round(4 * repMul);
      repDelta = -8;
      bioDelta = 1;
      break;
  }

  // XP —Ç–∏–ø: –¥–ª—è –∫–ª–∏–Ω–∏–∫–∏/–≤—Ä–∞—á–µ–π (–ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–∞—è —Å—Ö–µ–º–∞)
  const xpKind =
    kind === OUTCOMES.WORSENED ? "complication" :
    kind === OUTCOMES.DEATH ? "death" :
    "success";

  return {
    kind,
    xpKind,
    coinsDelta,
    reputationDelta: repDelta,
    biomaterialDelta: bioDelta,
    flavor: makeFlavor(kind, treatmentId),

    treatmentId,
    patientId,
    wardId,
    at: now()
  };
}

/* =========================================================
   10) XP / LEVEL
========================================================= */

function xpNeedForLevel(lv){
  return 50 + (lv-1)*40;
}
function gainClinicXP(xpKind){
  let add = 0;
  if(xpKind==="success") add=8;
  else if(xpKind==="complication") add=4;
  else add=2;

  state.clinicXP += add;
  while(state.clinicXP >= xpNeedForLevel(state.clinicLevel)){
    state.clinicXP -= xpNeedForLevel(state.clinicLevel);
    state.clinicLevel += 1;
    // —Ä–æ—Å—Ç –æ—á–µ—Ä–µ–¥–∏ –∏ –ø–æ—Ç–æ–ª–∫–æ–≤ –∫–∞–∫ –Ω–∞–≥—Ä–∞–¥–∞
    if(state.clinicLevel % 3 === 0) state.maxQueue = Math.min(10, state.maxQueue+1);
  }
}

function gainDoctorXP(xpKind){
  // –ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞ –ø–æ–¥ –±—É–¥—É—â—É—é –ø—Ä–æ–∫–∞—á–∫—É –≤—Ä–∞—á–µ–π
}

function endShift(){
  state.shift.active = false;
  saveState();
  renderShiftEnd();
  showScreen("shiftend");
}

function renderShiftEnd(){
  const el = document.getElementById("shift-summary");
  const s = state.shift;
  el.innerHTML = `
    ‚úÖ –í—ã–ª–µ—á–µ–Ω–æ: <b>${s.cured}</b><br>
    ‚ò†Ô∏è –°–º–µ—Ä—Ç–µ–π: <b>${s.deaths}</b><br>
    üö™ –£—à–ª–∏/—É–º–µ—Ä–ª–∏ –≤ –æ—á–µ—Ä–µ–¥–∏: <b>${s.left}</b><br>
    <div class="hint">–ù–∞–≥—Ä–∞–¥—ã –¥–æ–±–∞–≤–∏–º –ø–æ—Å–ª–µ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏/–∏–≤–µ–Ω—Ç–æ–≤.</div>
  `;
}

function startNewShift(){
  state.shift.active = true;
  state.shift.durationSec = state.shift.durationSec || 8*60;
  state.shift.endAt = now() + state.shift.durationSec*1000;
  state.shift.cured = 0;
  state.shift.deaths = 0;
  state.shift.left = 0;

  state.patients = [];
  state.queue = [];
  state.selectedPatientId = null;

  // —á–∏—Å—Ç–∏–º –∞–∫—Ç–∏–≤–Ω—ã–µ –ª–µ—á–µ–Ω–∏—è
  localStorage.removeItem(LS_ACTIVE);

  for(const w of state.wards){
    w.occupiedBy = null;
    w.pendingResult = null;
  }

  fillQueue();
  saveState();
  showScreen("clinic");
  refreshVisibleUI();
}
  
/* =========================================================
   11) FLOW: assign / complete / pending / discharge
========================================================= */

state = loadState();

function reconcileState(){
  // –µ—Å–ª–∏ –≤ –ø–∞–ª–∞—Ç–µ –ª–µ–∂–∏—Ç id –ø–∞—Ü–∏–µ–Ω—Ç–∞, –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ—Ç –≤ patients ‚Äî —á–∏—Å—Ç–∏–º –ø–∞–ª–∞—Ç—É
  for(const w of state.wards){
    if(w.occupiedBy && !patientById(w.occupiedBy)){
      w.occupiedBy = null;
    }
    if(w.pendingResult && !patientById(w.pendingResult.patientId)){
      w.pendingResult = null;
    }
  }

  // –µ—Å–ª–∏ –ª–µ—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–µ, –Ω–æ –ø–∞—Ü–∏–µ–Ω—Ç/–ø–∞–ª–∞—Ç–∞ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç ‚Äî —Å–Ω–æ—Å–∏–º –∞–∫—Ç–∏–≤–∫—É
  const map = getActiveMap();
  for(const wardId of Object.keys(map)){
    const a = map[wardId];
    if(!a) continue;
    const w = wardById(wardId);
    if(!w || !patientById(a.patientId)){
      clearActiveForWard(wardId);
      continue;
    }
  }

  saveState();
}

state = loadState();
reconcileState();  

function assignPatientToWard(patientId, wardId){
  const w = wardById(wardId);
  const p = patientById(patientId);
  if(!w || !p) return false;

  // –ø–∞–ª–∞—Ç–∞ –∑–∞–Ω—è—Ç–∞
  if(w.occupiedBy) return false;

  // —É –ø–∞–ª–∞—Ç—ã –µ—Å—Ç—å –Ω–µ–∑–∞–±—Ä–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
  if(w.pendingResult) return false;

  // —É–±—Ä–∞—Ç—å –∏–∑ –æ—á–µ—Ä–µ–¥–∏
  const qi = state.queue.indexOf(patientId);
  if(qi>=0) state.queue.splice(qi,1);

  w.occupiedBy = patientId;

  // –ª–µ—á–µ–Ω–∏–µ –±—É–¥–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–æ –ø–æ–∑–∂–µ (–Ω–∞ —ç–∫—Ä–∞–Ω–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞)
  saveState();
  fillQueue();
  saveState();
  return true;
}

function chooseTreatment(treatmentId){
  if(!state.shift?.active) return; // —Å–º–µ–Ω–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å
  if(!state.selectedPatientId) return;
  const ward = findWardByPatient(state.selectedPatientId);
  if(!ward) return;

  const active = getActiveForWard(ward.id);
  if(active) return; // —É–∂–µ –ª–µ—á–∏—Ç—Å—è

  const p = patientById(state.selectedPatientId);
  if(!p) return;

  const endAt = now() + p.treatSec*1000;

  setActiveForWard(ward.id, {
    patientId: p.id,
    treatmentId,
    endAt
  });

  refreshVisibleUI();
}

function finishTreatmentToPending(active, outcome){
  const w = wardById(active.wardId);
  if(!w) return;

  w.pendingResult = {
    patientId: active.patientId,
    wardId: active.wardId,
    treatmentId: active.treatmentId,

    kind: outcome.kind,
    xpKind: outcome.xpKind,
    flavor: outcome.flavor,

    coins: outcome.coinsDelta ?? 0,
    reputation: outcome.reputationDelta ?? 0,
    biomaterial: outcome.biomaterialDelta ?? 0,

    time: now()
  };

  // –Ω–∞—á–∏—Å–ª—è–µ–º —Å—Ä–∞–∑—É (—á—Ç–æ–±—ã –∏–≥—Ä–æ–∫ –≤–∏–¥–µ–ª –ø—Ä–æ–≥—Ä–µ—Å—Å)
  state.coins = Math.max(0, state.coins + (outcome.coinsDelta ?? 0));
  state.reputation = (state.reputation || 0) + (outcome.reputationDelta ?? 0);
  state.biomaterial = (state.biomaterial || 0) + (outcome.biomaterialDelta ?? 0);

  if(state.shift?.active){
  if(outcome.kind === OUTCOMES.DEATH) state.shift.deaths += 1;
  else if(outcome.kind === OUTCOMES.CURE || outcome.kind === OUTCOMES.DISFIGURED || outcome.kind === OUTCOMES.INFECTED) state.shift.cured += 1;
}

  gainClinicXP(outcome.xpKind);
  gainDoctorXP(outcome.xpKind);

  saveState();
}

function completeTreatment(wardId){
  const active = getActiveForWard(wardId);
  if(!active) return;

  const outcome = rollOutcome(active.patientId, active.treatmentId, wardId);
  finishTreatmentToPending({ ...active, wardId }, outcome);

  clearActiveForWard(wardId);
  saveState();
  refreshVisibleUI();
}

function dischargePatient(patientId, wardId){
  const w = wardById(wardId);
  if(!w) return;

  // –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –ø–∞–ª–∞—Ç—É –∏ —É–±—Ä–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
  w.occupiedBy = null;
  w.pendingResult = null;

  // —É–¥–∞–ª–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞
  state.patients = state.patients.filter(p=>p.id!==patientId);

  fillQueue();
  saveState();
  backToClinic();
}

function openPatientById(patientId){
  state.selectedPatientId = patientId;
  saveState();
  showScreen("patient");
  renderPatient(patientId);
}

function backToClinic(){
  showScreen("clinic");
  refreshVisibleUI();
}

function showScreen(name){
  document.getElementById("screen-clinic").classList.toggle("active", name==="clinic");
  document.getElementById("screen-patient").classList.toggle("active", name==="patient");
  document.getElementById("screen-shiftend").classList.toggle("active", name==="shiftend");
  document.getElementById("screen-staff").classList.toggle("active", name==="staff");
}

const elStaffList = document.getElementById("staff-list");

function openStaff(){
  showScreen("staff");
  renderStaff();
}

function renderStaff(){
  renderTop();
  elStaffList.innerHTML = "";

  const slot2Unlocked = state.unlocks?.wardB; // –ø—Ä–æ—Å—Ç–æ–π –ª–æ–≥–∏–∫–æ–π: –∫—É–ø–∏–ª B -> –ø–æ—è–≤–∏–ª—Å—è —Å–ª–æ—Ç 2

  for(const doc of DOCTOR_POOL){
    const isSlot1 = state.duty.slot1 === doc.id;
    const isSlot2 = state.duty.slot2 === doc.id;

    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <div class="row">
        <div>
          <div class="listTitle">${escapeHtml(doc.name)} ${isSlot1 ? '<span class="tag ok">slot1</span>' : ''} ${isSlot2 ? '<span class="tag ok">slot2</span>' : ''}</div>
          <div class="listSub">${rarityLabel(doc.rarity)} ‚Ä¢ ${doc.methods.map(m=>escapeHtml(methodName(m))).join(", ")}</div>
        </div>
      </div>

      <div class="grid2" style="margin-top:10px">
        <button class="btn small" onclick="assignDoctorToSlot('${doc.id}',1)" ${isSlot1?'disabled':''}>
          –í —Å–ª–æ—Ç 1
        </button>
        <button class="btn small" onclick="assignDoctorToSlot('${doc.id}',2)" ${(!slot2Unlocked || isSlot2)?'disabled':''}>
          –í —Å–ª–æ—Ç 2
        </button>
      </div>
    `;
    elStaffList.appendChild(div);
  }
}

function assignDoctorToSlot(docId, slot){
  if(slot === 1){
    state.duty.slot1 = docId;
    if(state.duty.slot2 === docId) state.duty.slot2 = null;
  } else {
    if(!state.unlocks?.wardB) return; // —Å–ª–æ—Ç 2 –∑–∞–∫—Ä—ã—Ç
    state.duty.slot2 = docId;
    if(state.duty.slot1 === docId) state.duty.slot1 = pickRandomDoctorId();
  }

  // —Å–±—Ä–æ—Å–∏—Ç—å —Å–æ–≤–µ—Ç—ã –ø–∞—Ü–∏–µ–Ω—Ç–∞–º (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ ‚Äú—Å—Ç–∞—Ä—ã—Ö —Å–æ–≤–µ—Ç–æ–≤‚Äù)
  for(const p of state.patients) p.doctorAdviceCache = null;

  saveState();
  renderStaff();
  refreshVisibleUI();
}
  
/* =========================================================
   12) UI RENDER
========================================================= */

const elCoins = document.getElementById("coins");
const elRep = document.getElementById("rep");
const elBio = document.getElementById("bio");
const elClinicLevel = document.getElementById("clinic-level");
const elShiftTimer = document.getElementById("shift-timer");

const elWards = document.getElementById("wards");
const elQueue = document.getElementById("queue");
const elDuty = document.getElementById("duty");

const elPatientTitle = document.getElementById("patient-title");
const elPatientSub = document.getElementById("patient-sub");
const elPatientDisease = document.getElementById("patient-disease");
const elAdvice = document.getElementById("doctor-advice");

const elTreatPanel = document.getElementById("treat-panel");
const elTreatmentButtons = document.getElementById("treatment-buttons");

const elActiveTreatment = document.getElementById("active-treatment");
const elActiveName = document.getElementById("active-treatment-name");
const elActiveTimer = document.getElementById("active-treatment-timer");

const elResultPanel = document.getElementById("result-panel");
const elResultText = document.getElementById("result-text");

const elLabBtn = document.getElementById("btn-lab");
const elLabSub = document.getElementById("lab-sub");
const elLabHint = document.getElementById("lab-hint");

function renderTop(){
  elCoins.textContent = state.coins;
  elRep.textContent = state.reputation;
  elBio.textContent = state.biomaterial;
  elClinicLevel.textContent = state.clinicLevel;
  const left = (state.shift?.endAt ?? now()) - now();
elShiftTimer.textContent = state.shift?.active ? formatLeft(left) : "END";
  
}

function renderClinic(){
  renderTop();

  // wards
  elWards.innerHTML = "";
  for(const w of state.wards){
    const active = getActiveForWard(w.id);

    let badge = "";
    if(w.pendingResult){
      const k = w.pendingResult.kind;
      badge = k===OUTCOMES.CURE ? `<span class="tag ok">‚úÖ –í—ã–ª–µ—á–µ–Ω</span>` :
              k===OUTCOMES.DISFIGURED ? `<span class="tag warn">‚úÖ –ü–æ–∫–∞–ª–µ—á–µ–Ω</span>` :
              k===OUTCOMES.INFECTED ? `<span class="tag warn">‚úÖ –ò–Ω—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω</span>` :
              k===OUTCOMES.WORSENED ? `<span class="tag warn">‚ö†Ô∏è –•—É–∂–µ</span>` :
              `<span class="tag bad">‚ò†Ô∏è –°–º–µ—Ä—Ç—å</span>`;
    } else if(w.occupiedBy && active){
      const left = active.endAt - now();
      badge = `<span class="tag">‚è≥ ${formatLeft(left)}</span>`;
    } else if(w.occupiedBy){
      badge = `<span class="tag warn">–∂–¥—ë—Ç –ª–µ—á–µ–Ω–∏—è</span>`;
    } else {
      badge = `<span class="tag">—Å–≤–æ–±–æ–¥–Ω–æ</span>`;
    }

    const p = w.occupiedBy ? patientById(w.occupiedBy) : null;
    const occ = p ? `–ó–∞–Ω—è—Ç–æ: <b>${escapeHtml(p.name)}</b>` : `–°–≤–æ–±–æ–¥–Ω–æ`;

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="row">
        <div>
          <div class="listTitle">${escapeHtml(w.name)} ‚Ä¢ –£—Ä. ${w.level}</div>
          <div class="listSub">${occ}</div>
        </div>
        <div class="right">${badge}</div>
      </div>

      <div class="hint">
        –ö–æ–º—Ñ–æ—Ä—Ç: ${w.comfort} ‚Ä¢ –ß–∏—Å—Ç–æ—Ç–∞: ${w.cleanliness} ‚Ä¢ –í–µ–Ω—Ç: ${w.ventilation} ‚Ä¢ –°–≤–µ—Ç: ${w.light}
      </div>

      <div class="grid2" style="margin-top:10px">
        <button class="btn small" onclick="upgradeWardStat('${w.id}','comfort')" ${canUpgrade(w,'comfort')?'':'disabled'}>
          –ö–æ–º—Ñ–æ—Ä—Ç +1 (${upgradeCost(w,'comfort')})
        </button>
        <button class="btn small" onclick="upgradeWardStat('${w.id}','cleanliness')" ${canUpgrade(w,'cleanliness')?'':'disabled'}>
          –ß–∏—Å—Ç–æ—Ç–∞ +1 (${upgradeCost(w,'cleanliness')})
        </button>
        <button class="btn small" onclick="upgradeWardStat('${w.id}','ventilation')" ${canUpgrade(w,'ventilation')?'':'disabled'}>
          –í–µ–Ω—Ç +1 (${upgradeCost(w,'ventilation')})
        </button>
        <button class="btn small" onclick="upgradeWardStat('${w.id}','light')" ${canUpgrade(w,'light')?'':'disabled'}>
          –°–≤–µ—Ç +1 (${upgradeCost(w,'light')})
        </button>
      </div>

      ${w.pendingResult ? `
        <div class="sep"></div>
        <button class="btn ok" onclick="openPatientById('${w.pendingResult.patientId}')">
          üëÅ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          <div class="muted">${escapeHtml(w.pendingResult.flavor || "")}</div>
        </button>
      ` : (w.occupiedBy ? `
        <div class="sep"></div>
        <button class="btn" onclick="openPatientById('${w.occupiedBy}')">
          üßæ –û—Ç–∫—Ä—ã—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞
          <div class="muted">–ù–∞–∑–Ω–∞—á–∏—Ç—å –ª–µ—á–µ–Ω–∏–µ –∏–ª–∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–∞–π–º–µ—Ä</div>
        </button>
      ` : ``)}
    `;
    elWards.appendChild(card);
  }

  // duty doctors
  elDuty.innerHTML = "";
  const [d1, d2] = dutyDoctors();

// —Å–ª–æ—Ç 1
renderDutySlot(1, d1);

// —Å–ª–æ—Ç 2
if(state.unlocks?.wardB){
  renderDutySlot(2, d2);
} else {
  const div = document.createElement("div");
  div.className = "card";
  div.innerHTML = `
    <div class="row">
      <div>
        <div class="listTitle">–°–ª–æ—Ç 2: üîí –ó–∞–∫—Ä—ã—Ç</div>
        <div class="listSub">–û—Ç–∫—Ä–æ–π –ü–∞–ª–∞—Ç—É B, —á—Ç–æ–±—ã –Ω–∞–∑–Ω–∞—á–∞—Ç—å –≤—Ç–æ—Ä–æ–≥–æ –≤—Ä–∞—á–∞.</div>
      </div>
      <button class="btn small" onclick="buyWardB()">–ö—É–ø–∏—Ç—å –ø–∞–ª–∞—Ç—É</button>
    </div>
  `;
  elDuty.appendChild(div);
}

function renderDutySlot(idx, d){
  const div = document.createElement("div");
  div.className = "card";
  if(!d){
    div.innerHTML = `
      <div class="row">
        <div>
          <div class="listTitle">–°–ª–æ—Ç ${idx}: –ø—É—Å—Ç–æ</div>
          <div class="listSub">–ù–∞–∑–Ω–∞—á—å –≤—Ä–∞—á–∞ –≤ ‚Äú–®—Ç–∞—Ç–µ‚Äù.</div>
        </div>
        <button class="btn small" onclick="openStaff()">–ù–∞–∑–Ω–∞—á–∏—Ç—å</button>
      </div>
    `;
  } else {
    div.innerHTML = `
      <div class="row">
        <div>
          <div class="listTitle">–°–ª–æ—Ç ${idx}: ${escapeHtml(d.name)}</div>
          <div class="listSub">${rarityLabel(d.rarity)} ‚Ä¢ –º–µ—Ç–æ–¥—ã: ${d.methods.map(m=>escapeHtml(methodName(m))).join(", ")}</div>
        </div>
        <button class="btn small" onclick="openStaff()">–°–º–µ–Ω–∏—Ç—å</button>
      </div>
    `;
  }
  elDuty.appendChild(div);
}

  // queue
  elQueue.innerHTML = "";
  if(state.queue.length===0){
    elQueue.innerHTML = `<div class="hint">–û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞. –≠—Ç–æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ.</div>`;
  } else {
    for(const pid of state.queue){
      const p = patientById(pid);
      if(!p) continue;
      const left = p.leaveAt - now();

      const rarityTag =
        p.rarity===RARITY.LEGENDARY ? `<span class="tag">‚ú® legendary</span>` :
        p.rarity===RARITY.RARE ? `<span class="tag">‚≠ê rare</span>` :
        `<span class="tag">common</span>`;

      const div = document.createElement("div");
      div.className = "listBtn";
      div.onclick = ()=> tryPlaceOrOpen(pid);

      div.innerHTML = `
        <div class="row">
          <div>
            <div class="listTitle">${escapeHtml(p.name)} ${rarityTag}</div>
            <div class="listSub">${escapeHtml(p.visibleSymptoms.join(", "))}</div>
          </div>
          <div class="right">
            <div class="timer ${left<15000?'bad':left<40000?'warn':'ok'}">${formatLeft(left)}</div>
            <div class="muted" style="font-size:12px">–¥–æ —É—Ö–æ–¥–∞/—Å–º–µ—Ä—Ç–∏</div>
          </div>
        </div>
      `;
      elQueue.appendChild(div);
    }
  }

  // –∫–Ω–æ–ø–∫–∞ –ø–æ–∫—É–ø–∫–∏ –≤—Ç–æ—Ä–æ–π –ø–∞–ª–∞—Ç—ã
if(!state.unlocks?.wardB){
  const cost = 200;
  const disabled = state.coins < cost ? "disabled" : "";
  const div = document.createElement("div");
  div.className = "card";
  div.innerHTML = `
    <div class="row">
      <div>
        <div class="listTitle">üîí –ü–∞–ª–∞—Ç–∞ B</div>
        <div class="listSub">–û—Ç–∫—Ä–æ–π –≤—Ç–æ—Ä—É—é –ø–∞–ª–∞—Ç—É, —á—Ç–æ–±—ã –ª–µ—á–∏—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ.</div>
      </div>
      <div class="right">
        <button class="btn small ok" onclick="buyWardB()" ${disabled}>
          –ö—É–ø–∏—Ç—å (${cost})
        </button>
      </div>
    </div>
  `;
  elWards.appendChild(div);
}
  
}

function rerollDuty(slot){
  if(slot==="slot1"){
    state.duty.slot1 = pickRandomDoctorId();
    if(state.duty.slot2===state.duty.slot1) state.duty.slot2 = pickRandomDoctorId(true);
  } else {
    state.duty.slot2 = pickRandomDoctorId(true);
  }
  for (const p of state.patients){
  p.doctorAdviceCache = null;
}
saveState();
refreshVisibleUI();
}

function tryPlaceOrOpen(patientId){
  if(!state.shift?.active) { openPatientById(patientId); return; }
  // –µ—Å–ª–∏ –ø–∞—Ü–∏–µ–Ω—Ç —É–∂–µ –≤ –ø–∞–ª–∞—Ç–µ/–æ–∂–∏–¥–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ ‚Äî –æ—Ç–∫—Ä—ã—Ç—å
  const ward = findWardByPatient(patientId);
  if(ward){
    openPatientById(patientId);
    return;
  }

  // –∏–Ω–∞—á–µ –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª–æ–∂–∏—Ç—å –≤ –ø–µ—Ä–≤—É—é —Å–≤–æ–±–æ–¥–Ω—É—é –ø–∞–ª–∞—Ç—É
  const free = state.wards.find(w=>!w.occupiedBy && !w.pendingResult);
  if(!free){
    // –Ω–µ—Ç –º–µ—Å—Ç–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É
    openPatientById(patientId);
    return;
  }

  const ok = assignPatientToWard(patientId, free.id);
  if(ok){
    openPatientById(patientId);
  } else {
    openPatientById(patientId);
  }
}

function renderPatient(patientId){
  renderTop();

  const p = patientById(patientId);
  if(!p){
    backToClinic();
    return;
  }

  elPatientTitle.textContent = p.name;
  elPatientSub.textContent = p.visibleSymptoms.join(", ");

  const disease = getDiseaseById(p.trueDiseaseId);
  elPatientDisease.textContent = p.knownDisease ? disease.name :` ? (${disease.name} –ø–æ–¥ –≤–æ–ø—Ä–æ—Å–æ–º)`;

  // 1) —Ñ–∏–∫—Å–∏—Ä—É–µ–º 4 –æ–ø—Ü–∏–∏ –ª–µ—á–µ–Ω–∏—è –æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞ –ø–∞—Ü–∏–µ–Ω—Ç–∞
  if(!p.treatmentOptions){
    p.treatmentOptions = pickTreatmentOptions(p);
    saveState();
  }
  const options = p.treatmentOptions;

  // 2) —Ñ–∏–∫—Å–∏—Ä—É–µ–º —Å–æ–≤–µ—Ç—ã –æ–¥–∏–Ω —Ä–∞–∑, –ø–æ–∫–∞ –Ω–µ —Å–º–µ–Ω–∏–ª–∏ –≤—Ä–∞—á–µ–π
  if(!p.doctorAdviceCache){
  const docs = dutyDoctors().filter(Boolean); // <-- –≤–∞–∂–Ω–æ
  p.doctorAdviceCache = docs.map(d => doctorAdviceText(d, options));
  saveState();
}
  elAdvice.innerHTML = p.doctorAdviceCache.join("<br>");

  // –µ—Å–ª–∏ –ø–∞—Ü–∏–µ–Ω—Ç —É–∂–µ –∏–º–µ–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –ø–∞–ª–∞—Ç–µ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
  const ward = findWardByPatient(patientId);
  const active = ward ? getActiveForWard(ward.id) : null;

  if(ward && ward.pendingResult && ward.pendingResult.patientId===patientId){
    showResult(ward);
    return;
  }

  if(ward && active && active.patientId===patientId){
    showActive(active);
    return;
  }

  // --- LAB UI ---
const max = state.lab?.maxPerPatient ?? 2;
const used = p.labUsed ?? 0;
const cost = state.lab?.costCoins ?? 15;

const d = getDiseaseById(p.trueDiseaseId);
const shown = new Set(p.visibleSymptoms || []);
const hidden = (d.symptoms || []).filter(s => !shown.has(s));

const canLab = state.shift?.active
  && used < max
  && state.coins >= cost
  && hidden.length > 0;

elLabBtn.disabled = !canLab;

elLabSub.textContent = `–û—Ç–∫—Ä–æ–µ—Ç –Ω–æ–≤—ã–π —Å–∏–º–ø—Ç–æ–º ‚Ä¢ –¶–µ–Ω–∞: ${cost} –º–æ–Ω–µ—Ç`;
elLabHint.textContent =
  hidden.length === 0 ? "–í—Å–µ —Å–∏–º–ø—Ç–æ–º—ã —É–∂–µ –∏–∑–≤–µ—Å—Ç–Ω—ã. –ü–∞—Ü–∏–µ–Ω—Ç –ø–æ—á—Ç–∏ –∫–∞–∫ —É—á–µ–±–Ω–∏–∫." :
  used >= max ? `–õ–∏–º–∏—Ç –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π –∏—Å—á–µ—Ä–ø–∞–Ω (${used}/${max}). `:
  state.coins < cost ?` –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–Ω–µ—Ç (${state.coins}/${cost}). `:
  `–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π: ${used}/${max}`;

  showTreat(options);
}

function labResearchSelected(){
  if(!state.selectedPatientId) return;
  const p = patientById(state.selectedPatientId);
  if(!p) return;

  // –ª–∏–º–∏—Ç –Ω–∞ –ø–∞—Ü–∏–µ–Ω—Ç–∞
  const max = state.lab?.maxPerPatient ?? 2;
  if((p.labUsed ?? 0) >= max) return;

  const cost = state.lab?.costCoins ?? 15;
  if(state.coins < cost) return;

  const d = getDiseaseById(p.trueDiseaseId);

  // –∫–∞–∫–∏–µ —Å–∏–º–ø—Ç–æ–º—ã —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω—ã
  const shown = new Set(p.visibleSymptoms || []);
  const hidden = (d.symptoms || []).filter(s => !shown.has(s));

  // –µ—Å–ª–∏ –Ω–µ—á–µ–≥–æ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å
  if(hidden.length === 0) return;

  // —Å–ø–∏—Å—ã–≤–∞–µ–º –æ–ø–ª–∞—Ç—É
  state.coins -= cost;

  // –æ—Ç–∫—Ä—ã–≤–∞–µ–º 1 –Ω–æ–≤—ã–π —Å–∏–º–ø—Ç–æ–º
  const newSym = pick(hidden);
  p.visibleSymptoms.push(newSym);

  // —Å—á–µ—Ç—á–∏–∫
  p.labUsed = (p.labUsed ?? 0) + 1;

  // –≤–∞–∂–Ω–æ–µ: –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–∏–º–ø—Ç–æ–º–æ–≤ –º–æ–∂–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å –∫–µ—à —Å–æ–≤–µ—Ç–æ–≤,
  // —á—Ç–æ–±—ã –≤—Ä–∞—á–∏ "–æ—Ç—Ä–µ–∞–≥–∏—Ä–æ–≤–∞–ª–∏" (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ –≤–∫—É—Å–Ω–æ)
  p.doctorAdviceCache = null;

  saveState();
  renderPatient(p.id);
  refreshVisibleUI();
}

function showTreat(options){
  elTreatPanel.style.display = "block";
  elActiveTreatment.style.display = "none";
  elResultPanel.style.display = "none";

  elTreatmentButtons.innerHTML = "";

  for(const mid of options){
    const b = document.createElement("button");
    b.className = "btn";
    b.onclick = ()=> chooseTreatment(mid);
    b.innerHTML = `
      ${escapeHtml(methodName(mid))}
      <div class="muted">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –Ω–∞–∑–Ω–∞—á–∏—Ç—å</div>
    `;
    elTreatmentButtons.appendChild(b);
  }
}

function showActive(active){
  elTreatPanel.style.display = "none";
  elActiveTreatment.style.display = "block";
  elResultPanel.style.display = "none";

  elActiveName.textContent = methodName(active.treatmentId);
  elActiveTimer.textContent = formatLeft(active.endAt - now());
}

function showResult(ward){
  elTreatPanel.style.display = "none";
  elActiveTreatment.style.display = "none";
  elResultPanel.style.display = "block";

  const r = ward.pendingResult;
  const kind = r.kind;

  const label =
    kind===OUTCOMES.CURE ? "‚úÖ –í—ã–ª–µ—á–µ–Ω" :
    kind===OUTCOMES.DISFIGURED ? "‚úÖ –í—ã–ª–µ—á–µ–Ω (–Ω–æ –ø–æ–∫–∞–ª–µ—á–µ–Ω)" :
    kind===OUTCOMES.INFECTED ? "‚úÖ –í—ã–ª–µ—á–µ–Ω (–Ω–æ –∏–Ω—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω)" :
    kind===OUTCOMES.WORSENED ? "‚ö†Ô∏è –°—Ç–∞–ª–æ —Ö—É–∂–µ" :
    "‚ò†Ô∏è –°–º–µ—Ä—Ç—å";

  const btnText = (kind===OUTCOMES.DEATH) ? "–í –º–æ—Ä–≥ (–∑–∞–∫—Ä—ã—Ç—å —Å–ª—É—á–∞–π)" : "–í—ã–ø–∏—Å–∞—Ç—å";

  elResultText.innerHTML = `
    <div style="font-weight:900; font-size:18px">${label}</div>
    <div class="muted" style="margin-top:6px">${escapeHtml(r.flavor || "")}</div>

    <div class="sep"></div>

    <div class="muted">–ú–µ—Ç–æ–¥:</div>
    <div style="font-weight:900">${escapeHtml(methodName(r.treatmentId))}</div>

    <div class="sep"></div>

    <div class="row">
      <div>üí∞ –ú–æ–Ω–µ—Ç—ã:</div>
      <div style="font-weight:900">${r.coins>=0?"+":""}${r.coins}</div>
    </div>
    <div class="row">
      <div>‚≠ê –†–µ–ø—É—Ç–∞—Ü–∏—è:</div>
      <div style="font-weight:900" class="${r.reputation<0?'bad':'ok'}">${r.reputation>=0?"+":""}${r.reputation}</div>
    </div>
    <div class="row">
      <div>üß´ –ë–∏–æ–º–∞—Ç–µ—Ä–∏–∞–ª:</div>
      <div style="font-weight:900">${r.biomaterial>=0?"+":""}${r.biomaterial}</div>
    </div>

    <div class="sep"></div>

    <button class="btn ok" onclick="dischargePatient('${r.patientId}','${r.wardId}')">
      ${btnText}
      <div class="muted">–û—Å–≤–æ–±–æ–¥–∏—Ç –ø–∞–ª–∞—Ç—É</div>
    </button>
  `;
}

function refreshVisibleUI(){
  const clinicVisible = document.getElementById("screen-clinic").classList.contains("active");
  const patientVisible = document.getElementById("screen-patient").classList.contains("active");

  if(clinicVisible) renderClinic();
  if(patientVisible && state.selectedPatientId) renderPatient(state.selectedPatientId);
}

/* =========================================================
   13) TICKS (queue + treatments + patient timer)
========================================================= */

let uiTick = null;

function startUITick(){
  if(uiTick) return;
  uiTick = setInterval(()=>{
    // –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–µ—Ä —Ç–æ–ª—å–∫–æ –Ω–∞ —ç–∫—Ä–∞–Ω–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞, –µ—Å–ª–∏ –æ–Ω –æ—Ç–∫—Ä—ã—Ç
    const patientVisible = document.getElementById("screen-patient").classList.contains("active");
    if(patientVisible && state.selectedPatientId){
      const ward = findWardByPatient(state.selectedPatientId);
      if(ward){
        const active = getActiveForWard(ward.id);
        if(active && active.patientId===state.selectedPatientId){
          if(now() >= active.endAt){
            completeTreatment(ward.id);
          } else {
            showActive(active);
          }
        }
      }
    }
  }, 250);
}

function processTreatmentsTick(){
  const map = getActiveMap();
  const t = now();
  let changed = false;

  for(const wardId of Object.keys(map)){
    const a = map[wardId];
    if(!a) continue;
    if(t >= a.endAt){
      completeTreatment(wardId);
      changed = true;
    }
  }

  if(changed) refreshVisibleUI();
}

setInterval(()=>{
  if(state.shift?.active && now() >= state.shift.endAt){
    endShift();
    return;
  }
  processQueueTick();
  processTreatmentsTick();
  refreshVisibleUI();
}, 500);

startUITick();

/* =========================================================
   14) INIT
========================================================= */

fillQueue();
saveState();
refreshVisibleUI();

/* =========================================================
   15) GLOBAL EXPORTS (for onclick)
========================================================= */

window.openPatientById = openPatientById;
window.backToClinic = backToClinic;
window.chooseTreatment = chooseTreatment;
window.upgradeWardStat = upgradeWardStat;
window.dischargePatient = dischargePatient;
window.rerollDuty = rerollDuty;
window.buyWardB = buyWardB;
window.startNewShift = startNewShift;  
window.openStaff = openStaff;
window.assignDoctorToSlot = assignDoctorToSlot;  
window.labResearchSelected = labResearchSelected;

</script>
</body>
</html>
