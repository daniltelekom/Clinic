<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <title>Plague Clinic git test</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#111a33;
      --panel2:#0f1730;
      --text:#e9eefc;
      --muted:#9fb0d9;
      --line:rgba(255,255,255,.08);
      --ok:#49d17d;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --accent:#5b7cff;
      --btn:#1b2a55;
      --btn2:#23356b;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,Segoe UI,Roboto,Arial;
     background:
  url("img/ui/global_bg.png") center/cover no-repeat,
  radial-gradient(1200px 700px at 30% -20%, rgba(91,124,255,.25), transparent 60%),
  var(--bg);
      color:var(--text);
    }
    
    .wrap{max-width:720px; margin:0 auto; padding:16px;}
.topbar{
  display:flex; 
  align-items:center; 
  justify-content:space-between;
  flex-wrap: wrap;          /* ‚Üê –í–ê–ñ–ù–û */
  gap:10px;                 /* ‚Üê –í–ê–ñ–ù–û */
  padding:12px 14px; 
  border:1px solid var(--line); 
  border-radius:16px;
  background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
  margin-bottom:12px;
   background:
    url("img/topbar_bg.png") center/cover no-repeat,
    linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
}
    .title{display:flex; gap:10px; align-items:center; font-weight:800;}
    .pill{
      padding:6px 10px; border:1px solid var(--line); border-radius:999px;
      background:rgba(255,255,255,.03); display:flex; gap:8px; align-items:center;
      font-weight:700;
    }
    .muted{color:var(--muted); font-weight:500}
    .screen{display:none}
    .screen.active{display:block}
    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      margin:12px 0;
    }
      /* –∫–æ–≥–¥–∞ "–ù–µ–¥–µ–ª—è" —Å–∫—Ä—ã—Ç–∞, –ø–æ–¥–Ω–∏–º–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç —ç–∫—Ä–∞–Ω–æ–≤ –≤—ã—à–µ */
body:not(.onClinic) .screen.active .panel:first-child{
  margin-top: 0;
}

    .dutyPanel{
  background:
    url("img/ui/duty_bg.png") center/cover no-repeat,
    linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.55));
}
    
    h2{margin:0 0 10px 0; font-size:18px}
    .card{
      background:rgba(0,0,0,.12);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      margin:10px 0;
    }
    .row{display:flex; gap:10px; align-items:center; justify-content:space-between}
    .btn{
      background:linear-gradient(180deg, var(--btn2), var(--btn));
      color:var(--text);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      font-weight:800;
      cursor:pointer;
      text-align:left;
      width:100%;
    }
    .btn:active{transform:scale(.99)}
    .btn.small{width:auto; padding:8px 10px; border-radius:12px}
    .btn.danger{background:linear-gradient(180deg, rgba(255,107,107,.22), rgba(255,107,107,.12))}
    .btn.ok{background:linear-gradient(180deg, rgba(73,209,125,.22), rgba(73,209,125,.12))}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .tag{
      padding:4px 8px; border:1px solid var(--line); border-radius:999px;
      font-weight:800; font-size:12px; background:rgba(255,255,255,.03);
      display:inline-flex; align-items:center; gap:6px;
    }
    .right{ text-align:right }
    .timer{font-weight:900; letter-spacing:.3px}
    .ok{color:var(--ok)}
    .warn{color:var(--warn)}
    .bad{color:var(--bad)}
    .listBtn{
      background:rgba(0,0,0,.12);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      margin:10px 0;
      cursor:pointer;
    }
    .listBtn:active{transform:scale(.995)}
    .listTitle{font-weight:900; font-size:16px}
    .listSub{color:var(--muted); margin-top:4px}
    .hint{font-size:12px; color:var(--muted); margin-top:8px}
    .sep{height:1px; background:var(--line); margin:10px 0}

    .tutOverlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.62);
  display:none;
  z-index:9999;
}
.tutOverlay.active{ display:block; }

.tutCard{
  position:fixed;
  left:50%;
  top:14%;
  transform:translateX(-50%);
  width:min(560px, calc(100% - 24px));

  background:
    url("img/ui/scroll.png") center / cover no-repeat,
    linear-gradient(
      180deg,
      rgba(10, 8, 4, 0.85),
      rgba(20, 16, 10, 0.85)
    );

  border:1px solid rgba(255,255,255,.18);
  border-radius:18px;
  padding:22px 20px 18px;
  z-index:10000;
  box-shadow:
    0 18px 60px rgba(0,0,0,.55),
    inset 0 0 40px rgba(0,0,0,.35);
}

    .tutTitle{
  font-weight:900;
  font-size:18px;
  color:#2a1c10;
  text-shadow:0 1px 0 rgba(255,255,255,.4);
}

.tutText{
  color:#2b2218;
  line-height:1.45;
}

.tutHint{
  color:#5a4633;
  font-size:12px;
}

.tutTitle{ font-weight:900; font-size:16px; margin-bottom:8px; }
.tutText{ color:var(--text); line-height:1.35; }
.tutHint{ color:var(--muted); font-size:12px; margin-top:8px; }

.tutNav{ display:flex; gap:10px; margin-top:12px; }
.tutNav .btn{ width:auto; }

.tutSpot{
  position:fixed;
  border:2px solid rgba(91,124,255,.9);
  border-radius:16px;
  box-shadow:0 0 0 9999px rgba(0,0,0,.55);
  pointer-events:none;
  z-index:9999;
}

    .methodBtn{
  display:flex;
  gap:12px;
  align-items:center;
}

.methodIcon{
  width:80px;
  height:80px;
  flex:0 0 80px;
  border-radius:10px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.03);
  object-fit:contain;
}

.methodMeta{
  display:flex;
  flex-direction:column;
  gap:2px;
}

.listTitle img{
  image-rendering: crisp-edges;
  filter: contrast(1.15);
}

.icon{
  width:18px;
  height:18px;
  display:inline-block;
  image-rendering:auto;
  filter: brightness(1.2) contrast(1.2);
  opacity:0.95;
}

.wardIcon{
  width:36px;
  height:36px;
  flex-shrink:0;
  opacity:0.95;
  filter: contrast(1.2) brightness(1.1);
}

.wardCard{
  background:
    url("img/wards/ward_bg.png") center/cover no-repeat,
    rgba(0,0,0,.18);
  border:1px solid rgba(255,255,255,.12);
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat
}

.wardUpgrade {
  display:flex;
  gap:10px;
  align-items:center;
  padding:10px;
  border-radius:14px;
  border:1px solid var(--line);
  background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.15));
  cursor:pointer;
  font-weight:700;
}

.wardUpgrade:active {
  transform: scale(.98);
}

.wardUpgrade.disabled {
  opacity:.45;
  pointer-events:none;
}

.wardIconStat {
  width:36px;
  height:36px;
  flex:0 0 36px;
  image-rendering: crisp-edges;
}

.wardUpgradeText {
  display:flex;
  flex-direction:column;
}

.wardUpgradeTitle {
  font-size:14px;
}

.wardUpgradeSub {
  font-size:11px;
  color:var(--muted);
}

.controlGrid{
  display:grid;
  grid-template-columns:1fr;
  gap:10px;
}

.controlCard{
  display:flex;
  align-items:center;
  gap:12px;
  padding:12px;
  border-radius:16px;
  border:1px solid var(--line);
  background:linear-gradient(
    180deg,
    rgba(255,255,255,.05),
    rgba(0,0,0,.12)
  );
  cursor:pointer;
  transition:transform .05s ease, box-shadow .05s ease;
}

.controlCard:hover{
  box-shadow:0 6px 20px rgba(0,0,0,.25);
}

.controlCard:active{
  transform:scale(.985);
}

.controlIcon{
  width:44px;
  height:44px;
  image-rendering:pixelated;
}

.controlTitle{
  font-weight:900;
  font-size:15px;
}

.controlSub{
  font-size:12px;
  color:var(--muted);
  margin-top:2px;
}

/* –ü–æ–¥–ª–æ–∂–∫–∞ –ø–æ–¥ –∏–Ω—Ñ–æ-–ø–ª–∞—à–∫–∏ –Ω–∞ —Ñ–æ–Ω–µ */
.chip {
  display:inline-flex;
  align-items:center;
  gap:10px;
  padding:10px 12px;
  border-radius:14px;
  background: rgba(10, 14, 28, 0.60);
  border: 1px solid rgba(255,255,255,0.10);
  box-shadow: 0 6px 18px rgba(0,0,0,0.35);
  backdrop-filter: blur(6px);
}

/* –¢–µ–∫—Å—Ç –Ω–∞ —Ñ–æ–Ω–µ: –∂–∏—Ä–Ω–µ–µ –∏ —Å —Ç–µ–Ω—å—é */
.uiTitle {
  font-weight: 800;
  font-size: 18px;
  color: #f3f6ff;
  text-shadow: 0 2px 10px rgba(0,0,0,0.60);
}

.uiSub {
  color: rgba(233,238,252,0.88);
  text-shadow: 0 2px 10px rgba(0,0,0,0.50);
}

/* –ò–∫–æ–Ω–∫–∞ –≤ –∫—Ä—É–≥–µ, —á—Ç–æ–±—ã –Ω–µ —Ä–∞—Å—Ç–≤–æ—Ä—è–ª–∞—Å—å */
.iconBadge {
  width: 44px;
  height: 44px;
  border-radius: 14px;
  background: rgba(0,0,0,0.35);
  border: 1px solid rgba(255,255,255,0.12);
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}
.iconBadge img {
  width: 28px;
  height: 28px;
  image-rendering: auto;
}

/* –ú–∞–ª–µ–Ω—å–∫–∏–µ —Å—Ç–∞—Ç—É—Å—ã —Ç–∏–ø–∞ "—Å–≤–æ–±–æ–¥–Ω–æ/–∑–∞–Ω—è—Ç–æ" */
.statusPill {
  display:inline-flex;
  align-items:center;
  padding: 6px 10px;
  border-radius: 999px;
  background: rgba(0,0,0,0.45);
  border: 1px solid rgba(255,255,255,0.12);
  font-weight: 700;
  color: #e9eefc;
  text-shadow: 0 2px 10px rgba(0,0,0,0.6);
}

/* –ü–∞–ª–∞—Ç—ã: —Ç–µ–∫—Å—Ç —á–∏—Ç–∞–µ–º—ã–π, –±–µ–ª—ã–π */
.wardCard .listTitle,
.wardCard .listSub{
  color: #fff;
}

.wardCard .tag{
  color: #fff;
  border-color: rgba(255,255,255,.25);
}

/* –µ—Å–ª–∏ —Ç–∞–π–º–µ—Ä —É —Ç–µ–±—è –≤ .timer */
.wardCard .timer{
  color: #fff;
}

/* ===== Ward layout v2 ===== */
.wardHeaderCenter{
  display:flex;
  flex-direction:column;
  align-items:center;
  text-align:center;
  gap:10px;
}

.wardHeaderCenter .chip{
  justify-content:center;
}

.wardBuyRow{
  display:flex;
  justify-content:center;
  margin-top:10px;
}

.wardPatientsGrid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
  margin-top:12px;
}

.wardCol{
  display:flex;
  flex-direction:column;
  gap:10px;
}

.wardSlotEmpty{
  border:1px dashed rgba(255,255,255,.18);
  background:rgba(0,0,0,.10);
  border-radius:14px;
  padding:10px 12px;
  color:rgba(233,238,252,.75);
  font-weight:700;
}

/* –ü–ª–∞—à–∫–∞ –ø–∞—Ü–∏–µ–Ω—Ç–∞ –≤ –ø–∞–ª–∞—Ç–µ (–æ–±–≤–æ–¥–∫–∞ –∫–∞–∫ —É —á–∏–ø–∞) */
.wardPatientRow{
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.22);
  border-radius: 14px;
  padding: 10px 12px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  box-shadow: 0 6px 18px rgba(0,0,0,.18);
}

/* ===== –ø–æ–¥—Å–≤–µ—Ç–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ –ø–∞—Ü–∏–µ–Ω—Ç–∞ (–≤—Å—è –∫–∞—Ä—Ç–æ—á–∫–∞) ===== */
.wardPatientRow.st-active{
  background: rgba(73, 209, 125, .26); /* –∑–µ–ª—ë–Ω—ã–π –∑–∞–º–µ—Ç–Ω–µ–µ */
  border-color: rgba(73, 209, 125, .40);
}

.wardPatientRow.st-done{
  background: rgba(73, 209, 125, .34); /* –µ—â—ë —è—Ä—á–µ, —Ç–∏–ø–∞ "–≥–æ—Ç–æ–≤–æ" */
  border-color: rgba(73, 209, 125, .55);
}

.wardPatientRow.st-idle{
  background: rgba(0,0,0,.22);         /* —Å–ø–æ–∫–æ–π–Ω—ã–π */
  border-color: rgba(255,255,255,.14);
}

/* –µ—Å–ª–∏ –≥–¥–µ-—Ç–æ –±—É–¥–µ—Ç pending (—Ä–µ–∑—É–ª—å—Ç–∞—Ç), –º–æ–∂–Ω–æ —Ç–æ–∂–µ –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å */
.wardPatientRow.st-pending{
  background: rgba(91, 124, 255, .22); /* —Å–∏–Ω–∏–π "–µ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç" */
  border-color: rgba(91, 124, 255, .45);
}

.wardPatientName{
  font-weight: 800;
  letter-spacing: .2px;

  flex: 1;
  min-width: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.wardPatientTimer{
  font-weight: 800;
  opacity: .9;
}

/* —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∏ –Ω–µ ‚Äú—Ä–∞–∑–¥—É–≤–∞–ª–∏‚Äù —Å—Ç—Ä–æ–∫—É */
.wardPatientRow .btn.small{
  white-space: nowrap;
}

/* ===== mobile fix: –Ω–∞ —É–∑–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö 1 –∫–æ–ª–æ–Ω–∫–∞ ===== */
@media (max-width: 420px){
  .wardPatientsGrid{
    grid-template-columns: 1fr;   /* –±—ã–ª–æ 2 –∫–æ–ª–æ–Ω–∫–∏, —Å—Ç–∞–Ω–µ—Ç 1 */
    gap: 10px;
  }

  .wardPatientRow{
    padding: 8px 10px;            /* –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ */
    border-radius: 12px;
  }

  .wardPatientName{
    font-size: 16px;              /* –º–æ–∂–Ω–æ 15px –µ—Å–ª–∏ –ø—Ä—è–º —Ç–µ—Å–Ω–æ */
  }

  .wardPatientTimer{
    font-size: 14px;
  }
}

    .maintBanner{
  margin-top:10px;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255, 107, 107, .12);
  color:#ffd7d7;
  font-weight:700;
}

.weekPanel{
  border:1px solid rgba(255,255,255,.10);
  position: relative;
  overflow: hidden;

  /* —Ç–≤–æ–π —Ñ–æ–Ω */
  background-image: url("img/topbar_bg.png");
  background-size: cover;
  background-position: center;
}

/* –∑–∞—Ç–µ–º–Ω—è—é—â–∞—è –≤—É–∞–ª—å, —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç —á–∏—Ç–∞–ª—Å—è */
.weekPanel::before{
  content:"";
  position:absolute;
  inset:0;
  background: linear-gradient(
    90deg,
    rgba(0,0,0,.55),
    rgba(0,0,0,.25)
  );
  pointer-events:none;
}

/* –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ–≤–µ—Ä—Ö –≤—É–∞–ª–∏ */
.weekPanel > *{
  position: relative;
  z-index: 1;
}
    body:not(.onClinic) #week-panel{
  display:none !important;
  margin-top:0 !important;
}

.weekTitle{
  display:flex;
  align-items:center;
  gap:8px;
}

.weekIcon{
  width:24px;
  height:24px;
  object-fit:contain;
  opacity:.95;
}

    .coinIcon{
  width: 14px;
  height: 14px;
  vertical-align: -2px;
  margin-left: 4px;
  opacity: .95;
}

/* —á—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –ø—Ä—è—Ç–∞–ª—Å—è –ø–æ–¥ bottom bar */
.wrap{
  padding-bottom: 86px;
}

.bottomBar{
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 9999;
  display: flex;
  justify-content: space-around;
  gap: 6px;
  padding: 10px 10px 12px;
  background: rgba(15, 23, 48, .92);
  border-top: 1px solid rgba(255,255,255,.10);
  backdrop-filter: blur(10px);
}

.bbItem{
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 6px;
  align-items: center;
  justify-content: center;
  padding: 10px 6px;
  border: 1px solid rgba(255,255,255,.10);
  border-radius: 14px;
  background: rgba(0,0,0,.20);
  color: rgba(233,238,252,.95);
  font-weight: 800;
  cursor: pointer;
}

.bbItem img{
  width: 22px;
  height: 22px;
  opacity: .95;
}

.bbItem.bbMain{
  transform: translateY(-6px);
  background: rgba(91,124,255,.20);
  border: 1px solid rgba(91,124,255,.45);
}

.bbItem.active{
  background: rgba(73, 209, 125, .18);
  border: 1px solid rgba(73, 209, 125, .40);
}

.rewardIcon{
  width: 16px;
  height: 16px;
  vertical-align: -3px;
  margin-right: 6px;
  opacity: .95;
}

/* –°—Ç—Ä–æ–∫–∞ –ø–∞—Ü–∏–µ–Ω—Ç–∞: –Ω–µ –¥–∞—ë–º flex-—Ä–∞–∑—ä–µ–∑–∂–∞—Ç—å—Å—è */
.wardPatientRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  width:100%;
  min-width:0;
  padding:8px 10px;
  border-radius:12px;
  box-sizing:border-box;
  cursor:pointer;
  transition: transform .08s ease, filter .08s ease;
}

.wardPatientRow:active{
  transform: scale(0.99);
  filter: brightness(1.05);
}

/* –ò–º—è –ø–∞—Ü–∏–µ–Ω—Ç–∞: –Ω–µ —Ä–∞—Å—à–∏—Ä—è–µ—Ç —Å—Ç—Ä–æ–∫—É, –∞ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –æ–±—Ä–µ–∑–∞–µ—Ç—Å—è */
.wardPatientName{
  flex:1;
  min-width:0;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

/* –ü—Ä–∞–≤–∞—è ‚Äú–∏–∫–æ–Ω–∫–∞ —Å—Ç–∞—Ç—É—Å–∞‚Äù: —Ñ–∏–∫—Å —à–∏—Ä–∏–Ω–∞, —á—Ç–æ–± –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä—ã–≥–∞–ª–æ */
.wardPatientStatus{
  width:34px;
  height:26px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:10px;
  font-size:16px;
  flex:0 0 auto;
}

/* –¢–∞–π–º–µ—Ä: —Ç–æ–∂–µ —Ñ–∏–∫—Å –ø–æ —à–∏—Ä–∏–Ω–µ, —á—Ç–æ–±—ã –Ω–∞ –º–æ–±–∏–ª–µ –Ω–µ —Ä–∞–∑–Ω–æ—Å–∏–ª–æ */
.wardPatientTimer{
  width:86px;           /* –º–æ–∂–Ω–æ 78‚Äì96 –ø–æ –≤–∫—É—Å—É */
  flex:0 0 auto;
  text-align:right;
  opacity:.95;
  font-variant-numeric: tabular-nums;
  white-space:nowrap;
}

/* ===== PATIENT CARD (new layout) ===== */
.patientCard{
  padding: 12px;
}

.patientHead{
  display: grid;
  grid-template-columns: 76px 1fr auto;
  gap: 10px;
  align-items: start;
}

.patientAvatar{
  width: 76px;
  height: 76px;
  border-radius: 14px;
  object-fit: cover;
  background: rgba(0,0,0,.15);
  border: 1px solid rgba(255,255,255,.10);
}

.patientMeta{
  min-width: 0;
}

.patientTopLine{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 8px;
}

.patientMiniRow{
  display:flex;
  gap:10px;
  align-items:flex-start;
}

.patientDisease{
  min-width:0;              /* –≤–∞–∂–Ω–æ –¥–ª—è flex */
  white-space:normal;
  overflow:hidden;

  /* –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –≤ 2 —Å—Ç—Ä–æ–∫–∏, –±–µ–∑ –∞–¥—Å–∫–æ–π –Ω–∞—Ä–µ–∑–∫–∏ –ø–æ –±—É–∫–≤–∞–º */
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;

  /* –∑–∞–ø—Ä–µ—Ç–∏—Ç—å –ø–µ—Ä–µ–Ω–æ—Å—ã —Ç–∏–ø–∞ "–î–∏–∞–≥-–Ω–æ–∑" */
  hyphens:none;
  overflow-wrap:normal;
  word-break:normal;

  line-height: 1.2;
  opacity:.95;
}

.patientBack{
  height: 34px;
  min-width: 40px;
  padding: 0 10px;
}

@media (max-width: 420px){
  .patientHead{
    grid-template-columns: 64px 1fr auto;
  }
  .patientAvatar{
    width: 64px;
    height: 64px;
    border-radius: 12px;
  }
}

.patientMiniRow{
  display:flex;
  gap:10px;
  align-items:baseline;
  flex-wrap:wrap;
}

.patientMiniRow .miniValue{
  flex: 1;
  min-width: 0;
  word-break: break-word;
  white-space: normal;
}

/* –æ—á–µ—Ä–µ–¥—å –∞–≤–∞—Ç–∞—Ä–∫–∞–º–∏ */
.queueGrid{
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap:10px;
}

.queueAvatarBtn{
  position:relative;
  padding:8px;
  border-radius:14px;
  border:1px solid var(--line);
  background: rgba(0,0,0,.12);
  display:flex;
  align-items:center;
  justify-content:center;
}

.queueAvatarBtn:active{ transform: scale(.98); }

.queueAvatarImg{
  width:64px;
  height:64px;
  border-radius:14px;
  object-fit:cover;
  border:1px solid rgba(255,255,255,.10);
}

.queueRarityDot{
  position:absolute;
  top:6px;
  right:6px;
  width:12px;
  height:12px;
  border-radius:999px;
  border:1px solid rgba(0,0,0,.35);
  background: rgba(255,255,255,.45);
}

.queueAvatarBtn.rare .queueRarityDot{ background: rgba(255,215,0,.9); }
.queueAvatarBtn.legendary .queueRarityDot{ background: rgba(255,105,180,.95); }

.queueTimerTiny{
  position:absolute;
  left:8px;
  right:8px;
  bottom:6px;
  height:6px;
  border-radius:999px;
  background: rgba(255,255,255,.12);
  overflow:hidden;
}

.queueTimerTiny > i{
  display:block;
  height:100%;
  width:50%;
  background: rgba(255,255,255,.55);
}
.queueAvatarBtn{
  position: relative;
}

.queueTimeText{
  position:absolute;
  left:50%;
  bottom:6px;
  transform:translateX(-50%);
  font-weight:900;
  font-size:13px;
  padding:2px 6px;
  border-radius:10px;
  background: rgba(0,0,0,.65);
  letter-spacing: .3px;
  text-shadow: 0 1px 2px rgba(0,0,0,.6);
}
    .queuePanel{
  background:
    url("img/ui/queue_bg.png") center/cover no-repeat,
    linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.6));
}

.queueTimeText.ok{ color: var(--ok); }
.queueTimeText.warn{ color: var(--warn); }
.queueTimeText.bad{ color: var(--bad); }


/* ========== PHARMACY ========== */
.cardBg{
  background-size: cover;
  background-position: center;
}

.pharmacyBg{ background-image: url("img/bg/pharmacy_main.jpg"); }
.pharmacyOrderBg{ background-image: url("img/bg/pharmacy_order.jpg"); }
.pharmacyMedsBg{ background-image: url("img/bg/pharmacy_meds.jpg"); }
.pharmacyResultBg{ background-image: url("img/bg/pharmacy_result.jpg"); }

.queueGrid{
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap:10px;
}

.queueAvatarBtn{
  position:relative;
  border-radius:14px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.25);
  aspect-ratio: 1 / 1;
}

.queueAvatarImg{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
  filter: contrast(1.05);
}

.queueAvatarBtn.common{ box-shadow: 0 0 0 1px rgba(255,255,255,.08) inset; }
.queueAvatarBtn.rare{ box-shadow: 0 0 0 2px rgba(255,215,0,.25) inset; }
.queueAvatarBtn.legendary{ box-shadow: 0 0 0 2px rgba(120,220,255,.25) inset; }

.queueTimerTiny{
  position:absolute;
  left:8px; right:8px; bottom:8px;
  height:8px;
  border-radius:6px;
  background: rgba(0,0,0,.35);
  overflow:hidden;
}
.queueTimerTiny i{
  display:block;
  height:100%;
  background: rgba(255, 190, 70, .95);
  border-radius:6px;
}

/* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—Å–µ–π —Å—Ç—Ä–æ–∫–∏ –ø–æ —Å—Ç–∞—Ç—É—Å—É */
.wardPatientRow.st-result{ background: rgba(73, 209, 125, .16); } /* –∑–µ–ª—ë–Ω—ã–π: –µ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç */
.wardPatientRow.st-done  { background: rgba(73, 209, 125, .22); } /* —è—Ä—á–µ: –º–æ–∂–Ω–æ –∑–∞–±—Ä–∞—Ç—å */
.wardPatientRow.st-active{ background: rgba(255, 204, 102, .14); } /* –∂—ë–ª—Ç—ã–π: –∏–¥—ë—Ç –ª–µ—á–µ–Ω–∏–µ */
.wardPatientRow.st-idle  { background: rgba(255, 255, 255, .06); } /* –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ */

    .costLine{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
.costPill{display:inline-flex; gap:6px; align-items:center; padding:4px 8px; border:1px solid var(--line); border-radius:999px; background:rgba(0,0,0,.18); font-weight:800}
.costPill img{width:16px; height:16px; opacity:.95}
    
  </style>
</head>
<body>
<div class="wrap">

  <!-- TOP -->
  <div class="topbar">
  <div class="title">üß™ –ß—É–º–Ω–∞—è –∫–ª–∏–Ω–∏–∫–∞ </div>
  <div style="display:flex; gap:8px; align-items:center;">
    <div class="pill">
  <img class="icon" src="icons/topbar/icon_coins.png" alt="">
  <span id="coins">0</span>
</div>
   <div class="pill">
  <img class="icon" src="icons/topbar/icon_rep.png" alt="">
  <span id="rep">0</span>
</div>

<div class="pill">
  <img class="icon" src="icons/topbar/icon_bio.png" alt="">
  <span id="bio">0</span>
</div>

<div class="pill">
  <img class="icon" src="icons/topbar/icon_time.png" alt="">
  <span id="shift-timer">--:--</span>
</div>
  </div>
</div>

  <div id="maintenance-banner" class="maintBanner" style="display:none"></div>

<div class="panel weekPanel" id="week-panel" style="padding:10px 12px;">
  <div class="row" style="align-items:flex-start;">
    <div>
     <div class="listTitle weekTitle" id="week-title">
  <img class="weekIcon" src="icons/topbar/icon_celendar.png" alt="">
  <span id="week-title-text">–ù–µ–¥–µ–ª—è 1: ‚Äî</span>
</div>
      <div class="hint" id="week-desc">–≠—Ñ—Ñ–µ–∫—Ç—ã: ‚Äî</div>
    </div>
    <div class="tag" id="week-shift">–°–º–µ–Ω–∞: 1/7</div>
  </div>
</div>

  <div class="panel dutyPanel">

  <!-- SCREEN: CLINIC -->
  <div class="screen active" id="screen-clinic">

    <div class="panel">
      <h2>–ü–∞–ª–∞—Ç—ã</h2>
      <div id="wards"></div>
      <div class="hint">–ü–∞–ª–∞—Ç—ã –ª–µ—á–∞—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ. –ü—Ä–æ–∫–∞—á–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞ –∫–∞–ø–∞–º–∏ –∏ –¥–æ—Ä–æ–∂–∞–µ—Ç.</div>
    </div>

    <div class="panel">
      <h2>–î–µ–∂—É—Ä–Ω—ã–µ –¥–æ–∫—Ç–æ—Ä–∞</h2>
      <div id="duty"></div>
      <div class="hint">–î–µ–∂—É—Ä–Ω—ã–µ –¥–∞—é—Ç —Å–æ–≤–µ—Ç—ã –∏ —à—Ç—Ä–∞—Ñ—É—é—Ç –º–µ—Ç–æ–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ ‚Äú–Ω–µ —É–º–µ—é—Ç‚Äù.</div>
    </div>

    <div class="panel queuePanel">
      <h2>–û—á–µ—Ä–µ–¥—å –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤</h2>
      <div id="queue-upgrades" class="grid2" style="margin:10px 0;"></div>
      <div id="queue"></div>
      <div class="hint">–ï—Å–ª–∏ –¥–æ–ª–≥–æ –Ω–µ –ª–µ—á–∏—Ç—å: –º–æ–≥—É—Ç —É–π—Ç–∏ –∏–ª–∏ —É–º–µ—Ä–µ—Ç—å –ø—Ä—è–º–æ –≤ –æ—á–µ—Ä–µ–¥–∏. –ñ–∏–∑–Ω—å.</div>
    </div>

  </div>

<!-- SCREEN: PATIENT -->
<div class="screen" id="screen-patient">

  <div class="panel patientCard">
    <div class="patientHead">
      <img id="patient-avatar" class="patientAvatar" src="img/patients/placeholder.png" alt="">
      <div class="patientMeta">
        <div class="patientTopLine">
          <div class="listTitle" id="patient-title">–ü–∞—Ü–∏–µ–Ω—Ç</div>
          <span id="patient-rarity" class="tag">common</span>
        </div>

        <div class="listSub" id="patient-sub">—Å–∏–º–ø—Ç–æ–º—ã‚Ä¶</div>

        <!--
        <div class="patientMiniRow">
          <span class="muted">–ü–æ–¥–æ–∑—Ä–µ–Ω–∏–µ:</span>
          <span id="patient-clue" class="miniValue">?</span>
        </div>
        -->

        <div class="patientMiniRow">
          <span class="muted">–î–∏–∞–≥–Ω–æ–∑:</span>
          <span id="patient-diagnosis" class="miniValue">???</span>
        </div>
      </div>
    </div>

    <div class="sep"></div>

    <div class="muted">–°–æ–≤–µ—Ç—ã –¥–µ–∂—É—Ä–Ω—ã—Ö:</div>
    <div id="doctor-advice" class="hint"></div>
  </div>

  <!-- –õ–∞–±–∞ -->
  <button class="btn" id="btn-lab" onclick="labResearchSelected()">
    ü©∫ –û–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ
    <div class="muted" id="lab-sub">–û—Ç–∫—Ä–æ–µ—Ç –Ω–æ–≤—ã–π —Å–∏–º–ø—Ç–æ–º</div>
  </button>
  <div class="hint" id="lab-hint"></div>

  <!-- –î–µ–π—Å—Ç–≤–∏—è -->
  <div class="panel" id="patient-actions"></div>

  <!-- –ù–∞–∑–Ω–∞—á–∏—Ç—å –ª–µ—á–µ–Ω–∏–µ -->
  <div class="panel" id="treat-panel">
    <h2>–ù–∞–∑–Ω–∞—á–∏—Ç—å –ª–µ—á–µ–Ω–∏–µ</h2>
    <div id="treatment-buttons"></div>
    <div class="hint">–í—ã–±–∏—Ä–∞–π –∏–∑ 4 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤. –û–¥–∏–Ω –æ–±—ã—á–Ω–æ –ª—É—á—à–µ, –æ–¥–∏–Ω –æ–±—ã—á–Ω–æ —Ö—É–∂–µ, –¥–≤–∞ –ø—Ä–æ—Å—Ç–æ –ø–æ –ø—Ä–∏–∫–æ–ª—É.</div>
    <button class="btn" onclick="backToClinic()" style="width:100%; margin-top:10px;">
    ‚Üê –ù–∞–∑–∞–¥
  </button>
  </div>

  <!-- –ê–∫—Ç–∏–≤–Ω–æ–µ –ª–µ—á–µ–Ω–∏–µ -->
  <div class="panel" id="active-treatment" style="display:none">
    <h2>–õ–µ—á–µ–Ω–∏–µ –∏–¥—ë—Ç</h2>
    <div class="muted">–ú–µ—Ç–æ–¥:</div>
    <div id="active-treatment-name" style="font-weight:900; margin:6px 0 10px 0;">‚Äî</div>
    <div class="muted">–û—Å—Ç–∞–ª–æ—Å—å:</div>
    <div id="active-treatment-timer" class="timer">--:--</div>
    <button class="btn" onclick="backToClinic()" style="width:100%; margin-top:10px;">
    ‚Üê –ù–∞–∑–∞–¥
  </button>
  </div>

  <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
  <div class="panel" id="result-panel" style="display:none">
    <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç</h2>
    <div id="result-text"></div>
  </div>

</div>

<!-- SCREEN: RESEARCH -->
<div id="screen-research" class="screen">
  <div class="panel">
    <div class="row" style="align-items:flex-start;">
      <div>
        <div class="listTitle">üß™ –ò–∑—É—á–µ–Ω–∏–µ</div>
        <div class="listSub">–¢—Ä–∞—Ç—å üí∞ –∏ üß´, –∂–¥–∏ –≤—Ä–µ–º—è, –ø–æ–ª—É—á–∞–π –≥—Ä—è–∑–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞.</div>
      </div>
    </div>
  </div>

  <div id="research-active" class="card" style="margin-top:10px; display:none;"></div>

  <div class="card" style="margin-top:10px;">
    <div class="listTitle">–î—Ä–µ–≤–æ</div>
    <div class="listSub">–ù–∞–∂–º–∏ –Ω–∞ –Ω–∞–≤—ã–∫, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∏–∑—É—á–µ–Ω–∏–µ.</div>
    <div class="sep"></div>
    <div id="research-tree"></div>
  </div>
</div>

<!-- SCREEN: SHIFT END -->
<div class="screen" id="screen-shiftend">
  <div class="panel">
    <div class="listTitle">–°–º–µ–Ω–∞ –æ–∫–æ–Ω—á–µ–Ω–∞</div>
    <div class="listSub" id="shift-summary">‚Ä¶</div>
    <div class="sep"></div>

<div class="listTitle">üéÅ –ù–∞–≥—Ä–∞–¥–∞ –∑–∞ —Å–º–µ–Ω—É</div>
<div class="listSub" id="reward-hint">–í—ã–±–µ—Ä–∏ –æ–¥–Ω—É –∏–∑ —Ç—Ä—ë—Ö.</div>

<div id="reward-list"></div>

<div class="sep"></div>

<button class="btn ok" id="btn-next-shift">
  üîÅ –ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é —Å–º–µ–Ω—É
  <div class="muted">–û—á–µ—Ä–µ–¥—å –æ–±–Ω–æ–≤–∏—Ç—Å—è, —Ç–∞–π–º–µ—Ä —Å–±—Ä–æ—Å–∏—Ç—Å—è</div>
</button>
  </div>
</div>

<!-- SCREEN: STAFF -->
<div class="screen" id="screen-staff">
  <div class="panel">
    <div class="row">
      <div>
        <div class="listTitle">üë• –®—Ç–∞—Ç</div>
        <div class="listSub">"–í—Ä–∞—á–∏,—É—Å—Ç–∞–ª–æ—Å—Ç—å,–æ—Ç–¥—ã—Ö".</div>
      </div>
      <button class="btn small" type="button" onclick="backToClinic()">‚Üê –ù–∞–∑–∞–¥</button>
    </div>
    <div class="sep"></div>
    <div id="staff-list"></div>
  </div>
</div>  

 

<!-- SCREEN: SHOP -->
<div class="screen" id="screen-shop">
  <div class="panel">
    <div class="row">
      <div>
        <div class="listTitle">üõí –õ–∞–≤–∫–∞</div>
        <div class="listSub">–¢—Ä–∞—Ç—å –º–æ–Ω–µ—Ç—ã/—Ä–µ–ø—É/–±–∏–æ –∏ –¥–µ–ª–∞–π –≤–∏–¥, —á—Ç–æ —Ç—ã –º–µ–Ω–µ–¥–∂–µ—Ä.</div>
      </div>
      <button class="btn small" type="button" onclick="backToClinic()">‚Üê –ù–∞–∑–∞–¥</button>
    </div>
    <div class="sep"></div>
    <div id="shop-list"></div>
  </div>
</div>  

   <div id="tut-overlay" class="tutOverlay">
  <div id="tut-spot" class="tutSpot" style="display:none"></div>

  <div class="tutCard">
    <div class="tutTitle" id="tut-title">–û–±—É—á–µ–Ω–∏–µ</div>
    <div class="tutText" id="tut-text"></div>
    <div class="tutHint" id="tut-hint"></div>

    <div class="tutNav">
      <button class="btn small" id="tut-prev">‚Üê –ù–∞–∑–∞–¥</button>
      <button class="btn small ok" id="tut-next">–î–∞–ª–µ–µ ‚Üí</button>
      <button class="btn small danger" id="tut-close">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div> 

  <!-- LOOT MODAL -->
<div id="loot-overlay" class="tutOverlay" style="display:none;">
  <div class="tutCard">
    <div class="tutTitle" id="loot-title">–ù–∞–≥—Ä–∞–¥–∞</div>
    <div class="tutText" id="loot-text"></div>
    <div class="tutHint" id="loot-hint"></div>

    <div class="tutNav">
      <button class="btn small ok" id="loot-ok">–ó–∞–±—Ä–∞—Ç—å</button>
    </div>
  </div>
</div>

<!-- BOTTOM BAR -->
<div class="bottomBar" id="bottom-bar">
  <button class="bbItem" id="bb-staff" onclick="openStaff()">
    <img src="img/control/staff.png" alt="">
    <div>–®—Ç–∞—Ç</div>
  </button>

  <button class="bbItem" id="bb-shop" onclick="openShop()">
    <img src="img/control/shop.png" alt="">
    <div>–õ–∞–≤–∫–∞</div>
  </button>

  <button class="bbItem bbMain" id="bb-clinic" onclick="backToClinic()">
    <img src="img/control/icon_clinic.png" alt="">
    <div>–ì–ª–∞–≤–Ω–∞—è</div>
  </button>

  <button class="bbItem" id="bb-research" onclick="openResearch()">
    <img src="img/control/icon_isled.png" alt="">
    <div>–ò—Å—Å–ª–µ–¥.</div>
  </button>

<button class="bbItem" id="bb-apteka" onclick="openPharmacy()">
    <img src="img/control/apteka.png" alt="">
    <div>–ê–ø—Ç–µ–∫–∞</div>
  </button>
  
  <button class="bbItem" id="bb-tutorial" onclick="startTutorial(true)">
    <img src="img/control/tutorial.png" alt="">
    <div>–û–±—É—á–µ–Ω–∏–µ</div>
  </button>
</div>


<!-- SCREEN: PHARMACY -->
<div class="screen" id="screen-pharmacy">
  <div class="panel cardBg pharmacyBg">
    <div class="row" style="align-items:center; justify-content:space-between;">
      <div class="listTitle">üè∫ –ê–ø—Ç–µ–∫–∞</div>
      <button class="btn small" type="button" onclick="backToClinic()">‚úñ –ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <div class="sep"></div>

    <button class="btn ok" type="button" onclick="openPharmacyMeds()">üß™ –õ–µ–∫–∞—Ä—Å—Ç–≤–∞</button>

    <div class="sep"></div>

    <div class="muted" style="margin-bottom:8px;">–û—á–µ—Ä–µ–¥—å –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
    <div id="pharmacy-queue"></div>

    <div class="hint" style="margin-top:10px; opacity:.85;">
      –ö–ª–∏–µ–Ω—Ç—ã –ø—Ä–∏—Ö–æ–¥—è—Ç —Ä–µ–¥–∫–æ. –í ‚Äú–ò–∑—É—á–µ–Ω–∏–∏‚Äù –º–æ–∂–Ω–æ –ø—Ä–æ–∫–∞—á–∞—Ç—å —á–∞—Å—Ç–æ—Ç—É.
    </div>
  </div>
</div>

<!-- SCREEN: PHARM ORDER -->
<div class="screen" id="screen-pharm-order">
  <div class="panel cardBg pharmacyOrderBg">
    <div class="row" style="align-items:center; justify-content:space-between;">
      <div class="listTitle">üìú –ó–∞–∫–∞–∑</div>
      <button class="btn small" type="button" onclick="openPharmacy()">‚úñ –ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <div class="sep"></div>

    <div id="pharm-order-text" class="hint"></div>

    <div class="sep"></div>

    <div class="muted">–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞:</div>
    <div id="pharm-order-answers" style="margin-top:8px;"></div>

    <div class="sep"></div>

    <div class="muted">–ü–æ–¥—Ö–æ–¥—è—â–∏–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ (–µ—Å–ª–∏ –∏–∑—É—á–µ–Ω—ã):</div>
    <div id="pharm-order-meds" class="hint" style="margin-top:6px;"></div>
  </div>
</div>

<!-- SCREEN: PHARM MEDS LIST -->
<div class="screen" id="screen-pharm-meds">
  <div class="panel cardBg pharmacyMedsBg">
    <div class="row" style="align-items:center; justify-content:space-between;">
      <div class="listTitle">üß™ –õ–µ–∫–∞—Ä—Å—Ç–≤–∞</div>
      <button class="btn small" type="button" onclick="openPharmacy()">‚Üê –ù–∞–∑–∞–¥</button>
    </div>

    <div class="sep"></div>

    <div id="pharm-meds-active" class="hint" style="display:none;"></div>
    <div id="pharm-meds-list"></div>
  </div>
</div>

<!-- SCREEN: PHARM RESULT -->
<div class="screen" id="screen-pharm-result">
  <div class="panel cardBg pharmacyResultBg">
    <div class="row" style="align-items:center; justify-content:space-between;">
      <div class="listTitle">üìå –ò—Ç–æ–≥</div>
      <button class="btn small" type="button" onclick="openPharmacy()">‚úñ –ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <div class="sep"></div>

    <div id="pharm-result-text" class="hint"></div>

    <div class="sep"></div>

    <div id="pharm-result-reward" class="hint"></div>
  </div>
</div>


<script>

  let state = null;

function looksLikeTelegramInitData(s){
  if(!s) return false;
  return typeof s === "string" && (s.includes("tgWebAppVersion") || s.includes("tgWebAppPlatform") || s.includes("tgWebAppData"));
}

function safeShort(v, maxLen = 280){
  try{
    const s = (typeof v === "string") ? v : JSON.stringify(v);
    if(!s) return "";
    return s.length > maxLen ? (s.slice(0, maxLen) + " ...(cut)") : s;
  }catch{
    return String(v).slice(0, maxLen) + " ...(cut)";
  }
}

function showCrash(title, info){
  // Telegram WebView –∏–Ω–æ–≥–¥–∞ –∫–∏–¥–∞–µ—Ç "Script error." –≤–æ–æ–±—â–µ –±–µ–∑ –¥–µ—Ç–∞–ª–µ–π
  if(info?.message === "Script error.") {
    console.log("Ignored Script error (WebView):", info);
    return;
  }

  // –ï—Å–ª–∏ –≤ –æ—à–∏–±–∫—É –∫–∞–∫–∏–º-—Ç–æ –æ–±—Ä–∞–∑–æ–º –ø–æ–ø–∞–ª–∞ telegram initData –ø—Ä–æ—Å—Ç—ã–Ω—è ‚Äî –Ω–µ —Å–ø–∞–º–∏–º –µ—é
  const msg = info?.message || info?.reason || "";
  if(looksLikeTelegramInitData(msg)){
    alert(title + "\n" + "–ü–æ–π–º–∞–ª–∏ Telegram initData –≤ –æ—à–∏–±–∫–µ. –†–µ–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞ –≤—ã—à–µ –≤ –∫–æ–Ω—Å–æ–ª–∏.");
    console.log(title, info);
    return;
  }

  const clean = {
    message: safeShort(info?.message),
    reason: safeShort(info?.reason),
    file: info?.file,
    line: info?.line,
    col: info?.col,
    stack: safeShort(info?.stack, 800),
  };

  alert(title + "\n" + JSON.stringify(clean, null, 2));
  console.log("CRASH:", title, info);
}
window.addEventListener("error", (e) => {
  showCrash("JS —É–ø–∞–ª (error)", {
    message: e.message,
    file: e.filename,
    line: e.lineno,
    col: e.colno,
    stack: e.error?.stack || null
  });
});

window.addEventListener("unhandledrejection", (e) => {
  showCrash("JS —É–ø–∞–ª (unhandledrejection)", {
    reason: (typeof e.reason === "string") ? e.reason : (e.reason?.message || e.reason),
    stack: e.reason?.stack || null
  });
});

document.addEventListener("click", (e) => {
  // —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å, –∫–ª–∏–∫–∏ –≤–æ–æ–±—â–µ –¥–æ—Ö–æ–¥—è—Ç –∏–ª–∏ –∏—Ö –∫—Ç–æ-—Ç–æ –∂—Ä—ë—Ç
  // –ø–æ–∫–∞–∂–µ–º, –ø–æ —á–µ–º—É —Ç–∞–ø–Ω—É–ª–∏
  const t = e.target;
  // –Ω–µ —Å–ø–∞–º–∏–º –Ω–∞ –∫–∞–∂–¥—ã–π —Ç–∏–∫, —Ç–æ–ª—å–∫–æ –ø–æ –∫–ª–∏–∫—É
  console.log("CLICK:", t.tagName, t.className, t.id);
}, true);
  
/* =========================================================
   0) CONST / ENUMS
========================================================= */

const elPatientActions = document.getElementById("patient-actions");
  
const OUTCOMES = {
  CURE: "cure",
  DISFIGURED: "disfigured",
  INFECTED: "infected",
  WORSENED: "worsened",
  DEATH: "death"
};

const RARITY = {
  COMMON: "common",
  RARE: "rare",
  LEGENDARY: "legendary"
};

const LS_STATE = "plague_state_v7.4";
const LS_ACTIVE = "plague_active_map_v7.4";

/* =========================================================
   1) DATA: methods / diseases / doctors / names
========================================================= */

const METHODS = [
  { id:"bloodletting", name:" –ö—Ä–æ–≤–æ–ø—É—Å–∫–∞–Ω–∏–µ" },
  { id:"herbalism", name:" –ù–∞—Å—Ç–æ–π —Ç—Ä–∞–≤" },
  { id:"prayer", name:" –ú–æ–ª–∏—Ç–≤–∞" },
  { id:"demonology", name:" –î–µ–º–æ–Ω–æ–ª–æ–≥–∏—è" },
  { id:"amputation", name:" –ê–º–ø—É—Ç–∞—Ü–∏—è" },
  { id:"hypnosis", name:" –ì–∏–ø–Ω–æ–∑" },
  { id:"charms", name:" –ó–∞–≥–æ–≤–æ—Ä—ã" },
];

const METHOD_HINTS = {
  bloodletting: {
    tags: ["–∑–∞—Å—Ç–æ–π", "—Ç—è–∂–µ—Å—Ç—å", "–¥–∞–≤–ª–µ–Ω–∏–µ", "—á–µ—Ä–Ω–∏–ª—å–Ω—ã–π –∫–∞—à–µ–ª—å"],
    examples: ["–ø–æ—Ç–µ–º–Ω–µ–Ω–∏—è –∫–æ–∂–∏", "—á—ë—Ä–Ω—ã–π –∫–∞—à–µ–ª—å", "–∂–∞—Ä –∏ —Ç—è–∂–µ—Å—Ç—å", "—á—Ç–æ-—Ç–æ –Ω–∞–¥–æ ‚Äú–≤—ã–ø—É—Å—Ç–∏—Ç—å‚Äù"]
  },
  herbalism: {
    tags: ["–ª–∏—Ö–æ—Ä–∞–¥–∫–∞", "–∫–∞—à–µ–ª—å", "—Å–ª–∞–±–æ—Å—Ç—å", "–∂–∞–∂–¥–∞"],
    examples: ["–º–∏–∞–∑–º—ã –∏ –ª–∏—Ö–æ—Ä–∞–¥–∫–∞", "—Å—Ç–µ–∫–ª—è–Ω–Ω—ã–π –∫–∞—à–µ–ª—å", "–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π —è–∑—ã–∫", "–ø—Ä–æ—Å—Ç—É–¥–∞ –≤–µ–∫–∞–º–∏"]
  },
  prayer: {
    tags: ["—Å–≤—è—Ç–æ—Å—Ç—å", "—à—ë–ø–æ—Ç", "—Å–Ω—ã", "—á–µ—Ä–≤–∏"],
    examples: ["—Å–≤—è—Ç—ã–µ —á–µ—Ä–≤–∏", "—Å–≤—è—Ç–æ–µ —à—É—Ä—à–∞–Ω–∏–µ", "–∫–æ–≥–¥–∞ –ø–∞—Ü–∏–µ–Ω—Ç —à–µ–ø—á–µ—Ç –º–æ–ª–∏—Ç–≤—ã", "–∫–æ–≥–¥–∞ —É —Ç–µ–±—è –Ω–µ—Ç –¥—Ä—É–≥–∏—Ö –∏–¥–µ–π"]
  },
  demonology: {
    tags: ["—á—É–∂–∏–µ –≥–ª–∞–∑–∞", "—Ç–µ–Ω—å –æ—Ç–¥–µ–ª—å–Ω–æ", "–∫–æ–Ω—Ç—Ä–∞–∫—Ç", "–æ–¥–µ—Ä–∂–∏–º–æ—Å—Ç—å"],
    examples: ["–∫—Ç–æ-—Ç–æ –≤–Ω—É—Ç—Ä–∏", "—Ç–µ–Ω—å –∂–∏–≤—ë—Ç –æ—Ç–¥–µ–ª—å–Ω–æ", "—Å–º–µ—Ö –Ω–µ –∫ –º–µ—Å—Ç—É", "–∫–æ–≥–¥–∞ –Ω–∞–¥–æ –≥–æ–≤–æ—Ä–∏—Ç—å —Å –ø—Ä–æ–±–ª–µ–º–æ–π –Ω–∞ –µ—ë —è–∑—ã–∫–µ"]
  },
  amputation: {
    tags: ["–≥–Ω–∏–ª—å", "–ø–ª–µ—Å–µ–Ω—å", "–ª–æ–∫–∞–ª—å–Ω–æ", "—Ä–∞—Å–ø–æ–ª–∑–∞–µ—Ç—Å—è"],
    examples: ["–ø–ª–µ—Å–µ–Ω—å –Ω–∞ –∫–æ—Å—Ç—è—Ö", "–≥–Ω–∏–ª—å –∑–Ω–∞–∫–∞", "–ø—è—Ç–Ω–æ —Ä–∞—Å—Ç—ë—Ç", "–ª—É—á—à–µ –º–∏–Ω—É—Å —á–∞—Å—Ç—å, —á–µ–º –º–∏–Ω—É—Å –≤—Å—ë"]
  },
  hypnosis: {
    tags: ["–∑–≤–æ–Ω", "–ø—É—Ç–∞–µ—Ç –∏–º–µ–Ω–∞", "–≤–æ–ª–Ω–∞–º–∏", "–Ω–µ—Ä–≤—ã"],
    examples: ["–∑–≤–æ–Ω –≤ –∫–æ—Å—Ç—è—Ö", "–∑–µ—Ä–∫–∞–ª—å–Ω–∞—è –≥–æ—Ä—è—á–∫–∞", "–∫–æ–≥–¥–∞ –º–æ–∑–≥ –µ–¥–µ—Ç", "–∫–æ–≥–¥–∞ –Ω–∞–¥–æ —É—Å–ø–æ–∫–æ–∏—Ç—å –≥–æ–ª–æ–≤—É"]
  },
  charms: {
    tags: ["–≤–æ—Å–∫", "–∑–Ω–∞–∫–∏", "–ª–∏–ø–∞–Ω–∏—è", "—Å–∏–º–≤–æ–ª—ã"],
    examples: ["–≤–æ—Å–∫–æ–≤–∞—è –∫–æ–∂–∞", "—Å—Ç—Ä–∞–Ω–Ω—ã–µ –∫–æ–∂–Ω—ã–µ —à—Ç—É–∫–∏", "–∫–æ–≥–¥–∞ –Ω–∞–¥–æ ‚Äò—Å–Ω—è—Ç—å –ø–æ—Ä—á—É‚Äô", "–∫–æ–≥–¥–∞ –ø–∞—Ü–∏–µ–Ω—Ç –ø–æ—Ö–æ–∂ –Ω–∞ —Å–≤–µ—á—É"]
  },
};

  const METHOD_ICONS = {
  bloodletting: "icons/methods/bloodletting.png",
  herbalism: "icons/methods/herbalism.png",
  prayer: "icons/methods/prayer.png",
  demonology: "icons/methods/demonology.png",
  amputation: "icons/methods/amputation.png",
  hypnosis: "icons/methods/hypnosis.png",
  charms: "icons/methods/charms.png",
};

function methodHintLine(methodId){
  const h = METHOD_HINTS[methodId];
  if(!h) return "";
  // –∫–æ—Ä–æ—Ç–∫–æ: –ª–∏–±–æ tags, –ª–∏–±–æ examples
  const line = (h.examples && h.examples.length) ? h.examples.slice(0,3).join(" ‚Ä¢ ") : (h.tags||[]).slice(0,3).join(" ‚Ä¢ ");
  return line ? `üí° ${line}` : "";
}


function methodName(id){
  const m = METHODS.find(x=>x.id===id);
  if(id === "prayer") return "–ú–æ–ª–∏—Ç–≤–∞";
  return m ? m.name : id;
}

  function toFemaleLastName(last){
  // –ù–µ—Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ/–Ω–µ–∏–∑–º–µ–Ω—è–µ–º—ã–µ (–Ω–∞ –≤—Å—è–∫–∏–π)
  const indeclinable = ["–°–∫–≤–æ–∑–Ω—è–∫"];
  if(indeclinable.includes(last)) return last;

  // -—ã–π / -–∏–π -> -–∞—è
  if(last.endsWith("—ã–π")) return last.slice(0, -2) + "–∞—è";
  if(last.endsWith("–∏–π")) return last.slice(0, -2) + "–∞—è";

  // -–æ–π -> -–∞—è (—Ä–µ–¥–∫–æ, –Ω–æ –ø—É—Å—Ç—å –±—É–¥–µ—Ç)
  if(last.endsWith("–æ–π")) return last.slice(0, -2) + "–∞—è";

  // –µ—Å–ª–∏ —É–∂–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ –∂–µ–Ω—Å–∫–æ–µ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
  if(last.endsWith("–∞—è")) return last;

  // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–µ —Ç—Ä–æ–≥–∞–µ–º
  return last;
}

// –ë–æ–ª–µ–∑–Ω–∏: —Å–∏–º–ø—Ç–æ–º—ã + –≤–µ—Å–∞ –º–µ—Ç–æ–¥–æ–≤ (—á–µ–º –≤—ã—à–µ, —Ç–µ–º ‚Äú–ª—É—á—à–µ —à–∞–Ω—Å‚Äù)
const DISEASES = [
  {
    id:"miasma_fever",
    name:"–ú–∏–∞–∑–º–µ–Ω–Ω–∞—è –ª–∏—Ö–æ—Ä–∞–¥–∫–∞",
    rarity: RARITY.COMMON,
    symptoms:["–ñ–∞—Ä","–û–∑–Ω–æ–±","–¢—è–∂–µ—Å—Ç—å –≤ –≥—Ä—É–¥–∏"],
    cureBy: "herbalism",
  badBy: "bloodletting",
    hints:[
       "–ñ–∞—Ä –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤–º–µ—Å—Ç–µ —Å –∑–∞–ø–∞—Ö–æ–º —Å—ã—Ä–æ—Å—Ç–∏.",
  "–ì–æ–ª–æ–≤–∞ —Ç—è–∂—ë–ª–∞—è, –º—ã—Å–ª–∏ –≤—è–∑–∫–∏–µ, –∫–∞–∫ —Ç—É–º–∞–Ω.",
  "–ö–∞–∂–µ—Ç—Å—è, –±–æ–ª–µ–∑–Ω—å –¥—ã—à–∏—Ç –≤–º–µ—Å—Ç–µ —Å –ø–∞—Ü–∏–µ–Ω—Ç–æ–º."
    ],
    weights:{ herbalism: 1.2, prayer: 1.0, bloodletting: 0.8, hypnosis: 0.9, charms: 1.0, demonology: 0.6, amputation: 0.2 }
  },
  {
    id:"black_spots",
    name:"–ß—ë—Ä–Ω—ã–µ –ø—è—Ç–Ω–∞",
    rarity: RARITY.RARE,
    cureBy: "bloodletting",
  badBy: "amputation",
    symptoms:["–ß—ë—Ä–Ω—ã–µ –ø—è—Ç–Ω–∞","–°–ª–∞–±–æ—Å—Ç—å","–ú—Ä–∞—á–Ω—ã–µ —Ä–µ—á–∏"],
    hints:[
        "–ü—è—Ç–Ω–∞ –ø–æ—è–≤–ª—è—é—Ç—Å—è —Ç–∞–º, –≥–¥–µ —Ä–∞–Ω—å—à–µ –±—ã–ª–∞ –∫–æ–∂–∞.",
  "–û–Ω–∏ –Ω–µ –±–æ–ª—è—Ç, –Ω–æ –±—É–¥—Ç–æ —Å–º–æ—Ç—Ä—è—Ç.",
  "–ß–µ–º –¥–æ–ª—å—à–µ —Å–º–æ—Ç—Ä–∏—à—å, —Ç–µ–º –º–µ–Ω—å—à–µ —Ö–æ—á–µ—Ç—Å—è –∏—Ö —Ç—Ä–æ–≥–∞—Ç—å."
    ],
    weights:{ bloodletting: 1.3, demonology: 1.1, herbalism: 0.9, prayer: 0.8, hypnosis: 0.7, charms: 1.0, amputation: 0.3 }
  },
  {
    id:"glass_cough",
    name:"–°—Ç–µ–∫–ª—è–Ω–Ω—ã–π –∫–∞—à–µ–ª—å",
    rarity: RARITY.COMMON,
    symptoms:["–ö–∞—à–µ–ª—å","–°—É—Ö–æ—Å—Ç—å","–ì–æ–ª–æ–≤–Ω–∞—è –º—É—Ç—å"],
   cureBy: "herbalism",
  badBy: "amputation",
    hints:[
       "–ö–∞–∂–¥—ã–π –∫–∞—à–µ–ª—å –∑–≤—É—á–∏—Ç, –∫–∞–∫ —Ç—Ä–µ—Å–∫ —Ç–æ–Ω–∫–æ–≥–æ —Å—Ç–µ–∫–ª–∞.",
  "–ì—Ä—É–¥—å –∑–≤–µ–Ω–∏—Ç, –±—É–¥—Ç–æ –≤–Ω—É—Ç—Ä–∏ –ø—É—Å—Ç–∞—è –≤–∏—Ç—Ä–∏–Ω–∞.",
  "–ò–Ω–æ–≥–¥–∞ —Å—Ç—Ä–∞—à–Ω–æ –≤–¥–æ—Ö–Ω—É—Ç—å ‚Äî –≤–¥—Ä—É–≥ —á—Ç–æ-—Ç–æ —Ä–∞–∑–æ–±—å—ë—Ç—Å—è."
    ],
    weights:{ herbalism: 1.2, hypnosis: 1.0, prayer: 0.9, bloodletting: 0.7, charms: 0.8, demonology: 0.5, amputation: 0.1 }
  },
  {
    id:"holy_worms",
    name:"–°–≤—è—Ç—ã–µ —á–µ—Ä–≤–∏",
    rarity: RARITY.LEGENDARY,
    symptoms:["–®–µ–ø—á–µ—Ç –º–æ–ª–∏—Ç–≤—ã","–ü—É—Å—Ç–æ–π –≤–∑–≥–ª—è–¥","–ó—É–¥ –ø–æ–¥ –∫–æ–∂–µ–π","–°–≤–µ—Ç—è—â–∏–µ—Å—è –≥–ª–∏—Å—Ç—ã"],
    cureBy: "prayer",
  badBy: "bloodletting",
    hints:[
       "–¢–µ–ª–æ –±—É–¥—Ç–æ —Ö—Ä–∞–º, –Ω–æ –≤–Ω—É—Ç—Ä–∏ –∫—Ç–æ-—Ç–æ —à–µ–≤–µ–ª–∏—Ç—Å—è.",
  "–ò–Ω–æ–≥–¥–∞ –∫–∞–∂–µ—Ç—Å—è, —á—Ç–æ –º–æ–ª–∏—Ç–≤–∞ –≤–Ω—É—Ç—Ä–∏ –æ—Ç–≤–µ—á–∞–µ—Ç —ç—Ö–æ–º.",
  "–°–≤—è—Ç–æ—Å—Ç—å –æ—â—É—â–∞–µ—Ç—Å—è‚Ä¶ —Å–ª–∏—à–∫–æ–º –±—É–∫–≤–∞–ª—å–Ω–æ."
    ],
    weights:{ prayer: 1.3, demonology: 1.2, charms: 1.1, hypnosis: 0.9, herbalism: 0.7, bloodletting: 0.6, amputation: 0.4 }
  },
  {
    id:"bone_mold",
    name:"–ö–æ—Å—Ç—è–Ω–∞—è –ø–ª–µ—Å–µ–Ω—å",
    rarity: RARITY.RARE,
    symptoms:["–ë–æ–ª—å –≤ –∫–æ—Å—Ç—è—Ö","–ü–ª–µ—Å–µ–Ω—å –Ω–∞ –ø–æ–≤—è–∑–∫–∞—Ö","–°–∫—Ä–∏–ø –≤ —Å—É—Å—Ç–∞–≤–∞—Ö","–í–æ–Ω—å —Å—ã—Ä–æ—Å—Ç–∏"],
    cureBy: "amputation",
  badBy: "hypnosis",
    hints:[
      "–ü—Ä–∏ —Ö–æ–¥—å–±–µ —Å–∫—Ä–∏–ø–∏—Ç –∫–∞–∫ –¥–≤–µ—Ä—å.",
      "–ö–∞–∂–¥—ã–π —Å–≥–∏–± –≤—ã–∑—ã–≤–∞–µ—Ç –∫—Ä–∏–∫ –±–æ–ª–∏.",
      "–õ—É—á—à–µ —á–µ–≥–æ —Ç–æ –ª–∏—à–∏—Ç—å—Å—è, —á–µ–º —Ç–µ—Ä–ø–µ—Ç—å."
    ],
    weights:{ amputation: 1.2, herbalism: 0.9, bloodletting: 0.8, prayer: 0.8, demonology: 0.9, hypnosis: 0.6, charms: 0.7 }
  },
  // ===== NEW DISEASES (8 —à—Ç) =====

  {
    id:"ashen_tongue",
    name:"–ü–µ–ø–µ–ª—å–Ω—ã–π —è–∑—ã–∫",
    rarity: RARITY.COMMON,
    symptoms:["–Ø–∑—ã–∫ —Å–µ—Ä—ã–π","–ì–æ—Ä–µ—á—å –≤–æ —Ä—Ç—É","–ñ–∞–∂–¥–∞"],
    cureBy:"herbalism",
    badBy:"demonology",
    hints:[
      "–í–æ —Ä—Ç—É –±—É–¥—Ç–æ –∫–æ—Å—Ç—ë—Ä –¥–∞–≤–Ω–æ –ø–æ—Ç—É—Ö, –Ω–æ –¥—ã–º –æ—Å—Ç–∞–ª—Å—è.",
      "–°–ª–æ–≤–∞ –≤—ã—Ö–æ–¥—è—Ç —Å—É—Ö–∏–º–∏ –∏ –∫–æ–ª—é—á–∏–º–∏.",
      "–ó–∞–ø–∞—Ö –∑–¥–µ—Å—å —É–º–µ—Å—Ç–Ω–µ–µ, —á–µ–º –ø–∞—Ñ–æ—Å –∏ —Å–≤–µ—á–∏."
    ],
    weights:{ herbalism: 1.25, prayer: 0.9, bloodletting: 0.75, hypnosis: 0.95, charms: 0.95, demonology: 0.35, amputation: 0.2 }
  },

  {
    id:"bell_ringing",
    name:"–ó–≤–æ–Ω –≤ –∫–æ—Å—Ç—è—Ö",
    rarity: RARITY.RARE,
    symptoms:["–ó–≤–æ–Ω –≤ —É—à–∞—Ö","–î—Ä–æ–∂—å –≤ –ø–∞–ª—å—Ü–∞—Ö","–°–≤–µ—Ç —Ä–µ–∂–µ—Ç –≥–ª–∞–∑–∞"],
    cureBy:"hypnosis",
    badBy:"amputation",
    hints:[
      "–ë—É–¥—Ç–æ –∫–æ–ª–æ–∫–æ–ª –∑–≤–µ–Ω–∏—Ç –Ω–µ –≤ –±–∞—à–Ω–µ, –∞ –≤–Ω—É—Ç—Ä–∏.",
      "–ì–ª–∞–∑–∞ –∏—â—É—Ç —Ç–µ–Ω—å –¥–∞–∂–µ –ø—Ä–∏ —Å–≤–µ—Ç–µ.",
      "–¢—É—Ç –Ω–∞–¥–æ —É—Å–ø–æ–∫–æ–∏—Ç—å –≥–æ–ª–æ–≤—É, –∞ –Ω–µ –ø–∏–ª–∏—Ç—å —á–µ–ª–æ–≤–µ–∫–∞."
    ],
    weights:{ hypnosis: 1.25, charms: 1.05, prayer: 0.95, herbalism: 0.85, demonology: 0.9, bloodletting: 0.75, amputation: 0.25 }
  },

  {
    id:"ink_lungs",
    name:"–ß–µ—Ä–Ω–∏–ª—å–Ω—ã–µ –ª—ë–≥–∫–∏–µ",
    rarity: RARITY.RARE,
    symptoms:["–ö–∞—à–µ–ª—å —Ç—ë–º–Ω—ã–π","–¢—è–∂—ë–ª–æ–µ –¥—ã—Ö–∞–Ω–∏–µ","–ì–æ–ª–æ—Å —Ö—Ä–∏–ø–∏—Ç"],
    cureBy:"bloodletting",
    badBy:"herbalism",
    hints:[
      "–î—ã—Ö–∞–Ω–∏–µ –±—É–¥—Ç–æ –≤—è–∑–Ω–µ—Ç, –∫–∞–∫ –ø–µ—Ä–æ –≤ —á–µ—Ä–Ω–∏–ª–∞—Ö.",
      "–ì–æ–ª–æ—Å —Å—Ç–∞–ª –Ω–∏–∂–µ, —Å–ª–æ–≤–Ω–æ –∫—Ç–æ-—Ç–æ –µ–≥–æ —É—Ç–æ–ø–∏–ª.",
      "–ò–Ω–æ–≥–¥–∞ –ª–∏—à–Ω–µ–µ –Ω–∞–¥–æ‚Ä¶ –≤—ã–ø—É—Å—Ç–∏—Ç—å."
    ],
    weights:{ bloodletting: 1.25, prayer: 0.9, hypnosis: 0.85, demonology: 1.0, charms: 0.95, herbalism: 0.4, amputation: 0.25 }
  },

  {
    id:"saintly_static",
    name:"–°–≤—è—Ç–æ–µ —à—É—Ä—à–∞–Ω–∏–µ",
    rarity: RARITY.LEGENDARY,
    symptoms:["–®—ë–ø–æ—Ç –≤ —Ç–∏—à–∏–Ω–µ","–ú—É—Ä–∞—à–∫–∏ –±–µ–∑ —Ö–æ–ª–æ–¥–∞","–°–Ω—ã –∫–∞–∫ –ø—Ä–æ–ø–æ–≤–µ–¥—å"],
    cureBy:"prayer",
    badBy:"hypnosis",
    hints:[
      "–¢–∏—à–∏–Ω–∞ –≤–µ–¥—ë—Ç —Å–µ–±—è —Å–ª–∏—à–∫–æ–º –≥—Ä–æ–º–∫–æ.",
      "–°–Ω—ã –±—É–¥—Ç–æ –∫—Ç–æ-—Ç–æ –¥–∏–∫—Ç—É–µ—Ç —Å –∫–∞—Ñ–µ–¥—Ä—ã.",
      "–ó–¥–µ—Å—å –≤–∞–∂–Ω—ã —Å–ª–æ–≤–∞, –Ω–æ –Ω–µ –ª—é–±—ã–µ."
    ],
    weights:{ prayer: 1.3, charms: 1.15, demonology: 1.05, herbalism: 0.75, bloodletting: 0.65, hypnosis: 0.35, amputation: 0.3 }
  },

  {
    id:"candle_wax_skin",
    name:"–í–æ—Å–∫–æ–≤–∞—è –∫–æ–∂–∞",
    rarity: RARITY.COMMON,
    symptoms:["–ö–æ–∂–∞ –ª–∏–ø–∫–∞—è","–ë–ª–µ–¥–Ω–æ—Å—Ç—å","–û–∑–Ω–æ–±"],
    cureBy:"charms",
    badBy:"bloodletting",
    hints:[
      "–ö–æ–∂–∞ –±—É–¥—Ç–æ —Ä–µ—à–∏–ª–∞ —Å—Ç–∞—Ç—å —Å–≤–µ—á–æ–π.",
      "–•–æ–ª–æ–¥ –Ω–µ —Å–Ω–∞—Ä—É–∂–∏, —Ö–æ–ª–æ–¥ –ø–æ–¥ –∫–æ–∂–µ–π.",
      "–ò–Ω–æ–≥–¥–∞ –∑–Ω–∞–∫–∏ –ª–µ—á–∞—Ç –ª—É—á—à–µ –∂–µ–ª–µ–∑–∞."
    ],
    weights:{ charms: 1.25, herbalism: 0.95, prayer: 0.9, hypnosis: 0.8, demonology: 0.65, bloodletting: 0.45, amputation: 0.2 }
  },

  {
    id:"witch_mark_rot",
    name:"–ì–Ω–∏–ª—å –≤–µ–¥—å–º–∏–Ω–æ–≥–æ –∑–Ω–∞–∫–∞",
    rarity: RARITY.RARE,
    symptoms:["–ü—è—Ç–Ω–æ —Ä–∞—Å—Ç—ë—Ç","–ë–æ–ª—å –ª–æ–∫–∞–ª—å–Ω–æ","–ó–∞–ø–∞—Ö —Å—ã—Ä–æ—Å—Ç–∏"],
    cureBy:"amputation",
    badBy:"prayer",
    hints:[
      "–ü—Ä–æ–±–ª–µ–º–∞ –≤–µ–¥—ë—Ç —Å–µ–±—è —Ç–∞–∫, –±—É–¥—Ç–æ —É –Ω–µ—ë –µ—Å—Ç—å –≥—Ä–∞–Ω–∏—Ü—ã.",
      "–ó–∞–ø–∞—Ö –≥–æ–≤–æ—Ä–∏—Ç –≥—Ä–æ–º—á–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞.",
      "–ò–Ω–æ–≥–¥–∞ –¥–æ–±—Ä–æ—Ç–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç. –†–∞–±–æ—Ç–∞–µ—Ç —Ä–µ—à–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å."
    ],
    weights:{ amputation: 1.25, bloodletting: 0.95, herbalism: 0.8, demonology: 0.85, charms: 0.75, hypnosis: 0.7, prayer: 0.35 }
  },

  {
    id:"mirror_fever",
    name:"–ó–µ—Ä–∫–∞–ª—å–Ω–∞—è –≥–æ—Ä—è—á–∫–∞",
    rarity: RARITY.COMMON,
    symptoms:["–õ–∏—Ü–æ '–ø–ª—ã–≤—ë—Ç'","–ü—É—Ç–∞–µ—Ç –∏–º–µ–Ω–∞","–ñ–∞—Ä –≤–æ–ª–Ω–∞–º–∏","–°—Ç–µ–∫–ª—è–Ω–Ω—ã–µ –≥–ª–∞–∑–∞"],
    cureBy:"hypnosis",
    badBy:"demonology",
    hints:[
      "–ß–µ–ª–æ–≤–µ–∫ –±—É–¥—Ç–æ —Å–º–æ—Ç—Ä–∏—Ç –Ω–∞ –º–∏—Ä —á–µ—Ä–µ–∑ –∫—Ä–∏–≤–æ–µ —Å—Ç–µ–∫–ª–æ.",
      "–ò–º–µ–Ω–∞ —É—Å–∫–æ–ª—å–∑–∞—é—Ç, –∫–∞–∫ –æ—Ç—Ä–∞–∂–µ–Ω–∏—è –≤ –≤–æ–¥–µ.",
      "–ù–µ –∑–æ–≤–∏ –ª–∏—à–Ω–∏—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π. –¢—É—Ç –∏ —Ç–∞–∫ —Ç–µ—Å–Ω–æ."
    ],
    weights:{ hypnosis: 1.2, herbalism: 0.9, charms: 0.95, prayer: 0.85, bloodletting: 0.7, demonology: 0.3, amputation: 0.2 }
  },

  {
    id:"devils_contract",
    name:"–î—å—è–≤–æ–ª—å—Å–∫–∏–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç",
    rarity: RARITY.LEGENDARY,
    symptoms:["–¢–µ–Ω—å –∂–∏–≤—ë—Ç –æ—Ç–¥–µ–ª—å–Ω–æ","–°–º–µ—Ö –Ω–µ –∫ –º–µ—Å—Ç—É","–ì–ª–∞–∑–∞ '—á—É–∂–∏–µ'"],
    cureBy:"demonology",
    badBy:"herbalism",
    hints:[
      "–¢–µ–Ω—å —Ç–æ—Ä–≥—É–µ—Ç—Å—è. –≠—Ç–æ —É–∂–µ –¥–∏–∞–≥–Ω–æ–∑.",
      "–°–º–µ—Ö –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Ç–∞–º, –≥–¥–µ –µ–º—É –Ω–µ —Ä–∞–¥—ã.",
      "–ò–Ω–æ–≥–¥–∞, —á—Ç–æ–±—ã –≤—ã–≥–Ω–∞—Ç—å –≥–æ—Å—Ç—è, –Ω–∞–¥–æ –≥–æ–≤–æ—Ä–∏—Ç—å –Ω–∞ –µ–≥–æ —è–∑—ã–∫–µ."
    ],
    weights:{ demonology: 1.3, charms: 1.1, prayer: 0.9, hypnosis: 0.95, bloodletting: 0.65, herbalism: 0.35, amputation: 0.4 }
  },
];

const FIRST_NAMES = ["–ì–∞–Ω—Å","–ú–∞—Ä—Ç–∞","–ü–∞—Ö–æ–º","–í–∏–ª–ª–µ–º","–ò–≤–∞–Ω","–ó–∏–≥–º—É–Ω–¥","–õ—É–ø–∞","–Ø–Ω","–ê–≤–≥—É—Å—Ç","–ü—É–ø–∞","–ö–∞—Å–ø–∞—Ä","–°–∞–Ω—è","–ú–∏—Ö–∞–∏–ª","–ó–∞—Ä—É–±","–ö–∞—Å–ø–∞—Ä","–ü—É–ø–∞–∑–∞","–°–µ–º—ë–Ω","–§–∏–ª–∏–ø–ø"];
const FEMALE_FIRST_NAMES = new Set(["–ú–∞—Ä—Ç–∞","–§—Ä–∏–¥–∞","–ì—Ä–µ—Ç–∞","–ò–¥–∞","–õ–æ—Ç—Ç–∞","–ó—É—Ö—Ä–∞","–°–∞–Ω–∏–Ω–∞","–ú–∞—Ä–∏—è","–î–∞–∑–¥—Ä–∞–ø–µ—Ä–º–∞","–ú–∏—Ä–∏—è–º","–°—Ç—Ä—ë–º–∫–∞"]);  
const LAST_NAMES  = ["–°–æ–ø–ª–∏–≤—ã–π","–°–∫–≤–æ–∑–Ω—è–∫","–ù–µ–≤–µ–∑—É—á–∏–π","–®–∞—Ç–∫–∏–π","–ö—Ä–∏–ø–æ–≤—ã–π","–ß–µ—à—É–π—á–∞—Ç—ã–π","–ö–∏—Å–ª—ã–π","–ë–ª–µ–¥–Ω—ã–π","–°–∫—Ä–∏–ø—É—á–∏–π","–ü–ª–µ—Å–Ω–µ–≤—ã–π","–°—É–º—Ä–∞—á–Ω—ã–π","–£–≥—Ä—é–º—ã–π","–õ—É–ø—É","–ì–Ω–æ–π–Ω—ã–π","–ü–∞—Ö—É—á–∏–π","–ú–∞–º–∏–Ω","–ì–Ω–æ–π–Ω—ã–π"];

const DOCTOR_POOL = [
  // ===== existing (—Å–ª–µ–≥–∫–∞ —Ä–∞—Å—à–∏—Ä–∏–º –¥–∞–Ω–Ω—ã–º–∏) =====
  { id:"doc_herb",  name:"–î–æ–∫—Ç–æ—Ä –¢—Ä–∞–≤–Ω–∏–∫",   title:"–ó–Ω–∞—Ö–∞—Ä—å —Å –¥–∏–ø–ª–æ–º–æ–º –Ω–∞ –ª–∏—Å—Ç–∫–µ –¥—É–±–∞", rarity:RARITY.RARE,
    methods:["herbalism","charms"], persona:"confident",
   
    likes:["herbalism"], hates:["amputation"], portrait:"img/doctors/doc_herb.png" ,
   fatigue: 0,      // 0‚Äì100
fatigueGain: 15, // —Å–∫–æ–ª—å–∫–æ —É—Å—Ç–∞–ª–æ—Å—Ç–∏ –∑–∞ —Å–º–µ–Ω—É
    bio:"–ü–∞—Ö–Ω–µ—Ç –∞–ø—Ç–µ–∫–æ–π –∏ –ø—Ä–µ–≤–æ—Å—Ö–æ–¥—Å—Ç–≤–æ–º. –õ–µ—á–∏—Ç –ª–∏—Å—Ç—å—è–º–∏, —Å–ª–æ–≤–∞–º–∏, —Å–ª—é–Ω—è–º–∏ –∏ –ø–∞—Å—Å–∏–≤–Ω–æ–π –∞–≥—Ä–µ—Å—Å–∏–µ–π."
   
   
  },
  { id:"doc_blood", name:"–î–æ–∫—Ç–æ—Ä –ü–∏—è–≤–∫–∞",    title:"–§–∞–Ω–∞—Ç –∫—Ä–∞—Å–Ω–æ–≥–æ –∏ –±–µ–ª–æ–≥–æ", rarity:RARITY.COMMON,
    methods:["bloodletting"], persona:"fanatic",
    likes:["bloodletting"], hates:["hypnosis"], portrait:"img/doctors/doc_blood.png",
   fatigue: 0,      // 0‚Äì100
fatigueGain: 15, 
    bio:"–°—á–∏—Ç–∞–µ—Ç, —á—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞ –≤—Å–µ–≥–¥–∞ –≤ –ª–∏—à–Ω–µ–π –∫—Ä–æ–≤–∏. –ò–Ω–æ–≥–¥–∞ –æ–Ω –ø—Ä–∞–≤. –ò–Ω–æ–≥–¥–∞ –ø–∞—Ü–∏–µ–Ω—Ç –ø—Ä–æ—Å—Ç–æ –∫–æ–Ω—á–∞–µ—Ç—Å—è."
  },
  { id:"doc_priest",name:"–û—Ç–µ—Ü –ö–∞–¥–∏–ª–æ",      title:"–°–≤—è—â–µ–Ω–Ω–∏–∫-–ø—Ä–∞–∫—Ç–∏–∫", rarity:RARITY.RARE,
    methods:["prayer","charms"], persona:"confident",
    likes:["prayer"], hates:["demonology"], portrait:"img/doctors/doc_priest.png",
   fatigue: 0,      // 0‚Äì100
fatigueGain: 15, 
    bio:"–õ–µ—á–∏—Ç –º–æ–ª–∏—Ç–≤–æ–π, –¥—ã–º–æ–º –∏ –º–æ—Ä–∞–ª—å–Ω—ã–º –¥–∞–≤–ª–µ–Ω–∏–µ–º. –ò–Ω–æ–≥–¥–∞ –ø–æ–º–æ–≥–∞–µ—Ç. –ò–Ω–æ–≥–¥–∞ —Ç–æ–ª—å–∫–æ –µ–º—É.–°–∞–º —Å–≤–æ–µ–≥–æ —Ä–æ–¥–∞ –≤—Ä–∞—á"
  },
  { id:"doc_demo",  name:"–ú–∞–≥ –ü–µ–ø–µ–ª",        title:"–Æ—Ä–∏—Å—Ç –ø–æ –∞–¥—É", rarity:RARITY.LEGENDARY,
    methods:["demonology","hypnosis","charms"], persona:"trickster",
    likes:["demonology"], hates:["herbalism"], portrait:"img/doctors/doc_demo.png",
   fatigue: 0,      // 0‚Äì100
fatigueGain: 15, 
    bio:"–û–±–µ—â–∞–µ—Ç '–±—ã—Å—Ç—Ä–æ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ'. –í –¥–æ–≥–æ–≤–æ—Ä–µ –º–µ–ª–∫–∏–º —à—Ä–∏—Ñ—Ç–æ–º: '–≤–æ–∑–º–æ–∂–Ω–æ, –Ω–µ –≤–∞–º'."
  },
  { id:"doc_amput", name:"–ú–∞—Å—Ç–µ—Ä –ü–∏–ª–∞",      title:"–•–∏—Ä—É—Ä–≥ –±–µ–∑ —Å–∞–Ω—Ç–∏–º–µ–Ω—Ç–æ–≤ –∏ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è", rarity:RARITY.RARE,
    methods:["amputation","bloodletting"], persona:"cold",
    likes:["amputation"], hates:["prayer"], portrait:"img/doctors/doc_amput.png",
   fatigue: 0,      // 0‚Äì100
fatigueGain: 15, 
    bio:"–£–≤–µ—Ä–µ–Ω, —á—Ç–æ –ª–∏—à–Ω–µ–µ –º–µ—à–∞–µ—Ç –∂–∏—Ç—å. –£ –Ω–µ–≥–æ –µ—Å—Ç—å –ø–∏–ª–∞ –∏ –∞—Ä–≥—É–º–µ–Ω—Ç—ã, –∞ —É –≤–∞—Å –ª–∏—à–Ω–∏–µ –∑–∞–ø—á–∞—Å—Ç–∏"
  },
  { id:"doc_hypno", name:"–ì–∏–ø–Ω–æ—Ç–∏–∑—ë—Ä –ù–∏—Ç–∫–∞", title:"–ü—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–∏—è –¥–æ –∏–∑–æ–±—Ä–µ—Ç–µ–Ω–∏—è –ø—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–∏–∏", rarity:RARITY.COMMON,
    methods:["hypnosis"], persona:"uncertain",
    likes:["hypnosis"], hates:["bloodletting"], portrait:"img/doctors/doc_hypno.png",
   fatigue: 0,      // 0‚Äì100
fatigueGain: 15, 
    bio:"–ì–æ–≤–æ—Ä–∏—Ç —Ç–∏—Ö–æ(–Ω–∞ —É—à–∫–æ), —Å–º–æ—Ç—Ä–∏—Ç —Å—Ç—Ä–∞–Ω–Ω–æ, —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ. –ö–∞–∫ –∏ –∂–∏–∑–Ω—å."
  },

  // ===== NEW (–µ—â—ë 10 —à—Ç—É–∫) =====
  { id:"doc_leech", name:"–°–µ—Å—Ç—Ä–∞ –ñ–∞–ª–æ", title:"–ü–∏—è–≤–∫–∏, –±–∞–Ω–∫–∏, —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å,–≥—Ä—è–∑–Ω—ã–µ —Ä—É–∫–∏", rarity:RARITY.COMMON,
    methods:["bloodletting","herbalism"], persona:"confident",
    likes:["bloodletting"], hates:["demonology"], portrait:"img/doctors/doc_leech.png",
   fatigue: 0,      // 0‚Äì100
fatigueGain: 15, 
    bio:"–°—á–∏—Ç–∞–µ—Ç, —á—Ç–æ –±–∞–ª–∞–Ω—Å –∂–∏–¥–∫–æ—Å—Ç–µ–π —Ä–µ—à–∞–µ—Ç –≤—Å—ë. –ù–∞ –∂–∞–ª–æ–±—ã –æ—Ç–≤–µ—á–∞–µ—Ç –±–∞–Ω–∫–æ–π –∏–Ω–æ–≥–¥–∞ –ø–æ –≥–æ–ª–æ–≤–µ."
  },
  { id:"doc_candle", name:"–ú–∞—Ç—å –°–≤–µ—á–∞", title:"–ó–∞–≥–æ–≤–æ—Ä—ã –∏ –≤–æ—Å–∫–æ–≤—ã–µ –¥–∏–∞–≥–Ω–æ–∑—ã –∏ —Ñ–∏–≥—É—Ä–∫–∏", rarity:RARITY.RARE,
    methods:["charms","prayer"], persona:"confident",
    likes:["charms"], hates:["amputation"], portrait:"img/doctors/doc_candle.png",
   fatigue: 0,      // 0‚Äì100
fatigueGain: 15, 
    bio:"–õ–µ—á–∏—Ç —Å–∏–º–≤–æ–ª–∞–º–∏, —É–∑–ª–∞–º–∏ –∏ –∫–æ—Å—ã–º –≤–∑–≥–ª—è–¥–æ–º. –í –µ—ë –∫–æ–º–Ω–∞—Ç–µ –≤—Å–µ–≥–¥–∞ –ø–∞—Ö–Ω–µ—Ç –≤–æ—Å–∫–æ–º –∏ —Ç–∞–π–Ω–∞–º–∏ —É–±–æ—Ä–Ω–æ–π."
  },
  { id:"doc_bell", name:"–î–æ–∫—Ç–æ—Ä –ö–æ–ª–æ–∫–æ–ª", title:"–£—Å–ø–æ–∫–æ–∏—Ç –¥–∞–∂–µ —Å–º–µ—Ä—Ç—å", rarity:RARITY.RARE,
    methods:["hypnosis","charms"], persona:"cold",
    likes:["hypnosis"], hates:["bloodletting"], portrait:"img/doctors/doc_bell.png",
   fatigue: 0,      // 0‚Äì100
fatigueGain: 15, 
    bio:"–ï–≥–æ –≥–æ–ª–æ—Å —Ä–æ–≤–Ω—ã–π –∫–∞–∫ –ø—Ä–∏–≥–æ–≤–æ—Ä. –ü–∞—Ü–∏–µ–Ω—Ç—ã –ø–µ—Ä–µ—Å—Ç–∞—é—Ç –ø–∞–Ω–∏–∫–æ–≤–∞—Ç—å. –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ø–µ—Ä–µ—Å—Ç–∞—é—Ç –≤–æ–æ–±—â–µ."
  },
  { id:"doc_ash", name:"–ü—Ä–æ–≤–∏–∑–æ—Ä –°–∞–∂–∞", title:"–ê–ø—Ç–µ–∫–∞—Ä—å —Å –≥—Ä—è–∑–Ω–æ–π —Å–æ–≤–µ—Å—Ç—å—é —Ä—Ç–æ–º", rarity:RARITY.COMMON,
    methods:["herbalism","hypnosis"], persona:"trickster",
    likes:["herbalism"], hates:["prayer"], portrait:"img/doctors/doc_ash.png",
   fatigue: 0,      // 0‚Äì100
fatigueGain: 15, 
    bio:"–†–∞–∑–º–µ—à–∏–≤–∞–µ—Ç –Ω–∞—Å—Ç–æ–∏ —Ç–∞–∫, –±—É–¥—Ç–æ –≤–∞—Ä–∏—Ç —Å—É–¥—å–±—É. –ò–Ω–æ–≥–¥–∞ –º–æ–µ—Ç –≤ –Ω–∏—Ö –Ω–æ–≥–∏."
  },
  { id:"doc_sawbones", name:"–ö–æ—Å—Ç–æ–ø—Ä–∞–≤ –ì–≤–æ–∑–¥—å", title:"–†—É–∫–∏ –∫–∞–∫ —Ç–∏—Å–∫–∏, –Ω–µ –¥–∞–≤–∞–π –µ–º—É —Å–æ—Å–∫–∏", rarity:RARITY.COMMON,
    methods:["amputation","herbalism"], persona:"fanatic",
    likes:["amputation"], hates:["charms"], portrait:"img/doctors/doc_sawbones.png",
   fatigue: 0,      // 0‚Äì100
fatigueGain: 15, 
    bio:"–ù–µ–Ω–∞–≤–∏–¥–∏—Ç '—à–∞—Ä–ª–∞—Ç–∞–Ω—Å–∫–∏–µ —Å–≤–µ—á–∫–∏'. –í–µ—Ä–∏—Ç —Ç–æ–ª—å–∫–æ –≤ –∂–µ–ª–µ–∑–æ, –±–∏–Ω—Ç –∏ —Ö—Ä—É—Å—Ç."
  },
  { id:"doc_inquis", name:"–ò–Ω–∫–≤–∏–∑–∏—Ç–æ—Ä –ü–µ—á–∞—Ç—å", title:"–°–≤—è—Ç–æ—Å—Ç—å —Å –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–º", rarity:RARITY.LEGENDARY,
    methods:["prayer","hypnosis"], persona:"cold",
    likes:["prayer"], hates:["demonology"], portrait:"img/doctors/doc_inquis.png",
   fatigue: 0,      // 0‚Äì100
fatigueGain: 15, 
    bio:"–¢—Ä–µ–±—É–µ—Ç –ø–æ—Ä—è–¥–æ–∫, —á–∏—Å—Ç—ã–µ –æ—Ç—á—ë—Ç—ã –∏ —á–∏—Å—Ç—É—é –¥—É—à—É. –ù–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–∞—Ü–∏–µ–Ω—Ç–∞."
  },
  { id:"doc_grave", name:"–î–æ–∫—Ç–æ—Ä –ú–æ–≥–∏–ª—å–Ω–∏–∫", title:"–ü–∞—Ç–æ–ª–æ–≥–æ–∞–Ω–∞—Ç–æ–º –∑–∞—Ä–∞–Ω–µ–µ, –º–µ—Ä—Ç–≤—ã—Ö –ª—é–±–∏—Ç –±–æ–ª—å—à–µ", rarity:RARITY.RARE,
    methods:["bloodletting","charms"], persona:"uncertain",
    likes:["charms"], hates:["herbalism"], portrait:"img/doctors/doc_grave.png",
   fatigue: 0,      // 0‚Äì100
fatigueGain: 15, 
    bio:"–í—Å–µ–≥–¥–∞ –≥–æ—Ç–æ–≤ –∫ —Ö—É–¥—à–µ–º—É. –ò–Ω–æ–≥–¥–∞ —ç—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç. –ò–Ω–æ–≥–¥–∞ –ø—Ä–æ—Å—Ç–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —Ç–∞–∫–æ–µ."
  },
  { id:"doc_salt", name:"–°–æ–ª–µ–≤–∞—Ä –°–µ–¥–æ–π", title:"–õ–µ—á–∏—Ç '–ø—Ä–æ—Å—Ç—ã–º' –ü–∏—Ç–µ—Ä—Å–∫–∏–º–∏ —Å–æ–ª—è–º–∏", rarity:RARITY.COMMON,
    methods:["herbalism","prayer"], persona:"uncertain",
    likes:["herbalism"], hates:["hypnosis"], portrait:"img/doctors/doc_salt.png",
   fatigue: 0,      // 0‚Äì100
fatigueGain: 15, 
    bio:"–ì–æ–≤–æ—Ä–∏—Ç: '–Ω–∏—á–µ–≥–æ –ª–∏—à–Ω–µ–≥–æ'. –ü–æ—Ç–æ–º –¥–∞—ë—Ç —Å–æ–ª—å –∏ –º–æ–ª–∏—Ç–≤—É. –ò —É—Ö–æ–¥–∏—Ç, –ø–æ–∫–∞ —Ç—ã –Ω–µ –Ω–∞—á–∞–ª –º—ã—á–∞—Ç—å."
  },
  { id:"doc_night", name:"–ù–æ—á–Ω–æ–π –ü—Å–∞–ª–æ–º—â–∏–∫", title:"–ü–æ—ë—Ç, –ø–æ–∫–∞ –Ω–µ –ø–æ–ª–µ–≥—á–∞–µ—Ç", rarity:RARITY.RARE,
    methods:["prayer","demonology"], persona:"trickster",
    likes:["prayer"], hates:["bloodletting"], portrait:"img/doctors/doc_night.png",
   fatigue: 0,      // 0‚Äì100
fatigueGain: 15, 
    bio:"–£–º–µ–µ—Ç –∏ –º–æ–ª–∏—Ç—å—Å—è, –∏ —Å–ø–æ—Ä–∏—Ç—å —Å —Ç—å–º–æ–π, –∏ –ø–µ—Ç—å. –ü—É–≥–∞–µ—Ç –≤—Å–µ—Ö, –≤–∫–ª—é—á–∞—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç."
  },
  { id:"doc_worm", name:"–î–æ–∫—Ç–æ—Ä –ß–µ—Ä–≤—è–∫", title:"–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ '–∑—É–¥—É —Å—É–¥—å–±—ã'", rarity:RARITY.LEGENDARY,
    methods:["charms","demonology"], persona:"fanatic",
    likes:["demonology"], hates:["amputation"], portrait:"img/doctors/doc_worm.png",
   fatigue: 0,      // 0‚Äì100
fatigueGain: 15, 
    bio:"–°–º–æ—Ç—Ä–∏—Ç –Ω–∞ —Å–∏–º–ø—Ç–æ–º—ã –∫–∞–∫ –Ω–∞ –ø–æ—Å–ª–∞–Ω–∏—è. –ò–Ω–æ–≥–¥–∞ –ø–æ—Å–ª–∞–Ω–∏—è –æ—Ç–≤–µ—á–∞—é—Ç.–ò–Ω–æ–≥–¥–∞ –ø–æ—Å—ã–ª–∞–µ—Ç —Å–∞–º"
  },
];

function defaultFatigueGainByRarity(r){
  if(r === RARITY.LEGENDARY) return 10;
  if(r === RARITY.RARE) return 12;
  return 15; // common
}

// –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø–æ–ª—è —É—Å—Ç–∞–ª–æ—Å—Ç–∏ —É –≤—Å–µ—Ö –≤—Ä–∞—á–µ–π
function normalizeDoctorsFatigue(){
  for(const d of DOCTOR_POOL){
    if(d.fatigue == null) d.fatigue = 0;                 // 0..100
    if(d.fatigueGain == null) d.fatigueGain = defaultFatigueGainByRarity(d.rarity);
  }
}

function openResearch(){
  showScreen("research");
  renderResearch();
}
  

function rarityLabel(r){
  return r===RARITY.LEGENDARY ? "Legendary" : r===RARITY.RARE ? "Rare" : "Common";
}

    const WEEK_EVENTS = [
  // 1) –ù–ï–î–ï–õ–Ø –°–í–Ø–¢–û–ì–û –®–ï–°–¢–í–ò–Ø ‚Äî —Ç–æ–ª—å–∫–æ –º–æ–ª–∏—Ç–≤–∞
  {
    id: "holy_week",
    name: "–ù–µ–¥–µ–ª—è —Å–≤—è—Ç–æ–≥–æ —à–µ—Å—Ç–≤–∏—è",
    desc: "–¢–û–õ–¨–ö–û –ú–û–õ–ò–¢–í–ê —Å–ø–∞—Å–µ—Ç. –°–º–µ—Ä—Ç—å –≤ –æ—á–µ—Ä–µ–¥–∏ –Ω–µ –±—å—ë—Ç –ø–æ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏.",
    apply(){
      // –ù–∏—á–µ–≥–æ ‚Äú—Ü–∏—Ñ—Ä–æ–≤–æ–≥–æ‚Äù –Ω–µ –º–µ–Ω—è–µ–º, –ø—Ä–∞–≤–∏–ª–∞ –±—É–¥–µ–º –ø—Ä–æ–≤–µ—Ä—è—Ç—å –≤ UI/–ª–æ–≥–∏–∫–µ
    }
  },

  // 2) –ù–ï–î–ï–õ–Ø –ú–£–¢–ò ‚Äî –±–æ–ª—å—à–µ —Å–º–µ—Ä—Ç–µ–π, –±–æ–ª—å—à–µ –Ω–∞–≥—Ä–∞–¥ –∑–∞ —É—Å–ø–µ—Ö
  {
    id: "tainted_water",
    name: "–ù–µ–¥–µ–ª—è –º—É—Ç–∏",
    desc: "–ö—Ç–æ-—Ç–æ –æ—Ç—Ä–∞–≤–∏–ª –∫–æ–ª–æ–¥—Ü—ã. –°–º–µ—Ä—Ç–µ–π –±–æ–ª—å—à–µ, –Ω–æ –∑–∞ —É—Å–ø–µ—à–Ω–æ–µ –ª–µ—á–µ–Ω–∏–µ –±–æ–ª—å—à–µ –¥–µ–Ω–µ–≥ –∏ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏.",
    apply(){
      // —á–∏—Å–ª–∞ –Ω–µ —Ç—Ä–æ–≥–∞–µ–º –∑–¥–µ—Å—å, –Ω–∞–≥—Ä–∞–¥—ã/—Å–º–µ—Ä—Ç–∏ —É—Å–∏–ª–∏–º –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö
    }
  },

  // 3) –û–±—ã—á–Ω–∞—è: –∫—Ä—ã—Å—ã (–∫–∞–∫ –±—ã–ª–æ, –Ω–æ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å)
  {
    id: "rat_week",
    name: "–ù–µ–¥–µ–ª—è —á—É–º–Ω—ã—Ö –∫—Ä—ã—Å",
    desc: "+1 –∫ –æ—á–µ—Ä–µ–¥–∏, –ø–∞—Ü–∏–µ–Ω—Ç—ã –±—ã—Å—Ç—Ä–µ–µ —É—Ö–æ–¥—è—Ç, +–±–∏–æ –∑–∞ —Å–º–µ—Ä—Ç–∏ –≤ –æ—á–µ—Ä–µ–¥–∏.",
    apply(){
      state.maxQueue = Math.min(10, state.maxQueue + 1);
      state.baseWaitSec = Math.max(60, state.baseWaitSec - 25);
    }
  },

  // 4) –û–±—ã—á–Ω–∞—è: –º–∏–∞–∑–º—ã (–∫–∞–∫ –±—ã–ª–æ)
  {
    id: "fog_week",
    name: "–ù–µ–¥–µ–ª—è –≥—É—Å—Ç—ã—Ö –º–∏–∞–∑–º–æ–≤",
    desc: "–û—á–µ—Ä–µ–¥—å —Ç–µ—Ä–ø–µ–ª–∏–≤–µ–µ, –Ω–æ –ª–µ—á–∏—Ç—å –¥–æ–ª—å—à–µ.",
    apply(){
      state.baseWaitSec = Math.min(240, state.baseWaitSec + 25);
      state.baseTreatSecMin = Math.round(state.baseTreatSecMin * 1.10);
      state.baseTreatSecMax = Math.round(state.baseTreatSecMax * 1.10);
    }
  },

  // 5) –û–±—ã—á–Ω–∞—è: —è—Ä–º–∞—Ä–∫–∞ (–±–æ–ª—å—à–µ –¥–µ–Ω–µ–≥, –Ω–æ –æ—á–µ—Ä–µ–¥—å —Ç–æ–∫—Å–∏—á–Ω–µ–µ)
  {
    id: "fair_week",
    name: "–ù–µ–¥–µ–ª—è —è—Ä–º–∞—Ä–∫–∏",
    desc: "–ë–æ–ª—å—à–µ –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å –¥–µ–Ω—å–≥–∞–º–∏: –Ω–æ –æ—á–µ—Ä–µ–¥—å –º–µ–Ω—å—à–µ —Ç–µ—Ä–ø–∏—Ç.",
    apply(){
      state.baseWaitSec = Math.max(60, Math.round(state.baseWaitSec * 0.90));
      // –¥–µ–Ω—å–≥–∏ —É—Å–∏–ª–∏–º –≤ finishTreatmentToPending
    }
  },

  // 6) –û–±—ã—á–Ω–∞—è: –Ω–µ–¥–µ–ª—è —Ü–∏—Ä—é–ª—å–Ω–∏–∫–∞ (–ª–µ—á–∏—Ç—å –±—ã—Å—Ç—Ä–µ–µ, –Ω–æ —á–∞—â–µ ‚Äú—Å –ø—Ä–∏–∫–æ–ª–æ–º‚Äù)
  {
    id: "barber_week",
    name: "–ù–µ–¥–µ–ª—è —Ü–∏—Ä—é–ª—å–Ω–∏–∫–∞",
    desc: "–õ–µ—á–∏–º –±—ã—Å—Ç—Ä–µ–µ, –Ω–æ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã —á–∞—â–µ –¥–∞—é—Ç –æ—Å–ª–æ–∂–Ω–µ–Ω–∏—è.",
    apply(){
      state.baseTreatSecMin = Math.max(10, Math.round(state.baseTreatSecMin * 0.90));
      state.baseTreatSecMax = Math.max(15, Math.round(state.baseTreatSecMax * 0.90));
      // ‚Äú—á–∞—â–µ –æ—Å–ª–æ–∂–Ω–µ–Ω–∏—è‚Äù —É—Å–∏–ª–∏–º –≤ rollOutcome
    }
  },
];

  function getCurrentEvent(){
  const id = state?.calendar?.activeEventId;
  if(!id) return null;
  return WEEK_EVENTS.find(e => e.id === id) || null;
}

function pickNewWeekEvent(){
  const e = pick(WEEK_EVENTS);
  state.calendar.activeEventId = e.id;
}

/* =========================================================
   2) STATE
========================================================= */

function defaultState(){
  return {
    coins: 120,
    reputation: 0,
    biomaterial: 0,
    doctorsOwned: [], // id –≤—Ä–∞—á–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å —É –∏–≥—Ä–æ–∫–∞
unlocks: {
  wardB: false,
  staffScreen: true // —à—Ç–∞—Ç –≤–∫–ª—é—á–∏–º —Å—Ä–∞–∑—É, –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞ –±–µ–∑ –º–∞–≥–∞–∑–∏–Ω–∞
},
    
   shift: {
  active: false,          // ‚õîÔ∏è –≤–∞–∂–Ω–æ: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–º–µ–Ω–∞ –ù–ï –∏–¥—ë—Ç
  durationSec: 3*60*60,   // 3 —á–∞—Å–∞
  endAt: 0,               // 0 = –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Å–º–µ–Ω—ã
  cured: 0,
  deaths: 0,
  left: 0,
  breaksCount: 0
},

    perks: {
  labExtra: 0,        // +maxPerPatient
  labDiscount: 0,     // % —Å–∫–∏–¥–∫–∞ 0..50
  queueBuffer: 0,     // +maxQueue
  treatSpeed: 0       // % —É—Å–∫–æ—Ä–µ–Ω–∏–µ –ª–µ—á–µ–Ω–∏—è
},
    base: {
  maxQueue: 3,
  baseWaitSec: 120,
  baseTreatSecMin: 120,
  baseTreatSecMax: 300,
  baseLabCost: 15,
},
    maintenance: {
  active: false,
  text: "‚ö†Ô∏è –ò–¥—É—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã. –ú–æ–≥—É—Ç –±—ã—Ç—å —Å–±–æ–∏."
},

calendar: {
  week: 1,
  shiftInWeek: 1,      // 1..7
  activeEventId: null
},

rewards: {
  pending: null,   // –º–∞—Å—Å–∏–≤ –∏–∑ 3 –Ω–∞–≥—Ä–∞–¥
  chosenId: null   // –∫–∞–∫–∞—è –≤—ã–±—Ä–∞–Ω–∞
},

    wards: [
      makeWard("A"),
    ],

    duty: {
      slot1: pickRandomDoctorId(),
  slot2: null, // –≤—Ç–æ—Ä–æ–π —Å–ª–æ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –Ω–∞ —Å—Ç–∞—Ä—Ç–µ
    },

    lab: {
  costCoins: 15,      // —Ü–µ–Ω–∞ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
  maxPerPatient: 2    // —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –º–æ–∂–Ω–æ –∫–æ–≤—ã—Ä—è—Ç—å—Å—è –≤ –æ–¥–Ω–æ–º –ø–∞—Ü–∏–µ–Ω—Ç–µ
},
    

   patients: [],
queue: [],
selectedPatientId: null,

spawn: {
  nextAt: now()

},

pharmacy: {
  queue: [],          // —Å–ø–∏—Å–æ–∫ id –∫–ª–∏–µ–Ω—Ç–æ–≤
  clients: {},        // id -> client data
  nextAt: 0,          // –∫–æ–≥–¥–∞ –∂–¥–∞—Ç—å —Å–ª–µ–¥—É—é—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
  lastResult: null,   // –¥–ª—è —ç–∫—Ä–∞–Ω–∞ –∏—Ç–æ–≥–∞
  medsStudied: {},    // medId -> true
  medsStudying: null, // { id, endAt }
  served: 0,
  perfect: 0
},

flags: {
  showStarShop: false // –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π —Å—É–Ω–¥—É–∫ —Å–∫—Ä—ã—Ç
},

chests: {
  common: 0,
  legendary: 0
},

  };
}

  function initStartingDoctors(){
  if(state.doctorsOwned && state.doctorsOwned.length) return;

  const commons = DOCTOR_POOL.filter(d => d.rarity === RARITY.COMMON);
  shuffle(commons);

  state.doctorsOwned = commons.slice(0,3).map(d => d.id);

  // –ø–µ—Ä–≤—ã–π —Å—Ä–∞–∑—É –Ω–∞ –¥–µ–∂—É—Ä—Å—Ç–≤–æ
  state.duty.slot1 = state.doctorsOwned[0];
}

function makeWard(letter){
  return {
    id: "ward_"+letter,
    name: "–ü–∞–ª–∞—Ç–∞ "+letter,
    level: 1,

    // —Å—Ç–∞—Ç—ã (—Å –∫–∞–ø–∞–º–∏)
    comfort: 1,
    cleanliness: 1,
    ventilation: 1,
    light: 1,

    // –∫–∞–ø—ã
    capComfort: 6,
    capCleanliness: 6,
    capVentilation: 6,
    capLight: 6,

    // –∑–∞–Ω—è—Ç–æ—Å—Ç—å
    bedsMax: 2,          // —Å—Ç–∞—Ä—Ç 2 –∫–æ–π–∫–∏
    patients: [],        // –º–∞—Å—Å–∏–≤ patientId
    pendingResults: {},  // patientId -> result (–∏–ª–∏ null)

    broken: { },
  };
}


function loadState(){
  try{
    const raw = localStorage.getItem(LS_STATE);
    if(!raw) return defaultState();

    const s = JSON.parse(raw);

    // –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ —Å–ª—É—á–∞–π —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π
    if(s.coins==null) s.coins=0;
    if(s.reputation==null) s.reputation=0;
    if(s.biomaterial==null) s.biomaterial=0;

    if(!s.wards || !Array.isArray(s.wards)) s.wards = [makeWard("A")];
    if(!Array.isArray(s.queue)) s.queue = [];
    if(!Array.isArray(s.patients)) s.patients = [];
    if(!Array.isArray(s.doctorsOwned)) s.doctorsOwned = [];

    if(!s.duty) s.duty={slot1:pickRandomDoctorId(), slot2:pickRandomDoctorId(true)};
    if(!s.maxQueue) s.maxQueue=6;
    if(!s.baseWaitSec) s.baseWaitSec=120;
    if(!s.baseTreatSecMin) s.baseTreatSecMin=120;
    if(!s.baseTreatSecMax) s.baseTreatSecMax=300;

    if(!s.lab) s.lab = { costCoins: 15, maxPerPatient: 2 };
    if(s.lab.costCoins==null) s.lab.costCoins = 15;
    if(s.lab.maxPerPatient==null) s.lab.maxPerPatient = 2;

    if(!s.perks) s.perks = { labExtra:0, labDiscount:0, queueBuffer:0, treatSpeed:0 };

    // calendar migrate
    if(!s.calendar) s.calendar = { week:1, shiftInWeek:1, activeEventId:null };
    if(!s.calendar.week) s.calendar.week = 1;
    if(!s.calendar.shiftInWeek) s.calendar.shiftInWeek = 1;
    if(s.calendar.activeEventId === undefined) s.calendar.activeEventId = null;

    // base migrate
    if(!s.base) s.base = { maxQueue:6, baseWaitSec:120, baseTreatSecMin:120, baseTreatSecMax:300, baseLabCost:15 };
    if(s.base.maxQueue==null) s.base.maxQueue = 6;
    if(s.base.baseWaitSec==null) s.base.baseWaitSec = 120;
    if(s.base.baseTreatSecMin==null) s.base.baseTreatSecMin = 120;
    if(s.base.baseTreatSecMax==null) s.base.baseTreatSecMax = 300;
    if(s.base.baseLabCost==null) s.base.baseLabCost = 15;

   // –º–∏–≥—Ä–∞—Ü–∏—è –∞–ø–≥—Ä–µ–π–¥–æ–≤ –æ—á–µ—Ä–µ–¥–∏
    if(!s.queueUpg) s.queueUpg = {};
    if(!Number.isFinite(s.queueUpg.capLvl)) s.queueUpg.capLvl = 0;   // 0..3
    if(!Number.isFinite(s.queueUpg.waitLvl)) s.queueUpg.waitLvl = 0; // 0..‚àû (–Ω–æ –º—ã –æ–≥—Ä–∞–Ω–∏—á–∏–º)

    // –º–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑–æ–≤–æ–π –æ—á–µ—Ä–µ–¥–∏ (–¥–ª—è —Å—Ç–∞—Ä—ã—Ö —Å–µ–π–≤–æ–≤)
    if(!s.base) s.base = {};
    if(!Number.isFinite(s.base.maxQueue)) s.base.maxQueue = 3;
    s.base.maxQueue = Math.min(s.base.maxQueue, 3);

    if(!s.flags) s.flags = { showStarShop:false };
    if(typeof s.flags.showStarShop !== "boolean") s.flags.showStarShop = false;

    if(!s.chests) s.chests = { common:0, legendary:0 };
    if(s.chests.common == null) s.chests.common = 0;
    if(s.chests.legendary == null) s.chests.legendary = 0;

    if(!s.rewards) s.rewards = { pending:null, chosenId:null };
    if(s.rewards.chosenId === undefined) s.rewards.chosenId = null;

    // --- migrate pharmacy ---
s.pharmacy = s.pharmacy || {};
s.pharmacy.queue = s.pharmacy.queue || [];
s.pharmacy.clients = s.pharmacy.clients || {};
s.pharmacy.medsStudied = s.pharmacy.medsStudied || {};
s.pharmacy.medsStudying = s.pharmacy.medsStudying || null;
s.pharmacy.nextAt = Number(s.pharmacy.nextAt || 0);
s.pharmacy.lastResult = s.pharmacy.lastResult || null;
s.pharmacy.served = Number(s.pharmacy.served || 0);
s.pharmacy.perfect = Number(s.pharmacy.perfect || 0);

    // –µ—Å–ª–∏ –≤ pending —Å—Ç–∞—Ä–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ ‚Äî —Å–±—Ä–æ—Å
    if(s.rewards?.pending && Array.isArray(s.rewards.pending)){
      const hasLegacyApply = s.rewards.pending.some(x => x && x.apply !== undefined);
      const missingFields = s.rewards.pending.some(x =>
        !x || x.type === undefined || x.title === undefined || x.desc === undefined || x.value === undefined
      );
      if(hasLegacyApply || missingFields){
        s.rewards.pending = null;
        s.rewards.chosenId = null;
      }
    }

    // shift migrate
    if(!s.shift){
      s.shift = {
        active: true,
        durationSec: 3*60*60,
        endAt: Date.now() + 3*60*60*1000,
        cured: 0,
        deaths: 0,
        left: 0
      };
    }
    if(typeof s.shift.active !== "boolean") s.shift.active = true;
    if(!s.shift.durationSec) s.shift.durationSec = 3*60*60;
    if(!s.shift.endAt) s.shift.endAt = Date.now() + s.shift.durationSec*1000;
    if(s.shift.cured==null) s.shift.cured = 0;
    if(s.shift.deaths==null) s.shift.deaths = 0;
    if(s.shift.left==null) s.shift.left = 0;

    if(!s.unlocks) s.unlocks = { wardB:false, staffScreen:true };
    if(typeof s.unlocks.wardB !== "boolean") s.unlocks.wardB = false;
    if(typeof s.unlocks.staffScreen !== "boolean") s.unlocks.staffScreen = true;

    // –µ—Å–ª–∏ —Ä–∞–Ω—å—à–µ –±—ã–ª–∞ –ø–∞–ª–∞—Ç–∞ B ‚Äî —Å—á–∏—Ç–∞–µ–º –∫—É–ø–ª–µ–Ω–Ω–æ–π
    if(Array.isArray(s.wards) && s.wards.some(w => w.id === "ward_B")){
      s.unlocks.wardB = true;

      // --- spawn migrate ---
if(!s.spawn) s.spawn = { nextAt: Date.now() };
if(!Number.isFinite(Number(s.spawn.nextAt))) s.spawn.nextAt = Date.now();

// maintenance migrate
if(!s.maintenance) s.maintenance = { active:false, text:"‚ö†Ô∏è –ò–¥—É—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã. –ú–æ–≥—É—Ç –±—ã—Ç—å —Å–±–æ–∏." };
if(typeof s.maintenance.active !== "boolean") s.maintenance.active = false;
if(typeof s.maintenance.text !== "string") s.maintenance.text = "‚ö†Ô∏è –ò–¥—É—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã. –ú–æ–≥—É—Ç –±—ã—Ç—å —Å–±–æ–∏.";

// –µ—Å–ª–∏ nextAt —É–ª–µ—Ç–µ–ª —Å–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ –≤ –±—É–¥—É—â–µ–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑-–∑–∞ –±–∞–≥–∞/—á–∞—Å–æ–≤)
if(Number(s.spawn.nextAt) > Date.now() + 30_000){
  s.spawn.nextAt = Date.now();
}
    }

    return s;
  } catch(e){
    return defaultState();
  }
}

 function ensureWardBrokenField(){
  if(!state) return;
  if(!Array.isArray(state.wards)) return;

  state.wards.forEach(w => {
    if(!w) return;
    if(!w.broken || typeof w.broken !== "object") w.broken = {};
  });
}

function maybeBreakWardUpgrade(w){
  if(!state.shift?.active) return;
  if(!w) return;

  // ‚úÖ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ª–∏–º–∏—Ç: –º–∞–∫—Å–∏–º—É–º 3 –ø–æ–ª–æ–º–∫–∏ –∑–∞ —Å–º–µ–Ω—É –Ω–∞ –≤—Å—é –∫–ª–∏–Ω–∏–∫—É
  if(typeof state.shift.breaksCount !== "number") state.shift.breaksCount = 0;
  if(state.shift.breaksCount >= 3) return;

  const t = now();

  // ‚úÖ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–µ: —Ä–∞–∑ –≤ 10‚Äì18 –º–∏–Ω—É—Ç –Ω–∞ –ø–∞–ª–∞—Ç—É
  const CHECK_MIN = 10 * 60 * 1000;
  const CHECK_MAX = 18 * 60 * 1000;

  if(!w.lastBreakCheck){
    w.lastBreakCheck = t + CHECK_MIN + Math.random()*(CHECK_MAX - CHECK_MIN);
    return;
  }

  if(t < w.lastBreakCheck) return;
  w.lastBreakCheck = t + CHECK_MIN + Math.random()*(CHECK_MAX - CHECK_MIN);

  // –µ—Å–ª–∏ —É–∂–µ —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–Ω–æ –≤ –ø–∞–ª–∞—Ç–µ ‚Äî –Ω–µ –ª–æ–º–∞–µ–º –µ—â—ë —Ä–∞–∑
  w.broken = w.broken || {};
  if(w.broken.comfort || w.broken.cleanliness || w.broken.ventilation || w.broken.light) return;

  // ‚úÖ —à–∞–Ω—Å —Å–∏–ª—å–Ω–æ –Ω–∏–∂–µ (–∏–Ω–∞—á–µ –ª–∏–º–∏—Ç 3 –±—É–¥–µ—Ç –≤—ã–±–∏–≤–∞—Ç—å—Å—è –∑–∞ –ø–µ—Ä–≤—ã–µ 20 –º–∏–Ω—É—Ç)
  const CHANCE = 0.06; // 6% –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É
  if(Math.random() >= CHANCE) return;

  // –≤—ã–±—Ä–∞—Ç—å —á—Ç–æ –ª–æ–º–∞–µ–º
  const pool = ["comfort","cleanliness","ventilation","light"];
  const which = pool[Math.floor(Math.random()*pool.length)];

  w.broken[which] = true;

  // ‚úÖ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å—á—ë—Ç—á–∏–∫ –ø–æ–ª–æ–º–æ–∫ —ç—Ç–æ–π —Å–º–µ–Ω—ã
  state.shift.breaksCount += 1;

  addLog(`‚ö†Ô∏è –í –ø–∞–ª–∞—Ç–µ —Å–ª–æ–º–∞–ª–æ—Å—å: ${which}. –ù—É–∂–Ω–æ —á–∏–Ω–∏—Ç—å.`);

  saveState();
}
  

function normalizeCalendar(){
  if(!state.calendar) state.calendar = { week:1, shiftInWeek:1, activeEventId:null };

  state.calendar.week = Number(state.calendar.week) || 1;
  state.calendar.shiftInWeek = Number(state.calendar.shiftInWeek) || 1;

  // –∑–∞—â–∏—Ç–∞: activeEventId –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π
  if(typeof state.calendar.activeEventId !== "string"){
    state.calendar.activeEventId = null;
  }

  if(!state.calendar.activeEventId){
    pickNewWeekEvent();
  }
}

  
function saveState(){
  // ‚úÖ –º–µ—Ç–∫–∞ ‚Äú–∫–æ–≥–¥–∞ —ç—Ç–æ—Ç state –±—ã–ª —Ä–µ–∞–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω‚Äù
  state._cloudAt = now();

  localStorage.setItem(LS_STATE, JSON.stringify(state));
  cloudSaveDebounced();
}

function tgInitData(){
  // 1) –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –ø—É—Ç—å (–µ—Å–ª–∏ SDK —Ä–∞–±–æ—Ç–∞–µ—Ç)
  const sdk = window.Telegram?.WebApp?.initData;
  if(sdk && typeof sdk === "string" && sdk.length > 0) return sdk;

  // 2) –∑–∞–ø–∞—Å–Ω–æ–π –ø—É—Ç—å: Telegram —á–∞—Å—Ç–æ –∫–ª–∞–¥—ë—Ç initData –≤ URL –∫–∞–∫ #tgWebAppData=...
  try{
    const hash = (location.hash || "").replace(/^#/, "");
    const h = new URLSearchParams(hash);
    const fromHash = h.get("tgWebAppData");
    if(fromHash) return decodeURIComponent(fromHash);

    // –∏–Ω–æ–≥–¥–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ query (?tgWebAppData=...)
    const q = new URLSearchParams(location.search || "");
    const fromQuery = q.get("tgWebAppData");
    if(fromQuery) return decodeURIComponent(fromQuery);
  }catch(e){
    console.log("tgInitData fallback parse failed", e);
  }

  return "";
}

async function cloudLoad(){
  const initData = tgInitData();
  if(!initData){
    console.log("cloudLoad: no initData");
    return null;
  }

  const r = await fetch("/api/save", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ initData })
  });

  const txt = await r.text().catch(()=> "");
  console.log("cloudLoad status:", r.status, txt.slice(0,200));

  if(!r.ok) return null;

  const data = JSON.parse(txt);
  return data?.state || null;
}

let cloudTimer = null;

function cloudSaveDebounced(){
  clearTimeout(cloudTimer);

  cloudTimer = setTimeout(async ()=>{
    const initData = tgInitData();
    if(!initData){
      console.log("cloudSave: no initData");
      return;
    }

    try{
      // ‚úÖ –º–µ—Ç–∫–∞ —Å–≤–µ–∂–µ—Å—Ç–∏ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
      state._cloudAt = now();

      const r = await fetch("/api/save", {
        method:"PUT",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ initData, state })
      });

      const txt = await r.text().catch(()=> "");
      console.log("cloudSave status:", r.status, txt.slice(0,200));

      if(!r.ok){
        console.log("cloud save failed:", r.status, txt.slice(0,200));
      }
    }catch(e){
      console.log("cloud save crashed", e);
    }
  }, 1200);
}

  window.__debugCloud = async function(){
  const init = tgInitData();
  const userId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id || null;

  const out = {
    href: location.href,
    host: location.host,
    initLen: init ? init.length : 0,
    userId,
    get: { status:null, body:null },
    put: { status:null, body:null }
  };

  // GET/LOAD (—É —Ç–µ–±—è POST load)
  try{
    const r = await fetch("/api/save", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ initData: init })
    });
    out.get.status = r.status;
    out.get.body = (await r.text()).slice(0, 300);
  }catch(e){
    out.get.status = "FETCH_FAIL";
    out.get.body = String(e);
  }

  // PUT/SAVE (–ø—Ä–æ–≤–µ—Ä–∏–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ)
  try{
    // –º–∞–ª–µ–Ω—å–∫–∏–π —Ç–µ—Å—Ç–æ–≤—ã–π –ø–∏–Ω–≥, –Ω–µ –ª–æ–º–∞–µ—Ç –∏–≥—Ä—É
    const testState = { test: true, at: Date.now() };

    const r = await fetch("/api/save", {
      method: "PUT",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ initData: init, state: testState })
    });
    out.put.status = r.status;
    out.put.body = (await r.text()).slice(0, 300);
  }catch(e){
    out.put.status = "FETCH_FAIL";
    out.put.body = String(e);
  }

  alert(JSON.stringify(out, null, 2));
};
/* =========================================================
   3) ACTIVE MAP (treatments in progress per ward)
========================================================= */

function getActiveMap(){
  try { return JSON.parse(localStorage.getItem(LS_ACTIVE) || "{}") || {}; }
  catch { return {}; }
}
function saveActiveMap(map){
  localStorage.setItem(LS_ACTIVE, JSON.stringify(map || {}));
}

  function normalizeActiveMap(){
  const map = getActiveMap();
  let changed = false;

  for(const wardId of Object.keys(map)){
    const v = map[wardId];
    if(!v) continue;

    // —Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç: {treatmentId, endAt}
    const looksOld =
      typeof v === "object" &&
      ("treatmentId" in v) &&
      ("endAt" in v) &&
      !Object.keys(v).some(k => k.startsWith("patient_")); // –≥—Ä—É–±–∞—è –∑–∞—â–∏—Ç–∞

    if(looksOld){
      // –º—ã –ù–ï –∑–Ω–∞–µ–º patientId, –ø–æ—ç—Ç–æ–º—É –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ –ø—Ä–æ—Å—Ç–æ –æ—á–∏—Å—Ç–∏—Ç—å —ç—Ç—É –ø–∞–ª–∞—Ç—É
      // (–∏–ª–∏ –º–æ–∂–Ω–æ –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è —É–≥–∞–¥–∞—Ç—å –ø–æ wards[].patients, –Ω–æ —ç—Ç–æ —É–∂–µ —Å–µ—Ä–∏–∞–ª)
      map[wardId] = {};
      changed = true;
    }
  }

  if(changed) saveActiveMap(map);
}

// –≤–µ—Ä–Ω—ë—Ç –æ–±—ä–µ–∫—Ç –ø–æ –ø–∞–ª–∞—Ç–µ: { [patientId]: {treatmentId,endAt} }
function getActiveWardMap(wardId){
  const map = getActiveMap();
  return map[wardId] || {};
}

function getActiveForPatient(wardId, patientId){
  const wardMap = getActiveWardMap(wardId);
  return wardMap[patientId] || null;
}

function setActiveForPatient(wardId, patientId, activeObj){
  const map = getActiveMap();
  const wardMap = map[wardId] || {};
  wardMap[patientId] = activeObj;
  map[wardId] = wardMap;
  saveActiveMap(map);
}

function clearActiveForPatient(wardId, patientId){
  const map = getActiveMap();
  const wardMap = map[wardId] || {};
  delete wardMap[patientId];
  map[wardId] = wardMap;
  saveActiveMap(map);
}

function anyActiveInWard(wardId){
  const wardMap = getActiveWardMap(wardId);
  return Object.keys(wardMap).length > 0;
}

// --- COMPAT (–ø–æ–∫–∞ —á–∏—Å—Ç–∏–º —Å—Ç–∞—Ä—ã–µ –≤—ã–∑–æ–≤—ã) ---
function getActiveForWard(wardId){
  const wardMap = getActiveWardMap(wardId);
  const pids = Object.keys(wardMap);
  if(pids.length === 0) return null;
  const pid = pids[0];
  const a = wardMap[pid];
  return { patientId: pid, ...a }; // {patientId, treatmentId, endAt}
}
function setActiveForWard(wardId, obj){
  // —Å—Ç–∞—Ä—ã–π –∫–æ–¥ –ø—ã—Ç–∞–ª—Å—è –ø–æ–ª–æ–∂–∏—Ç—å –æ–¥–∏–Ω active –Ω–∞ –ø–∞–ª–∞—Ç—É
  // –∫–ª–∞–¥—ë–º –µ–≥–æ –Ω–∞ –ø–∞—Ü–∏–µ–Ω—Ç–∞ obj.patientId
  if(!obj?.patientId) return;
  setActiveForPatient(wardId, obj.patientId, { treatmentId: obj.treatmentId, endAt: obj.endAt });
}
function clearActiveForWard(wardId){
  const map = getActiveMap();
  delete map[wardId];
  saveActiveMap(map);
}

function ensureShiftTimer(){
  // –µ—Å–ª–∏ shift –≤–æ–æ–±—â–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî —Å–æ–∑–¥–∞—ë–º (–ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫/–±–∏—Ç—ã–π —Å–µ–π–≤)
  if(!state.shift){
    state.shift = {
      active: true,
      durationSec: 3 * 60 * 60,  // 3 —á–∞—Å–∞
      endAt: now() + 3 * 60 * 60 * 1000
    };
    saveState();
    return;
  }

  // durationSec –º–æ–∂–µ—Ç –±—ã—Ç—å –∫—Ä–∏–≤—ã–º –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–π/—Å–µ–π–≤–æ–≤
  let dur = Number(state.shift.durationSec);
  if(!Number.isFinite(dur) || dur <= 0){
    dur = 3 * 60 * 60;
    state.shift.durationSec = dur;
  }

  let endAt = Number(state.shift.endAt);

  // ‚úÖ –ö–†–ò–¢–ò–ß–ù–´–ô –§–ò–ö–°:
  // –µ—Å–ª–∏ endAt –ø–æ—Ö–æ–∂ –Ω–∞ "—Å–µ–∫—É–Ω–¥—ã" (–Ω–∞–ø—Ä–∏–º–µ—Ä 1712345678), –∞ –Ω–µ "–º—Å" (1712345678000)
  // —Ç–æ —É–º–Ω–æ–∂–∞–µ–º –Ω–∞ 1000
  if(Number.isFinite(endAt) && endAt > 0 && endAt < 1e12){
    endAt = endAt * 1000;
    state.shift.endAt = endAt;
    saveState();
  }

  // –µ—Å–ª–∏ endAt –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç/–±–∏—Ç—ã–π ‚Äî —Å–æ–∑–¥–∞—ë–º –∑–∞–Ω–æ–≤–æ
  if(!Number.isFinite(endAt) || endAt <= 0){
    state.shift.endAt = now() + Number(state.shift.durationSec) * 1000;
    saveState();
  }
}

/* =========================================================
   4) HELPERS
========================================================= */

  function costHtml(cost){
  if(!cost) return "";
  const parts = [];

  if(cost.coins){
    parts.push(`<span class="costPill"><img src="icons/topbar/icon_coins.png" alt="">${cost.coins}</span>`);
  }
  if(cost.reputation){
    parts.push(`<span class="costPill"><img src="icons/topbar/icon_rep.png" alt="">${cost.reputation}</span>`);
  }
  if(cost.biomaterial){
    parts.push(`<span class="costPill"><img src="icons/topbar/icon_bio.png" alt="">${cost.biomaterial}</span>`);
  }

  return `<div class="costLine">${parts.join("")}</div>`;
}

function randInt(a,b){ return Math.floor(a + Math.random()*(b-a+1)); }
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

function repCoinsMultiplier(rep){
  rep = Number(rep || 0);

  if(rep < -10) return 0.80;
  if(rep < 10)  return 1.00;
  if(rep < 25)  return 1.20;
  if(rep < 50)  return 1.50;
  if(rep < 70)  return 1.70;
  if(rep < 90)  return 1.90;
  return 2.00;
}

function rewardIcon(type){
  if(type === "coins") return `<img class="rewardIcon" src="icons/topbar/icon_coins.png" alt="">`;
  if(type === "rep")   return `<img class="rewardIcon" src="icons/topbar/icon_rep.png" alt="">`;
  if(type === "bio")   return `<img class="rewardIcon" src="icons/topbar/icon_bio.png" alt="">`;
  return "";
}

function renderWardUpgradeBtn(w, stat, title, hint){
  const can = canUpgrade(w, stat);
  const cost = can ? upgradeCost(w, stat) : "MAX";

  return `
    <div
      class="wardUpgrade ${can ? "" : "disabled"}"
      onclick="${can ? `upgradeWardStat('${w.id}','${stat}')` : ""}"
    >
      <img
        src="img/stats/${stat}.png"
        class="wardIconStat"
        alt=""
      >
      <div class="wardUpgradeText">
        <div class="wardUpgradeTitle">${title} +1</div>
        <div class="wardUpgradeSub">${hint} ‚Ä¢ ${cost}</div>
      </div>
    </div>
  `;
}

function reduceDoctorFatigue(docId, amount){
  const d = getDoctorById(docId);
  if(!d) return false;
  const before = Number(d.fatigue || 0);
  d.fatigue = clamp(before - Number(amount || 0), 0, 100);
  return d.fatigue !== before;
}

function reduceAllDoctorsFatigue(amount, onlyNonDuty=false){
  const dutyIds = new Set(dutyDoctors().filter(Boolean).map(d=>d.id));
  let changed = 0;

  for(const d of DOCTOR_POOL){
    if(onlyNonDuty && dutyIds.has(d.id)) continue;
    const before = Number(d.fatigue || 0);
    d.fatigue = clamp(before - Number(amount || 0), 0, 100);
    if(d.fatigue !== before) changed++;
  }
  return changed;
}

function weightedPick(items){
  const total = items.reduce((s,x)=>s + (x.weight||1), 0);
  let r = Math.random() * total;
  for(const it of items){
    r -= (it.weight||1);
    if(r <= 0) return it;
  }
  return items[items.length-1];
}

function randBetween(a,b){
  a = Number(a); b = Number(b);
  return Math.floor(a + Math.random() * (b - a + 1));
}

function applyChestLoot(loot){
  switch(loot.type){
    case "coins":
      state.coins += randBetween(loot.min, loot.max);
      break;
    case "bio":
      state.biomaterial = (state.biomaterial||0) + randBetween(loot.min, loot.max);
      break;
    case "rep":
      state.reputation = (state.reputation||0) + randBetween(loot.min, loot.max);
      break;

    // —Ç–≤–æ–∏ —Ç–æ–∫–µ–Ω—ã –æ—Ç–¥—ã—Ö–∞ –∏–∑ –º–∞–≥–∞–∑–∏–Ω–∞
    case "rest_small":
      state._shopRestToken = (state._shopRestToken || 0) + (loot.value||1);
      break;
    case "rest_big":
      state._shopRestTokenBig = (state._shopRestTokenBig || 0) + (loot.value||1);
      break;

    case "perk_treatSpeed":
      state.perks.treatSpeed = Math.min(40, (state.perks.treatSpeed||0) + (loot.value||10));
      break;

    // –±—É–¥—É—â–∏–µ –∫–µ–π—Å—ã
    case "perk_labExtra":
      state.perks.labExtra = Math.min(2, (state.perks.labExtra||0) + (loot.value||1));
      break;
    case "perk_queueBuffer":
      state.perks.queueBuffer = Math.min(4, (state.perks.queueBuffer||0) + (loot.value||1));
      break;
  }
}

  function lootTitleRu(loot){
  switch(loot.type){
    case "coins": return `üí∞ –ú–æ–Ω–µ—Ç—ã (${loot.min}‚Äì${loot.max})`;
    case "bio":   return `üß´ –ë–∏–æ–º–∞—Ç–µ—Ä–∏–∞–ª (${loot.min}‚Äì${loot.max})`;
    case "rep":   return `‚≠ê –†–µ–ø—É—Ç–∞—Ü–∏—è (${loot.min}‚Äì${loot.max})`;

    case "rest_small": return `ü´ñ –û—Ç–≤–∞—Ä –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∞ (x${loot.value||1})`;
    case "rest_big":   return `üõå –í—ã—Ö–æ–¥–Ω–æ–π –ø–æ –ø—Ä–∏–∫–∞–∑—É (x${loot.value||1})`;

    case "perk_treatSpeed": return `üõèÔ∏è –°–∫–æ—Ä–æ—Å—Ç—å –ª–µ—á–µ–Ω–∏—è +${loot.value||10}%`;
    case "perk_labExtra":   return `üî¨ –õ–∏–º–∏—Ç –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏ +${loot.value||1}`;
    case "perk_queueBuffer":return `üìã –û—á–µ—Ä–µ–¥—å +${loot.value||1}`;

    case "doctor_unlock":   return `üßë‚Äç‚öïÔ∏è –ù–æ–≤—ã–π –≤—Ä–∞—á (—Å–∫–æ—Ä–æ)`;
    default: return `üé≤ –ù–∞–≥—Ä–∞–¥–∞: ${String(loot.type)}`;
  }
}

function lootApplyTextRu(loot){
  switch(loot.type){

    case "coins": {
      const n = randBetween(loot.min, loot.max);
      state.coins += n;
      return {
        title: "üí∞ –ú–æ–Ω–µ—Ç—ã",
        text: `–ü–æ–ª—É—á–µ–Ω–æ: <b>+${n}</b> –º–æ–Ω–µ—Ç`,
        hint: "–î–µ–Ω—å–≥–∏ –Ω–µ –ø–∞—Ö–Ω—É—Ç. –ò–Ω–æ–≥–¥–∞ –ø–∞—Ö–Ω—É—Ç –∫—Ä–æ–≤—å—é."
      };
    }

    case "bio": {
      const n = randBetween(loot.min, loot.max);
      state.biomaterial = (state.biomaterial||0) + n;
      return {
        title: "üß´ –ë–∏–æ–º–∞—Ç–µ—Ä–∏–∞–ª",
        text: `–ü–æ–ª—É—á–µ–Ω–æ: <b>+${n}</b> –±–∏–æ–º–∞—Ç–µ—Ä–∏–∞–ª–∞`,
        hint: "–ù–∞—É–∫–∞ –æ–¥–æ–±—Ä—è–µ—Ç. –ú–æ—Ä–∞–ª—å ‚Äî –Ω–µ –≤—Å–µ–≥–¥–∞."
      };
    }

    case "rep": {
      const n = randBetween(loot.min, loot.max);
      state.reputation = (state.reputation||0) + n;
      return {
        title: "‚≠ê –†–µ–ø—É—Ç–∞—Ü–∏—è",
        text: `–ü–æ–ª—É—á–µ–Ω–æ: <b>+${n}</b> —Ä–µ–ø—É—Ç–∞—Ü–∏–∏`,
        hint: "–õ—é–¥–∏ –ø–æ–∫–∞ –≤–µ—Ä—è—Ç, —á—Ç–æ —Ç—ã –≤—Ä–∞—á."
      };
    }

    case "rest_small":
      state._shopRestToken = (state._shopRestToken || 0) + (loot.value||1);
      return {
        title: "ü´ñ –û—Ç–≤–∞—Ä –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∞",
        text: `–ü–æ–ª—É—á–µ–Ω–æ: <b>x${loot.value||1}</b>`,
        hint: "–ì–æ—Ä—å–∫–æ, –Ω–æ –±–æ–¥—Ä–∏—Ç."
      };

    case "rest_big":
      state._shopRestTokenBig = (state._shopRestTokenBig || 0) + (loot.value||1);
      return {
        title: "üõå –í—ã—Ö–æ–¥–Ω–æ–π –ø–æ –ø—Ä–∏–∫–∞–∑—É",
        text: `–ü–æ–ª—É—á–µ–Ω–æ: <b>x${loot.value||1}</b>`,
        hint: "–†–µ–¥–∫–∞—è —Ä–æ—Å–∫–æ—à—å."
      };

    case "perk_treatSpeed":
      state.perks.treatSpeed = Math.min(40, (state.perks.treatSpeed||0) + (loot.value||10));
      return {
        title: "üõèÔ∏è –£–ª—É—á—à–µ–Ω–∏–µ –∫–æ–µ–∫",
        text: `–°–∫–æ—Ä–æ—Å—Ç—å –ª–µ—á–µ–Ω–∏—è: <b>+${loot.value||10}%</b>`,
        hint: "–ü–∞—Ü–∏–µ–Ω—Ç—ã —Å—Ç—Ä–∞–¥–∞—é—Ç –±—ã—Å—Ç—Ä–µ–µ."
      };

    case "doctor_unlock":
      return grantDoctorUnlock(loot);

    default:
      return {
        title: "üé≤ –ù–∞–≥—Ä–∞–¥–∞",
        text: "–ü—Ä–æ–∏–∑–æ—à–ª–æ –Ω–µ—á—Ç–æ —Å—Ç—Ä–∞–Ω–Ω–æ–µ.",
        hint: "–õ—É—á—à–µ –Ω–µ –∑–Ω–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π."
      };
  }
}

  function ownedDoctorIdsSet(){
  return new Set((state.doctorsOwned || []).filter(Boolean));
}

function pickDoctorForUnlock(rarityRule){
  const owned = ownedDoctorIdsSet();

  // –Ω–µ –≤—ã–¥–∞—ë–º –¥–µ–∂—É—Ä–Ω—ã—Ö/—É–∂–µ –∫—É–ø–ª–µ–Ω–Ω—ã—Ö. –¢–æ–ª—å–∫–æ –Ω–æ–≤—ã—Ö.
  let pool = DOCTOR_POOL.filter(d => !owned.has(d.id));

  if(rarityRule === "rare_plus"){
    pool = pool.filter(d => d.rarity === RARITY.RARE || d.rarity === RARITY.LEGENDARY);
  } else if(rarityRule === "legendary_only"){
    pool = pool.filter(d => d.rarity === RARITY.LEGENDARY);
  } else if(rarityRule === "common_only"){
    pool = pool.filter(d => d.rarity === RARITY.COMMON);
  } 
  // –∏–Ω–∞—á–µ "any" = –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞

  if(!pool.length) return null;
  return pick(pool);
}

function grantDoctorUnlock(loot){
  const rule = loot?.rarity || "any";
  const doc = pickDoctorForUnlock(rule);

  if(!doc){
    // –µ—Å–ª–∏ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å –Ω–æ–≤—ã—Ö –¥–æ–∫—Ç–æ—Ä–æ–≤ –ø–æ–¥ –ø—Ä–∞–≤–∏–ª–æ ‚Äî –¥–∞–¥–∏–º –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—é –º–æ–Ω–µ—Ç–∞–º–∏
    const comp = 120;
    state.coins += comp;
    return {
      kind: "comp",
      title: "üßë‚Äç‚öïÔ∏è –î–æ–∫—Ç–æ—Ä –Ω–µ –Ω–∞—à—ë–ª—Å—è",
      text: `–í—Å–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –≤—Ä–∞—á–∏ —É–∂–µ —É —Ç–µ–±—è. –ü–æ–ª—É—á–∏ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—é: <b>üí∞ +${comp}</b>`,
      hint: "–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –ü–æ—Ç—Ä–æ–≥–∞–π —Ç—Ä–∞–≤—É."
    };
  }

  state.doctorsOwned = state.doctorsOwned || [];
  state.doctorsOwned.push(doc.id);

  return {
    kind: "doctor",
    doc,
    title: "üßë‚Äç‚öïÔ∏è –ù–æ–≤—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫!",
    text: `
      <div class="listTitle">${escapeHtml(doc.name)} <span class="tag">${rarityLabel(doc.rarity)}</span></div>
      <div class="listSub">${escapeHtml(doc.title || "")}</div>
      <div class="hint">–ú–µ—Ç–æ–¥—ã: ${doc.methods.map(m => escapeHtml(methodName(m))).join(", ")}</div>
      <div class="hint">${escapeHtml(doc.bio || "")}</div>
    `,
    hint: "–û–Ω —É–∂–µ –≤ ‚Äú–®—Ç–∞—Ç–µ‚Äù. –ù–∞–∑–Ω–∞—á–∞–π –Ω–∞ –¥–µ–∂—É—Ä—Å—Ç–≤–æ –∏ –¥–µ–ª–∞–π –≤–∏–¥, —á—Ç–æ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—à—å —Å–∏—Ç—É–∞—Ü–∏—é."
  };
}

function openChest(kind){
  const chest = CHESTS[kind];
  if(!chest) return;

  const loot = weightedPick(chest.loot);

  // –ø—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞–≥—Ä–∞–¥—É –∏ –ø–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –º–æ–¥–∞–ª–∫–∏
  const modal = lootApplyTextRu(loot);

  // –ø–µ—Ä–∫–∏ –º–æ–≥—É—Ç –≤–ª–∏—è—Ç—å –Ω–∞ maxQueue –∏ —Ç.–¥. 
  // –Ω–∞–ø—Ä–∏–º–µ—Ä, —á—Ç–æ–±—ã –æ—á–µ—Ä–µ–¥—å —Å—Ä–∞–∑—É –ø–µ—Ä–µ—Å—á–∏—Ç–∞–ª–∞—Å—å:
  state.maxQueue = Math.min(
  10,
  (state.base?.maxQueue ?? 6)
  + (state.perks?.queueBuffer ?? 0)
  + queueCapBonus()
);

  saveState();

  showLootModal({
    title: `üéÅ ${chest.title}`,
    text: modal?.text || "",
    hint: modal?.hint || ""
  });

  // –µ—Å–ª–∏ –≤—ã–ø–∞–ª –¥–æ–∫—Ç–æ—Ä, –ø—Ä–∏—è—Ç–Ω–æ —Å—Ä–∞–∑—É –æ–±–Ω–æ–≤–∏—Ç—å —à—Ç–∞—Ç
  refreshVisibleUI();
}
window.openChest = openChest;
  

function resetToBase(){
  // –±–∞–∑–∞
  state.maxQueue = state.base?.maxQueue ?? 6;
  state.baseWaitSec = state.base?.baseWaitSec ?? 120;
  state.baseTreatSecMin = state.base?.baseTreatSecMin ?? 120;
  state.baseTreatSecMax = state.base?.baseTreatSecMax ?? 300;

  // –ª–∞–±–∞ –±–∞–∑–æ–≤–∞—è
  if(!state.lab) state.lab = { costCoins: 15, maxPerPatient: 2 };
  state.lab.costCoins = state.base?.baseLabCost ?? 15;
}

function applyPerks(){
  // –æ—á–µ—Ä–µ–¥—å –∏–∑ –ø–µ—Ä–∫–æ–≤ –ª–∞–≤–∫–∏
  state.maxQueue = Math.min(
  10,
  (state.base?.maxQueue ?? 3)
  + (state.perks?.queueBuffer ?? 0)
  + (state.queueUpg?.capLvl ?? 0)
);
  // –æ—Å—Ç–∞–ª—å–Ω–æ–µ (–ª–∞–±–∞ —Å–∫–∏–¥–∫–∞/—ç–∫—Å—Ç—Ä–∞, —Å–∫–æ—Ä–æ—Å—Ç—å –ª–µ—á–µ–Ω–∏—è) —Ç—ã —Å—á–∏—Ç–∞–µ—à—å –Ω–∞ –ª–µ—Ç—É –≤ –Ω—É–∂–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö –∏ —ç—Ç–æ –Ω–æ—Ä–º
}

function queueCapCost(level){
  // —É—Ä–æ–≤–µ–Ω—å 0->1,1->2,2->3
  // –¥–æ—Ä–æ–≥–æ –∏ —Ä–∞—Å—Ç—ë—Ç –±—ã—Å—Ç—Ä–æ
  return 800 * Math.pow(2, level); // 800, 1600, 3200
}

function queueWaitCost(level){
  return 600 * Math.pow(2, level); // 600, 1200, 2400, 4800...
}

function queueCapBonus(){
  return Math.min(3, state.queueUpg?.capLvl ?? 0); // +0..+3 –∫ maxQueue
}

function queueWaitBonusSecPerBuy(){
  return 20; // ‚Äú–Ω–µ–º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏‚Äù –≤—Å–µ–º –≤ –æ—á–µ—Ä–µ–¥–∏, 20 —Å–µ–∫ –∑–∞ –ø–æ–∫—É–ø–∫—É
}

function upgradeQueueCap(){
  state.queueUpg = state.queueUpg || {};
  const lvl = state.queueUpg.capLvl || 0;
  if(lvl >= 3) return;

  const cost = queueCapCost(lvl);
  if(state.coins < cost) return;

  state.coins -= cost;
  state.queueUpg.capLvl = lvl + 1;

  // –ø–µ—Ä–µ—Å—á—ë—Ç –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ (maxQueue –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø–µ—Ä–∫–æ–≤)
  applyAllModifiers();

  // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π, —á—Ç–æ–±—ã –æ—á–µ—Ä–µ–¥—å –¥–æ–∑–∞–ø–æ–ª–Ω–∏–ª–∞—Å—å —Å—Ä–∞–∑—É
  fillQueue();
  saveState();
  refreshVisibleUI();
}

function upgradeQueueWait(){
  state.queueUpg = state.queueUpg || {};
  const lvl = state.queueUpg.waitLvl || 0;
  const maxLvl = 6; // —á—Ç–æ–± –Ω–µ —É–ª–µ—Ç–µ—Ç—å –≤ –∫–æ—Å–º–æ—Å
  if(lvl >= maxLvl) return;

  const cost = queueWaitCost(lvl);
  if(state.coins < cost) return;

  state.coins -= cost;
  state.queueUpg.waitLvl = lvl + 1;

  const addSec = queueWaitBonusSecPerBuy();
  // –¥–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è –í–°–ï–ú –≤ –æ—á–µ—Ä–µ–¥–∏
  for(const pid of (state.queue || [])){
    const p = patientById(pid);
    if(p && Number.isFinite(p.leaveAt)){
      p.leaveAt += addSec * 1000;
    }
  }

  saveState();
  refreshVisibleUI();
}

// —ç–∫—Å–ø–æ—Ä—Ç –¥–ª—è onclick (–µ—Å–ª–∏ –±—É–¥–µ—à—å –¥–µ–ª–∞—Ç—å —á–µ—Ä–µ–∑ onclick)
window.upgradeQueueCap = upgradeQueueCap;
window.upgradeQueueWait = upgradeQueueWait;

function applyDoctorFatigueAfterShift(){
  normalizeDoctorsFatigue();

  const dutyIds = new Set(
    dutyDoctors().filter(Boolean).map(d => d.id)
  );

  for(const d of DOCTOR_POOL){
    const f = Number(d.fatigue || 0);

    if(dutyIds.has(d.id)){
      // —Ä–∞–±–æ—Ç–∞–ª —Å–º–µ–Ω—É -> —É—Å—Ç–∞–ª
      const mul = (state.perks?.fatigueGainMul ?? 1.0);
d.fatigue = Math.min(100, f + Math.round(Number(d.fatigueGain || 15) * mul));
    } else {
      // –Ω–µ —Ä–∞–±–æ—Ç–∞–ª -> –æ—Ç–¥–æ—Ö–Ω—É–ª
      d.fatigue = Math.max(0, f - 12);
    }
  }
}

function applyAllModifiers(){
  resetToBase();
  applyPerks();

  const e = getCurrentEvent();
  if(e && typeof e.apply === "function"){
    e.apply();
  }
}  

function formatLeft(ms){
  ms = Math.max(0, ms);
  const s = Math.floor(ms/1000);
  const m = Math.floor(s/60);
  const r = s%60;
  return `${m}:${String(r).padStart(2,"0")}`;
}

function formatShiftLeft(ms){
  ms = Math.max(0, ms);
  const totalMin = Math.floor(ms / 60000);
  const h = Math.floor(totalMin / 60);
  const m = totalMin % 60;
  return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
}

  function fatigueLabel(f){
  f = Math.round(Number(f || 0));
  if(f >= 90) return "‚ò†Ô∏è –≤—ã–∂–∞—Ç";
  if(f >= 70) return "ü•¥ —É—Å—Ç–∞–ª";
  if(f >= 40) return "üòê –Ω–æ—Ä–º";
  return "üü¢ –±–æ–¥—Ä";
}

function fatigueClass(f){
  f = Number(f || 0);
  if(f >= 90) return "bad";
  if(f >= 70) return "warn";
  return "ok";
}

function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}

function now(){ return Date.now(); }

function pickRandomDoctorId(avoidSame=false){
  const all = DOCTOR_POOL.map(d=>d.id);
  if(!avoidSame) return pick(all);
  const base = state ? state.duty?.slot1 : null;
  const filtered = all.filter(x=>x!==base);
  return pick(filtered.length?filtered:all);
}

  function pickClueForDisease(disease){
  const hints = disease?.hints;
  if(Array.isArray(hints) && hints.length) return pick(hints);
  return "–°–∏–º–ø—Ç–æ–º—ã —Å–∫–ª–∞–¥—ã–≤–∞—é—Ç—Å—è –≤ —É–∑–æ—Ä. –ù–æ —É–∑–æ—Ä—ã –ª—é–±—è—Ç –≤—Ä–∞—Ç—å.";
}

function getDoctorById(id){
  return DOCTOR_POOL.find(d=>d.id===id) || DOCTOR_POOL[0];
}

function getDiseaseById(id){
  return DISEASES.find(d=>d.id===id) || DISEASES[0];
}

function patientById(id){
  const sid = String(id);
  return (state.patients || []).find(p => String(p.id) === sid) || null;
}

function wardById(id){
  return state.wards.find(w=>w.id===id) || null;
}

function findWardByPatient(patientId){
  const pid = String(patientId);
  return (state.wards || []).find(w => (w.patients || []).some(x => String(x) === pid)) || null;
}

const MALE_PORTRAITS = ["m1.png","m2.png","m3.png","m4.png","m5.png","m6.png","m7.png","m8.png","m9.png","m10.png"];
const FEMALE_PORTRAITS = ["f1.png","f2.png","f3.png","f4.png","f5.png","f6.png","f7.png","f8.png","f9.png","f10.png"];

function ensurePatientPortrait(p){
  if(!p) return "img/patients/placeholder.png";
  if(p.portrait) return p.portrait;

  const pool = (p.gender === "f") ? FEMALE_PORTRAITS : MALE_PORTRAITS;
  const pickOne = pool[Math.floor(Math.random() * pool.length)];
  p.portrait = "img/patients/" + pickOne;

  return p.portrait;
}

  

/* =========================================================
   5) PATIENT GENERATION + QUEUE
========================================================= */

function makePatient(){
  const fn = pick(FIRST_NAMES);
const isFemale = FEMALE_FIRST_NAMES.has(fn);

let ln = pick(LAST_NAMES);
if(isFemale) ln = toFemaleLastName(ln);

  // —à–∞–Ω—Å –Ω–∞ —Ä–µ–¥–∫–æ—Å—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞
  const pr = Math.random();
  const patientRarity =
    pr < 0.78 ? RARITY.COMMON :
    pr < 0.95 ? RARITY.RARE :
    RARITY.LEGENDARY;

  // –±–æ–ª–µ–∑–Ω—å —Å —É—á—ë—Ç–æ–º —Ä–µ–¥–∫–æ—Å—Ç–∏ –ø–∞—Ü–∏–µ–Ω—Ç–∞
  const diseasePool = DISEASES.filter(d=>{
    if(patientRarity===RARITY.COMMON) return d.rarity!==RARITY.LEGENDARY;
    if(patientRarity===RARITY.RARE) return true;
    return true;
  });

  // –Ω–µ–±–æ–ª—å—à–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –≤ —Ä–µ–¥–∫–∏–µ –±–æ–ª–µ–∑–Ω–∏ –¥–ª—è —Ä–µ–¥–∫–∏—Ö –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤
  let disease = pick(diseasePool);
  if(patientRarity!==RARITY.COMMON){
    const rarePool = diseasePool.filter(d=>d.rarity!==RARITY.COMMON);
    if(rarePool.length && Math.random()<0.55) disease = pick(rarePool);
  }

  const id = "p"+Math.random().toString(16).slice(2,8);
  const waitSec = state.baseWaitSec + randInt(-20, 40);
  const qmul = (state.perks?.queueWaitMul ?? 1.0);
const waitSecFinal = Math.max(10, Math.round(waitSec * qmul));
 // —Å–∫–æ—Ä–æ—Å—Ç—å –ª–µ—á–µ–Ω–∏—è –æ—Ç –ø–µ—Ä–∫–∞ "–∫–æ–π–∫–∏ –ø–æ–ª—É—á—à–µ" (treatSpeed)
const speed = Math.min(40, state.perks?.treatSpeed ?? 0); // –º–∞–∫—Å–∏–º—É–º 40%

// –ë–ê–ó–û–í–û–ï –≤—Ä–µ–º—è –ª–µ—á–µ–Ω–∏—è –ø–æ —Ä–µ–¥–∫–æ—Å—Ç–∏ –ø–∞—Ü–∏–µ–Ω—Ç–∞ (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö)
let baseMin = 120, baseMax = 300; // common: 2‚Äì5 –º–∏–Ω—É—Ç
if(patientRarity === RARITY.RARE){
  baseMin = 8 * 60;   // 8 –º–∏–Ω
  baseMax = 15 * 60;  // 15 –º–∏–Ω
}
if(patientRarity === RARITY.LEGENDARY){
  baseMin = 13 * 60;  // 13 –º–∏–Ω
  baseMax = 20 * 60;  // 20 –º–∏–Ω
}

const baseTreat = randInt(baseMin, baseMax);

// –ø—Ä–∏–º–µ–Ω—è–µ–º —É—Å–∫–æ—Ä–µ–Ω–∏–µ
const treatSec = Math.max(30, Math.round(baseTreat * (1 - speed/100)));

  // –≤–∏–¥–∏–º—ã–µ —Å–∏–º–ø—Ç–æ–º—ã: 1-2 —à—Ç—É–∫–∏
  const visCount = Math.random()<0.5 ? 1 : 2;
  const vis = shuffle([...disease.symptoms]).slice(0, visCount);

  return {
    id,
    name: `${fn} ${ln}`,
    gender: isFemale ? "f" : "m",
    rarity: patientRarity,
    treatAttempts: 0,
 
    trueDiseaseId: disease.id,
    visibleSymptoms: vis,

    // —Ç–∞–π–º–∏–Ω–≥–∏
    createdAt: now(),
    leaveAt: now() + waitSecFinal*1000,
    treatSec,

    // —Ñ–ª–∞–≥ ‚Äú–∏–∑–≤–µ—Å—Ç–Ω–∞—è –±–æ–ª–µ–∑–Ω—å‚Äù
    knownDisease: false,
    diagnosisRewarded: false,
    clue: null,

    treatmentOptions: null,
    doctorAdviceCache: null,
    labUsed: 0,
    
    diffCandidates: null,
    diffFinalId: null
    
  };
}

const PHARM_MEDICINES = [
  {
    id:"belladonna",
    name:"–ë–µ–ª–∞–¥–æ–Ω–Ω–∞",
    tags:["pain","fever","sleep"],
    studyCoins: 120,
    studyTimeSec: 90,
    desc:"–°–Ω–∏–º–∞–µ—Ç –±–æ–ª—å –∏ –∂–∞—Ä. –û–ø–∞—Å–Ω–∞. –î–æ–∑–∏—Ä–æ–≤–∫—É —Å–æ–±–ª—é–¥–∞–π, –∞ —Ç–æ –∫–ª–∏–µ–Ω—Ç —É–π–¥—ë—Ç –≤ –∞–¥ –±–µ–∑ –æ—á–µ—Ä–µ–¥–∏.",
    req: { served: 0, perfect: 0 }
  },
  {
    id:"warm_stone",
    name:"–¢—ë–ø–ª—ã–π –∫–∞–º–µ–Ω—å",
    tags:["pain","cold","calm"],
    studyCoins: 160,
    studyTimeSec: 120,
    desc:"–°–Ω–∏–º–∞–µ—Ç –±–æ–ª—å, –¥–∞—ë—Ç —Ç–µ–ø–ª–æ –∏ —á—É–≤—Å—Ç–≤–æ, —á—Ç–æ –∂–∏–∑–Ω—å –Ω–µ –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω–∞.",
    req: { served: 3, perfect: 0 }
  },
  {
    id:"herbs_mix",
    name:"–ù–∞—Å—Ç–æ–π —Ç—Ä–∞–≤",
    tags:["calm","sleep","stomach"],
    studyCoins: 140,
    studyTimeSec: 110,
    desc:"–£—Å–ø–æ–∫–∞–∏–≤–∞–µ—Ç, –∏–Ω–æ–≥–¥–∞ –¥–∞–∂–µ –ª–µ—á–∏—Ç. –ò–Ω–æ–≥–¥–∞ –ø—Ä–æ—Å—Ç–æ –∫—Ä–∞—Å–∏–≤–æ –ø–∞—Ö–Ω–µ—Ç.",
    req: { served: 0, perfect: 1 }
  },
];

function medById(id){
  return PHARM_MEDICINES.find(m => m.id === id) || null;
}

const PHARM_ORDER_TEMPLATES = [
  {
    id:"order_headache",
    keywords:["pain","sleep"],
    text:`–£ –º–æ–µ–≥–æ –º—É–∂–∞ –æ—á–µ–Ω—å —Å–∏–ª—å–Ω–æ –±–æ–ª–∏—Ç –≥–æ–ª–æ–≤–∞, –æ–Ω –Ω–µ –º–æ–∂–µ—Ç —Å–ø–∞—Ç—å, –≤–µ—á–Ω–æ –Ω–∞ –≤–∑–≤–æ–¥–µ. –†–∞–Ω—å—à–µ –±–∏–ª —Å–∏–ª—å–Ω–µ–µ.`,
    answers:[
      { text:"–î–∞—Ç—å –ë–µ–ª–∞–¥–æ–Ω–Ω—É (–∞–∫–∫—É—Ä–∞—Ç–Ω–æ)", kind:"good" },
      { text:"–ü—É—Å—Ç—å –≤—ã–ø—å–µ—Ç –Ω–∞—Å—Ç–æ–π —Ç—Ä–∞–≤ –∏ –º–æ–ª–∏—Ç—Å—è", kind:"neutral" },
      { text:"–ö—Ä–æ–≤–æ–ø—É—Å–∫–∞–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–µ –≤—ã–ø–µ–Ω–¥—Ä–∏–≤–∞–ª—Å—è", kind:"bad" },
      { text:"–î–≤–æ–π–Ω–∞—è –¥–æ–∑–∏—Ä–æ–≤–∫–∞, —á—Ç–æ–±—ã –Ω–∞–≤–µ—Ä–Ω—è–∫–∞", kind:"lethal" },
    ]
  },
  {
    id:"order_cold",
    keywords:["cold","pain"],
    text:`–û–Ω –º—ë—Ä–∑–Ω–µ—Ç –¥–∞–∂–µ –≤ –±–∞–Ω–µ, —Å—É—Å—Ç–∞–≤—ã –ª–æ–º–∏—Ç, –Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –µ–≥–æ –±–∞—Ä–∏–Ω.`,
    answers:[
      { text:"–¢—ë–ø–ª—ã–π –∫–∞–º–µ–Ω—å –∏ –ø–æ–∫–æ–π", kind:"good" },
      { text:"–ù–∞—Å—Ç–æ–π —Ç—Ä–∞–≤ (—á—Ç–æ–±—ã –Ω–µ –Ω—ã–ª)", kind:"neutral" },
      { text:"–°–æ–ª—å –≤ —Ä–∞–Ω—É. –ó–∞–∫–∞–ª–∫–∞.", kind:"bad" },
    ]
  }
];

function ensurePharmacyState(){
  state.pharmacy = state.pharmacy || {};
  state.pharmacy.queue = state.pharmacy.queue || [];
  state.pharmacy.clients = state.pharmacy.clients || {};
  state.pharmacy.medsStudied = state.pharmacy.medsStudied || {};
  state.pharmacy.medsStudying = state.pharmacy.medsStudying || null;
  state.pharmacy.nextAt = Number(state.pharmacy.nextAt || 0);
  state.pharmacy.lastResult = state.pharmacy.lastResult || null;
  state.pharmacy.served = Number(state.pharmacy.served || 0);
  state.pharmacy.perfect = Number(state.pharmacy.perfect || 0);
}

function pharmacyUnlocked(){
  return !!state.perks?.pharmacyOpen;
}

function makePharmClient(){
  const tpl = pick(PHARM_ORDER_TEMPLATES);
  const id = "c" + Math.random().toString(16).slice(2,8);

  // –∞–≤–∞—Ç–∞—Ä–∫—É –º–æ–∂–Ω–æ reuse –∏–∑ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤:
  const fakePatient = { gender: (Math.random()<0.5 ? "m" : "f") };
  const portrait = ensurePatientPortrait(fakePatient);

  return {
    id,
    portrait,
    tplId: tpl.id,
    text: tpl.text,
    keywords: tpl.keywords,
    answers: tpl.answers
  };
}

function scheduleNextPharmClient(){
  // –±–∞–∑–æ–≤–æ ‚Äú—Ä–µ–¥–∫–æ‚Äù: —Ä–∞–∑ –≤ 12‚Äì20 –º–∏–Ω—É—Ç
  let minSec = 12*60;
  let maxSec = 20*60;

  // –ø—Ä–æ–∫–∞—á–∫–∏: —É–º–µ–Ω—å—à–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª
  const mul = (state.perks?.pharmacySpawnMul ?? 1.0); // 1.0 –Ω–æ—Ä–º, 0.8 –±—ã—Å—Ç—Ä–µ–µ –∏ —Ç.–ø.
  minSec = Math.round(minSec * mul);
  maxSec = Math.round(maxSec * mul);

  const dt = randInt(minSec, maxSec);
  state.pharmacy.nextAt = now() + dt*1000;
}

function processPharmacyTick(){
  if(!state.shift?.active) return;
  ensurePharmacyState();
  if(!pharmacyUnlocked()) return;

  // –µ—Å–ª–∏ –æ—á–µ—Ä–µ–¥—å –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∞, –Ω–µ —Å–ø–∞–≤–Ω–∏–º
  if(state.pharmacy.queue.length >= 9) return;

  if(!state.pharmacy.nextAt){
    scheduleNextPharmClient();
    saveState();
    return;
  }

  if(now() >= state.pharmacy.nextAt){
    const c = makePharmClient();
    state.pharmacy.clients[c.id] = c;
    state.pharmacy.queue.push(c.id);

    scheduleNextPharmClient();
    saveState();
  }
}

function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}

function fillQueue(){
  if(!state.shift?.active) return;

  if(!state.spawn) state.spawn = { nextAt: now() };
  if(!Number.isFinite(Number(state.spawn.nextAt))){
    state.spawn.nextAt = now() + randInt(20000, 40000);
    return;
  }

  if(state.queue.length >= state.maxQueue) return;

  const t = now();
  if(t < state.spawn.nextAt) return;

  const p = makePatient();
  state.patients.push(p);
  state.queue.push(p.id);

  state.spawn.nextAt = t + randInt(20000, 40000);
  saveState();
}

function processQueueTick(){
  if(!state.shift?.active) return;
  const t = now();
  let changed = false;

  // –ø–∞—Ü–∏–µ–Ω—Ç—ã –≤ –æ—á–µ—Ä–µ–¥–∏ –º–æ–≥—É—Ç —É–º–µ—Ä–µ—Ç—å / —É–π—Ç–∏
  for(let i=state.queue.length-1;i>=0;i--){
    const pid = state.queue[i];
    const p = patientById(pid);
    if(!p){ state.queue.splice(i,1); changed=true; continue; }

    if(t >= p.leaveAt){
      // 20% —à–∞–Ω—Å —É–º–µ—Ä–µ—Ç—å –≤ –æ—á–µ—Ä–µ–¥–∏, –∏–Ω–∞—á–µ —É–π—Ç–∏
    // –Ω–µ–¥–µ–ª—è –≤–ª–∏—è–µ—Ç –Ω–∞ –æ—á–µ—Ä–µ–¥—å
const ev = getCurrentEvent();

// –±–∞–∑–æ–≤—ã–π —à–∞–Ω—Å —Å–º–µ—Ä—Ç–∏
const baseDeath = 0.10;

// "–º—É—Ç—å" = —Å–º–µ—Ä—Ç—å —á–∞—â–µ
const deathChance = (ev?.id === "tainted_water") ? 0.22 : baseDeath;
const died = Math.random() < deathChance;

// "—Å–≤—è—Ç–æ–µ —à–µ—Å—Ç–≤–∏–µ" = –Ω–µ—Ç —à—Ç—Ä–∞—Ñ–∞ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏ –∑–∞ —Å–º–µ—Ä—Ç—å –≤ –æ—á–µ—Ä–µ–¥–∏
const noRepPenalty = (ev?.id === "holy_week");

if(died){
  if(!noRepPenalty){
    state.reputation -= 2;
  }
  state.biomaterial += 1;
} else {
  // —É—à—ë–ª –∂–∏–≤–æ–π ‚Äî —É —Ç–µ–±—è —Ç—É—Ç –±—ã–ª–æ "-= 0", –º–æ–∂–Ω–æ –≤–æ–æ–±—â–µ —É–±—Ä–∞—Ç—å
}

// –∫—Ä—ã—Å—ã: –±–æ–Ω—É—Å –±–∏–æ –∑–∞ —Å–º–µ—Ä—Ç—å –≤ –æ—á–µ—Ä–µ–¥–∏ (–∫–∞–∫ –±—ã–ª–æ)
if(ev?.id === "rat_week" && died){
  state.biomaterial += 1;
}    
      state.queue.splice(i,1);
      // —É–¥–∞–ª–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é
      state.patients = state.patients.filter(x=>x.id!==pid);
      changed=true;

      if(state.shift?.active) state.shift.left += 1;
      
    }
  }

  if(changed){
    fillQueue();
    saveState();
  }
}

/* =========================================================
   6) WARD UPGRADES (caps + scaling cost)
========================================================= */

function wardStatValue(w, stat){
  return w[stat];
}
function wardStatCap(w, stat){
  if(stat==="comfort") return w.capComfort;
  if(stat==="cleanliness") return w.capCleanliness;
  if(stat==="ventilation") return w.capVentilation;
  if(stat==="light") return w.capLight;
  return 6;
}
function upgradeCost(w, stat){
  const v = wardStatValue(w, stat); // —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å —Å—Ç–∞—Ç–∞ (0..)
  const base = {
    comfort: 140,
    ventilation: 190,
    light: 165,
    cleanliness: 155
  }[stat] || 160;

  // —Ä–æ—Å—Ç —Ü–µ–Ω—ã: —É—Ä–æ–≤–µ–Ω—å —Å—Ç–∞—Ç–∞ + —É—Ä–æ–≤–µ–Ω—å –ø–∞–ª–∞—Ç—ã
  const lvlFactor = Math.pow(v + 1, 1.65);          // –∞–ø–≥—Ä–µ–π–¥—ã –≤–≤–µ—Ä—Ö —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –±–æ–ª—å–Ω–µ–µ
  const wardFactor = 1 + Math.max(0, (w.level||1) - 1) * 0.55; // —á–µ–º –≤—ã—à–µ –ø–∞–ª–∞—Ç–∞, —Ç–µ–º –¥–æ—Ä–æ–∂–µ —É–ª—É—á—à–µ–Ω–∏—è

  return Math.round(base * lvlFactor * wardFactor);
}
  
function canUpgrade(w, stat){
  return wardStatValue(w, stat) < wardStatCap(w, stat);
}

  function buyWardB(){
  if(state.unlocks?.wardB) return;

  const cost = 3500;
  if(state.coins < cost) return;

  state.coins -= cost;
  state.unlocks.wardB = true;

  // –¥–æ–±–∞–≤–∏—Ç—å –ø–∞–ª–∞—Ç—É B
  if(!state.wards.some(w => w.id==="ward_B")){
    state.wards.push(makeWard("B"));
  }

  saveState();
  refreshVisibleUI();
}

function upgradeWardStat(wardId, stat){
  const w = wardById(wardId);
  if(!w) return;

  if(!canUpgrade(w, stat)) return;

  const cost = upgradeCost(w, stat);
  if(state.coins < cost) return;

  state.coins -= cost;
  w[stat] += 1;

  // –ø–∞–ª–∞—Ç–∞ —Ä–∞—Å—Ç—ë—Ç –ø–æ —Å—É–º–º–µ —Å—Ç–∞—Ç–æ–≤
  const sum = w.comfort + w.cleanliness + w.ventilation + w.light;
  w.level = 1 + Math.floor(sum/8);

  saveState();
  refreshVisibleUI();
}

/* =========================================================
   7) DOCTORS: advice + skill penalties
========================================================= */

function dutyDoctors(){
  const d1 = getDoctorById(state.duty.slot1);
  const d2 = state.duty.slot2 ? getDoctorById(state.duty.slot2) : null;
  return [d1, d2];
}

function doctorConfidence(doc){
  if(!doc) return 0.4;

  let base = 0.45;
  if(doc.persona==="fanatic") base = 0.90;
  else if(doc.persona==="confident") base = 0.75;
  else if(doc.persona==="trickster") base = 0.65;
  else if(doc.persona==="cold") base = 0.60;

  const fatigue = Number(doc.fatigue || 0);
  if(fatigue > 60) base -= 0.18;
  if(fatigue > 85) base -= 0.25;

  return Math.max(0.15, base);
}

function doctorAdviceText(doc, options){
  if(!doc) return `‚Äî <b>–ü—É—Å—Ç–æ–π —Å–ª–æ—Ç</b>: ‚Äú–ù–∞–∑–Ω–∞—á—å –≤—Ä–∞—á–∞, –∏–Ω–∞—á–µ –ª–µ—á–∏ –Ω–∞ –æ—â—É–ø—å.‚Äù`;
  const f = Math.round(doc.fatigue || 0);
  const fCls = fatigueClass(f);
  // doc —Å–æ–≤–µ—Ç—É–µ—Ç –º–µ—Ç–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –æ–Ω –∑–Ω–∞–µ—Ç, –µ—Å–ª–∏ –æ–Ω –≤ options
  const knows = options.filter(o=>doc.methods.includes(o));
  const conf = doctorConfidence(doc);

  const fatigue = Number(doc.fatigue || 0);
const fatigueMul = fatigue >= 90 ? 0.55 : fatigue >= 70 ? 0.75 : 1.0;

if(knows.length && Math.random() < (conf * fatigueMul)){
    const m = pick(knows);
    return `‚Äî <b>${escapeHtml(doc.name)}</b> <span class="tag ${fCls}">${f}%</span>: ‚Äú–Ø –±—ã –≤–∑—è–ª <b>${escapeHtml(methodName(m))}</b>.‚Äù`;
  }

  // –∏–Ω–æ–≥–¥–∞ –∫—Ä–∏—Ç–∏–∫—É–µ—Ç –º–µ—Ç–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –ª—é–±–∏—Ç (–ø—Ä–æ—Å—Ç–æ –≤—ã–±–∏—Ä–∞–µ–º —Ä–∞–Ω–¥–æ–º–Ω—ã–π –Ω–µ-–µ–≥–æ)
  if(Math.random() < 0.35){
    const m = pick(options);
    if(!doc.methods.includes(m)){
      return `‚Äî <b>${escapeHtml(doc.name)}</b> <span class="tag ${fCls}">${f}%</span>: ‚Äú–¢–æ–ª—å–∫–æ –Ω–µ <b>${escapeHtml(methodName(m))}</b>‚Ä¶ —ç—Ç–æ –ø–∞—Ö–Ω–µ—Ç –ø—Ä–æ–≤–∞–ª–æ–º.‚Äù`;
    }
  }

// —É—Å–∏–ª–µ–Ω–Ω–∞—è –Ω–µ–ø—Ä–∏—è–∑–Ω—å: –µ—Å–ª–∏ –≤ –æ–ø—Ü–∏—è—Ö –µ—Å—Ç—å –Ω–µ–ª—é–±–∏–º—ã–π –º–µ—Ç–æ–¥, —á–∞—â–µ –ø—Ä–µ–¥–æ—Å—Ç–µ—Ä–µ–≥–∞–µ—Ç
const hated = options.filter(o => (doc.hates||[]).includes(o));
if(hated.length && Math.random() < 0.55){
  const m = pick(hated);
  return `‚Äî <b>${escapeHtml(doc.name)}</b> <span class="tag ${fCls}">${f}%</span>: ‚Äú–ï—Å–ª–∏ —Ö–æ—á–µ—à—å –ø—Ä–æ–±–ª–µ–º, –≤—ã–±–µ—Ä–∏ <b>${escapeHtml(methodName(m))}</b>.‚Äù`;
}
  
  return `‚Äî <b>${escapeHtml(doc.name)}</b> <span class="tag ${fCls}">${f}%</span>: ‚Äú–°–∏—Ç—É–∞—Ü–∏—è‚Ä¶ –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω–∞—è. –†–µ—à–∞–π —Å–∞–º.‚Äù`;
}

function doctorSkillPenalty(selectedMethod){
  const docs = dutyDoctors().filter(Boolean);
  if(!docs.length) return 0.78; // –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç = –±–æ–ª—å

  let mul = 1.0;

  // –µ—Å–ª–∏ –Ω–∏–∫—Ç–æ –Ω–µ —É–º–µ–µ—Ç –º–µ—Ç–æ–¥ ‚Äî –±–∞–∑–æ–≤—ã–π —à—Ç—Ä–∞—Ñ
  const anyKnow = docs.some(d => d.methods.includes(selectedMethod));
  if(!anyKnow) mul *= 0.78;

  // —É—Å—Ç–∞–ª–æ—Å—Ç—å –∫–∞–∂–¥–æ–≥–æ –¥–µ–∂—É—Ä–Ω–æ–≥–æ —É—Ö—É–¥—à–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
  for(const d of docs){
    const f = Number(d.fatigue || 0);
    if(f > 60) mul *= 0.92;
    if(f > 85) mul *= 0.88;
  }

  return Math.max(0.55, mul);
}

/* =========================================================
   8) TREATMENT OPTIONS (4 buttons: best, worst, 2 random)
========================================================= */

function scoreMethodForDisease(methodId, disease){
  return disease.weights?.[methodId] ?? 0.5;
}

function pickTreatmentOptions(patient){
  const d = getDiseaseById(patient.trueDiseaseId);

  const scored = METHODS.map(m=>{
    return { id:m.id, score:scoreMethodForDisease(m.id,d) };
  }).sort((a,b)=>b.score-a.score);

  const best = scored[0].id;
  const worst = scored[scored.length-1].id;

  const middle = scored.slice(1, scored.length-1).map(x=>x.id);
  shuffle(middle);

  const opt = [best, worst, middle[0] || best, middle[1] || worst];
  // –ø–µ—Ä–µ–º–µ—à–∞–µ–º, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ø–∞–ª–µ–≤–Ω–æ
  shuffle(opt);
  return opt;
}

/* =========================================================
   9) OUTCOMES (black comedy)
========================================================= */

function makeFlavor(kind, treatmentId){
  const t = methodName(treatmentId);

  const pool = {
    [OUTCOMES.CURE]: [
      "–ü–∞—Ü–∏–µ–Ω—Ç –≤—ã–∂–∏–ª –∏ –¥–∞–∂–µ —É–ª—ã–±–∞–µ—Ç—Å—è. –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ.",
      "–°–∏–º–ø—Ç–æ–º—ã —É—à–ª–∏. –ß—É–≤—Å—Ç–≤–æ –≤–∏–Ω—ã –æ—Å—Ç–∞–ª–æ—Å—å.",
      `–ö–∞–∫ –Ω–∏ —Å—Ç—Ä–∞–Ω–Ω–æ, ${t} –ø–æ–º–æ–≥–ª–æ.`
    ],
    [OUTCOMES.DISFIGURED]: [
      `–£—Å–ø–µ—à–Ω–æ‚Ä¶ –Ω–æ —Ç–µ–ø–µ—Ä—å –±–µ–∑ –ø–∞—Ä—ã –¥–µ—Ç–∞–ª–µ–π. –ú–µ—Ç–æ–¥: ${t}.`,
      "–ü—Ä–æ–±–ª–µ–º—É —Ä–µ—à–∏–ª–∏. –≠—Å—Ç–µ—Ç–∏–∫—É –Ω–µ –æ–±–µ—â–∞–ª–∏.",
      "–û—Å–Ω–æ–≤–Ω—É—é –±–µ–¥—É —É–±—Ä–∞–ª–∏. –ü–æ–±–æ—á–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –æ—Å—Ç–∞–≤–∏–ª–∏."
    ],
    [OUTCOMES.INFECTED]: [
      "–û—Å–Ω–æ–≤–Ω–∞—è –±–æ–ª–µ–∑–Ω—å —É—à–ª–∞. –ó–∞—Ç–æ –ø–æ—è–≤–∏–ª–∞—Å—å –Ω–æ–≤–∞—è. –ë–µ—Å–ø–ª–∞—Ç–Ω–æ.",
      "–í–æ –≤—Ä–µ–º—è –ø—Ä–æ—Ü–µ–¥—É—Ä –∑–∞–Ω–µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –æ—á–µ–Ω—å –∂–∏–≤–æ–µ.",
      `–ü–æ—Å–ª–µ ${t} –ø–∞—Ü–∏–µ–Ω—Ç —á—É–≤—Å—Ç–≤—É–µ—Ç‚Ä¶ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ.`
    ],
    [OUTCOMES.WORSENED]: [
      "–°—Ç–∞–ª–æ —Ö—É–∂–µ. –ü–∞—Ü–∏–µ–Ω—Ç —Å–º–æ—Ç—Ä–∏—Ç –∫–∞–∫ –∫—Ä–µ–¥–∏—Ç–æ—Ä.",
      "–ù—É–∂–Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞. –ò –º–æ–ª–∏—Ç–≤–∞. –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ —Ç–≤–æ—è.",
      "–õ–µ—á–µ–Ω–∏–µ –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ. –î–ª—è –±–æ–ª–µ–∑–Ω–∏."
    ],
    [OUTCOMES.DEATH]: [
      "–ü–∞—Ü–∏–µ–Ω—Ç —É–º–µ—Ä. –ë—É–º–∞–≥–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω—ã –∏–¥–µ–∞–ª—å–Ω–æ.",
      "–°–º–µ—Ä—Ç—å –Ω–∞—Å—Ç—É–ø–∏–ª–∞ –≤–Ω–µ–∑–∞–ø–Ω–æ. –î–ª—è –ø–∞—Ü–∏–µ–Ω—Ç–∞.",
      "–ó–∞—Ç–æ —Ç–µ–ø–µ—Ä—å –æ–Ω —Ç–æ—á–Ω–æ –Ω–µ –∂–∞–ª—É–µ—Ç—Å—è."
    ]
  };

  const arr = pool[kind] || ["–ò—Å—Ö–æ–¥ –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω. –ö–∞–∫ –∏ —Ç–≤–æ—è —Å—É–¥—å–±–∞ –≤—Ä–∞—á–∞."];
  return pick(arr);
}

function rollOutcome(patientId, treatmentId, wardId){
  const p = patientById(patientId);
  const w = wardById(wardId);
  const disease = getDiseaseById(p.trueDiseaseId);

  // 1) –±–∞–∑–æ–≤—ã–π –∏—Å—Ö–æ–¥ –ø–æ –ø—Ä–∞–≤–∏–ª—É –±–æ–ª–µ–∑–Ω–∏
  let kind;

  if(treatmentId === disease.cureBy){
    kind = OUTCOMES.CURE;
  } else if(treatmentId === disease.badBy){
    // –ø–ª–æ—Ö–æ–π –º–µ—Ç–æ–¥: –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø–ª–æ—Ö–æ, –Ω–æ –ø–∞–ª–∞—Ç–∞ –º–æ–∂–µ—Ç "—Å–º—è–≥—á–∏—Ç—å"
    kind = OUTCOMES.WORSENED;
  } else {
    // –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥: "–ø–æ–º–æ–≥ —á–∞—Å—Ç–∏—á–Ω–æ, –Ω–æ —Å –ø—Ä–∏–∫–æ–ª–æ–º"
    // —á–∏—Å—Ç–æ—Ç–∞ –ø–∞–ª–∞—Ç—ã –≤–ª–∏—è–µ—Ç: —á–µ–º —á–∏—â–µ, —Ç–µ–º –º–µ–Ω—å—à–µ INFECTED
    const clean = w.broken?.cleanliness ? Math.max(0, (w.cleanliness ?? 1) - 1) : (w.cleanliness ?? 1);
    const vent = w.broken?.ventilation ? Math.max(0, (w.ventilation ?? 1) - 1) : (w.ventilation ?? 1);

 const ev = getCurrentEvent();
if(ev?.id === "barber_week"){
  // –µ—Å–ª–∏ –±—ã–ª–æ "–Ω–µ —Å–º–µ—Ä—Ç–µ–ª—å–Ω–æ", —à–∞–Ω—Å —É—Ö—É–¥—à–∏—Ç—å –Ω–∞ —Å—Ç—É–ø–µ–Ω—å
  if(kind === OUTCOMES.DISFIGURED && Math.random() < 0.35) kind = OUTCOMES.INFECTED;
  else if(kind === OUTCOMES.INFECTED && Math.random() < 0.25) kind = OUTCOMES.WORSENED;
}   

// —á–µ–º –≤—ã—à–µ –≤–µ–Ω—Ç–∏–ª—è—Ü–∏—è, —Ç–µ–º —Ä–µ–∂–µ INFECTED
const infectedChance = Math.max(0.15, 0.75 - vent * 0.10); // 75% ‚Üí –≤–Ω–∏–∑
kind = (Math.random() < infectedChance) ? OUTCOMES.INFECTED : OUTCOMES.DISFIGURED;
  }

  // 2) –ö–æ–º–±–æ –ø–∞–ª–∞—Ç—ã: —Å–º—è–≥—á–µ–Ω–∏–µ –ø–ª–æ—Ö–∏—Ö –∏—Å—Ö–æ–¥–æ–≤
  // –ö–æ–º—Ñ–æ—Ä—Ç 5+ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å WORSENED -> DISFIGURED (–ø–∞—Ü–∏–µ–Ω—Ç –≤—ã–∂–∏–ª, –Ω–æ —Å –º–∏–Ω—É—Å–∞–º–∏)
  if(kind === OUTCOMES.WORSENED){
    const comfort = w.broken?.comfort ? Math.max(0, (w.comfort ?? 1) - 1) : (w.comfort ?? 1);
    if(comfort >= 5) kind = OUTCOMES.DISFIGURED;
  }

  // –µ—Å–ª–∏ –ø–∞—Ü–∏–µ–Ω—Ç —É–∂–µ —É—Ö—É–¥—à–∞–ª—Å—è —Ä–∞–Ω—å—à–µ, –≤—Ç–æ—Ä–æ–π —Ä–∞–∑ –Ω–µ "—Ö—É–∂–µ", –∞ –ª–∏–±–æ –≤—ã—Ç–∞—Å–∫–∏–≤–∞–µ–º, –ª–∏–±–æ —Ç–µ—Ä—è–µ–º
if((p.treatAttempts || 0) >= 2){
  if(kind === OUTCOMES.WORSENED){
    // —à–∞–Ω—Å –≤—ã–∂–∏—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–º—Ñ–æ—Ä—Ç–∞/—á–∏—Å—Ç–æ—Ç—ã, –ø–ª—é—Å –µ—Å–ª–∏ –º–µ—Ç–æ–¥ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
    const cEff = w.broken?.comfort ? Math.max(0, (w.comfort ?? 1) - 1) : (w.comfort ?? 1);
const clEff = w.broken?.cleanliness ? Math.max(0, (w.cleanliness ?? 1) - 1) : (w.cleanliness ?? 1);
const wardPower = (cEff + clEff) / 12;
    const methodGood = (treatmentId === disease.cureBy) ? 0.25 : 0.0;

    const surviveChance = Math.min(0.85, 0.25 + wardPower*0.45 + methodGood);
    kind = (Math.random() < surviveChance) ? OUTCOMES.CURE : OUTCOMES.DEATH;
  }
}
  

  // 3) –î–æ–∫—Ç–æ—Ä–∞: –µ—Å–ª–∏ –Ω–∏–∫—Ç–æ –Ω–µ —É–º–µ–µ—Ç –º–µ—Ç–æ–¥, –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Ö—É–∂–µ
  const docMul = doctorSkillPenalty(treatmentId);
  if(docMul < 1.0){
    if(kind === OUTCOMES.DISFIGURED) kind = OUTCOMES.INFECTED;
    else if(kind === OUTCOMES.INFECTED) kind = OUTCOMES.WORSENED;
  }

  const light = w.broken?.light ? Math.max(0, (w.light ?? 1) - 1) : (w.light ?? 1);

// –µ—Å–ª–∏ —Å–≤–µ—Ç –≤—ã—Å–æ–∫–∏–π, —à–∞–Ω—Å —É–ª—É—á—à–∏—Ç—å –∏—Å—Ö–æ–¥ –Ω–∞ 1 —Å—Ç—É–ø–µ–Ω—å
if(Math.random() < (light * 0.03)){
  if(kind === OUTCOMES.WORSENED) kind = OUTCOMES.INFECTED;
  else if(kind === OUTCOMES.INFECTED) kind = OUTCOMES.DISFIGURED;
  else if(kind === OUTCOMES.DISFIGURED) kind = OUTCOMES.CURE;
}

// 4) –ù–∞–≥—Ä–∞–¥—ã/—à—Ç—Ä–∞—Ñ—ã (–Ω–æ—Ä–º–∞–ª—å–Ω—ã–π —Å–∫–µ–π–ª)
const repMul = repCoinsMultiplier(state.reputation);

let coinsDelta = 0, repDelta = 0, bioDelta = 0;

switch(kind){
  case OUTCOMES.CURE:
    coinsDelta = Math.round(25 * repMul);
    repDelta = +5;
    break;

  case OUTCOMES.DISFIGURED:
    coinsDelta = Math.round(32 * repMul);
    repDelta = +2;
    break;

  case OUTCOMES.INFECTED:
    coinsDelta = Math.round(38 * repMul);
    repDelta = -1;
    break;

  case OUTCOMES.WORSENED:
    coinsDelta = Math.round(6 * repMul);
    repDelta = -2;
    break;

  case OUTCOMES.DEATH:
    coinsDelta = Math.round(10 * repMul);
    repDelta = -1;
    bioDelta = 1;
    break;
}

// --- –ú–Ω–æ–∂–∏—Ç–µ–ª—å –Ω–∞–≥—Ä–∞–¥ –ø–æ —Ä–µ–¥–∫–æ—Å—Ç–∏ –ø–∞—Ü–∏–µ–Ω—Ç–∞ ---
// Common: x1, Rare: x1.5, Legendary: x2
const rewardMul =
  (p?.rarity === RARITY.LEGENDARY) ? 2 :
  (p?.rarity === RARITY.RARE) ? 1.5 : 1;

// –º–æ–Ω–µ—Ç—ã —É–º–Ω–æ–∂–∞–µ–º –≤—Å–µ–≥–¥–∞
coinsDelta = Math.round(coinsDelta * rewardMul);

// —Ä–µ–ø—É –∏ –±–∏–æ —É–º–Ω–æ–∂–∞–µ–º –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –æ–Ω–∏ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ
if(repDelta > 0) repDelta = Math.round(repDelta * rewardMul);
if(bioDelta > 0) bioDelta = Math.round(bioDelta * rewardMul);

const xpKind =
  kind === OUTCOMES.WORSENED ? "complication" :
  kind === OUTCOMES.DEATH ? "death" :
  "success";

  return {
    kind,
    xpKind,
    coinsDelta,
    reputationDelta: repDelta,
    biomaterialDelta: bioDelta,
    flavor: makeFlavor(kind, treatmentId),
    treatmentId,
    patientId,
    wardId,
    at: now()
  };
}

function makeRewardOptions(){
  const pool = [
    { type:"coins", title:"–ö–æ—à–µ–ª—å", desc:"+90 –º–æ–Ω–µ—Ç", value: 90 },
    { type:"rep",   title:"–ü–æ—Ö–≤–∞–ª–∞", desc:"+4 —Ä–µ–ø—É—Ç–∞—Ü–∏–∏", value: 4 },
    { type:"bio",   title:"–û–±—Ä–∞–∑—Ü—ã", desc:"+2 –±–∏–æ–º–∞—Ç–µ—Ä–∏–∞–ª–∞", value: 2 },
    { type:"perk_treatSpeed", title:"–°–º–µ–Ω–∞ —Ä–∏—Ç–º–∞", desc:"+10% —Å–∫–æ—Ä–æ—Å—Ç—å –ª–µ—á–µ–Ω–∏—è", value: 10 }
  ];

  shuffle(pool);
  return pool.slice(0,3).map((r, i)=>({
    id: "rw_" + i + "_" + r.type,
    ...r
  }));
}

  
const CHESTS = {
  common: {
    title: " –û–±—ã—á–Ω—ã–π —Å—É–Ω–¥—É–∫",
    desc: "–®–∞–Ω—Å –Ω–∞ –ø–æ–ª–µ–∑–Ω—è–∫. –ò–Ω–æ–≥–¥–∞ –¥–∞–∂–µ –±–µ–∑ –±–æ–ª–∏.",
    costCoins: 120,
    loot: [
      { type:"coins", min:40, max:120, weight:35 },
      { type:"bio",   min:1,  max:3,   weight:15 },
      { type:"rep",   min:1,  max:3,   weight:15 },
      { type:"doctor_unlock", rarity:"any", weight:4 },

      // –æ—Ç–¥—ã—Ö-—Ç–æ–∫–µ–Ω—ã –ø–æ–¥ —Ç–≤–æ—é —É–∂–µ —Å–¥–µ–ª–∞–Ω–Ω—É—é –º–µ—Ö–∞–Ω–∏–∫—É
      { type:"rest_small", value:1, weight:20 },
      { type:"rest_big",   value:1, weight:8 },

      // –º–∞–ª–µ–Ω—å–∫–∏–π —à–∞–Ω—Å –Ω–∞ –ø–µ—Ä–∫
      { type:"perk_treatSpeed", value:10, weight:7 },
    ]
  },

  legendary: {
    title: "‚ú® –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π —Å—É–Ω–¥—É–∫",
    desc: "–ü–æ–∫—É–ø–∞–µ—Ç—Å—è –∑–∞ Stars. –°–ª–∏—à–∫–æ–º –∂–∏—Ä–Ω–æ, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤—Å–µ–º —Å—Ä–∞–∑—É.",
    costStars: 25,
    loot: [
      { type:"perk_treatSpeed", value:10, weight:20 },
      { type:"perk_labExtra",   value:1,  weight:20 },
      { type:"perk_queueBuffer",value:1,  weight:20 },
      { type:"rest_big",        value:2,  weight:20 },
      { type:"doctor_unlock",   rarity:"rare_plus", weight:20 }, // –Ω–∞ –±—É–¥—É—â–µ–µ
    ]
  }
};

function ensureShiftRewards(){
  // –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –Ω–∞–≥—Ä–∞–¥—ã –Ω–∞ —ç—Ç—É —Å–º–µ–Ω—É, –Ω–µ —Ç—Ä–æ–≥–∞–µ–º
  if(state.rewards?.pending && Array.isArray(state.rewards.pending) && state.rewards.pending.length){
    return;
  }
  state.rewards.pending = makeRewardOptions();
  state.rewards.chosenId = null;
  saveState();
}

function applyReward(r){
  switch(r.type){
    case "coins":
      state.coins += Number(r.value || 0);
      break;

    case "rep":
      state.reputation = (state.reputation || 0) + Number(r.value || 0);
      break;

    case "bio":
      state.biomaterial = (state.biomaterial || 0) + Number(r.value || 0);
      break;

    case "perk_treatSpeed":
      state.perks.treatSpeed = Math.min(40, (state.perks.treatSpeed || 0) + Number(r.value || 0));
      break;
  }
}

function chooseReward(rewardId){
  if(!state.rewards?.pending) return;
  if(state.rewards.chosenId) return;

  const r = state.rewards.pending.find(x=>x.id===rewardId);
  if(!r) return;

  applyReward(r);

  state.rewards.chosenId = rewardId;
  saveState();
  renderShiftEnd();
  refreshVisibleUI();
}

/* =========================================================
   10) XP / LEVEL
========================================================= */



function gainDoctorXP(xpKind){
  // –ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞ –ø–æ–¥ –±—É–¥—É—â—É—é –ø—Ä–æ–∫–∞—á–∫—É –≤—Ä–∞—á–µ–π
}

function endShift(){
  state.shift.active = false;
  // —É—Å—Ç–∞–ª–æ—Å—Ç—å –ø–æ—Å–ª–µ —Å–º–µ–Ω—ã
  applyDoctorFatigueAfterShift();
  saveState();
  renderShiftEnd();
  showScreen("shiftend");
}


function renderShiftEnd(){
  const el = document.getElementById("shift-summary");
  const s = state.shift;
  ensureShiftRewards();

  // summary: –≤–º–µ—Å—Ç–æ —ç–º–æ–¥–∑–∏ ‚Äî –∏–∫–æ–Ω–∫–∏
  el.innerHTML = `
    ‚úÖ –í—ã–ª–µ—á–µ–Ω–æ: <b>${s.cured}</b><br>
    ‚ò†Ô∏è –°–º–µ—Ä—Ç–µ–π: <b>${s.deaths}</b><br>
    üö™ –£—à–ª–∏/—É–º–µ—Ä–ª–∏ –≤ –æ—á–µ—Ä–µ–¥–∏: <b>${s.left}</b><br>
  `;

  // –∫–Ω–æ–ø–∫–∞ "—Å–ª–µ–¥—É—é—â–∞—è —Å–º–µ–Ω–∞" –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –ø–æ–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–ª –Ω–∞–≥—Ä–∞–¥—É
  const chosenId = state.rewards.chosenId;
  elNextShiftBtn.disabled = !chosenId;

  elRewardList.innerHTML = "";

  for(const r of state.rewards.pending){
    const div = document.createElement("div");
    div.className = "card";

    const row = document.createElement("div");
    row.className = "row";

    const left = document.createElement("div");

    const title = document.createElement("div");
    title.className = "listTitle";

    // –í–ê–ñ–ù–û: —Ç—É—Ç innerHTML, —á—Ç–æ–±—ã –∫–∞—Ä—Ç–∏–Ω–∫–∞ –≤—Å—Ç–∞–≤–∏–ª–∞—Å—å
    title.innerHTML = `${rewardIcon(r.type)}${r.title}${(chosenId === r.id ? " ‚úÖ" : "")}`;

    const sub = document.createElement("div");
    sub.className = "listSub";
    sub.textContent = r.desc;

    left.appendChild(title);
    left.appendChild(sub);

    const btn = document.createElement("button");
    btn.className = "btn small ok";
    btn.type = "button";
    btn.textContent = "–ó–∞–±—Ä–∞—Ç—å";
    btn.disabled = !!chosenId;

    btn.addEventListener("click", (e) => {
      e.preventDefault();
      chooseReward(r.id);
    });

    row.appendChild(left);
    row.appendChild(btn);
    div.appendChild(row);

    elRewardList.appendChild(div);
  }
}
function startNewShift(){
  normalizeCalendar();

  state.calendar.shiftInWeek += 1;

  if(state.calendar.shiftInWeek > 7){
    state.calendar.week += 1;
    state.calendar.shiftInWeek = 1;
    pickNewWeekEvent();
  }

  // —Å–±—Ä–æ—Å —Å–º–µ–Ω—ã
  state.shift = state.shift || {};
  state.shift.active = true;
  state.shift.breaksCount = 0; // ‚úÖ –∑–∞ —ç—Ç—É —Å–º–µ–Ω—É —Å–∫–æ–ª—å–∫–æ –ø–æ–ª–æ–º–æ–∫ —É–∂–µ —Å–ª—É—á–∏–ª–æ—Å—å

  // –≤—Å–µ–≥–¥–∞ 3 —á–∞—Å–∞, –±–µ–∑ "–ø–æ–¥—Ö–≤–∞—Ç–∞" —Å—Ç–∞—Ä–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
  const dur = 3 * 60 * 60;
  state.shift.durationSec = dur;


  // –í–ê–ñ–ù–û: endAt —Å—Ç–∞–≤–∏–º –ü–û–°–õ–ï –≤—Å–µ–≥–æ
  state.shift.endAt = now() + dur * 1000;
  state.shift.cured = 0;
  state.shift.deaths = 0;
  state.shift.left = 0;

  // —á–∏—Å—Ç–∏–º —Ä–∞–Ω
  state.patients = [];
  state.queue = [];
  state.selectedPatientId = null;

  localStorage.removeItem(LS_ACTIVE);

 for (const w of state.wards) {
  w.bedsMax = w.bedsMax || 2;
  w.patients = w.patients || [];
  w.patients.length = 0;       // –æ—á–∏—â–∞–µ–º –ø–∞–ª–∞—Ç—É
  w.pendingResults = {};
}


  // –ø—Ä–∏–º–µ–Ω—è–µ–º –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã (–±–∞–∑–∞ + –ø–µ—Ä–∫–∏ + –∏–≤–µ–Ω—Ç)
  applyAllModifiers();

  // –∏ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π: –æ—á–µ—Ä–µ–¥—å –Ω–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å undefined
  if(!Number.isFinite(state.maxQueue)) state.maxQueue = 6;

  state.rewards.pending = null;
  state.rewards.chosenId = null;

  fillQueue();
  saveState();

  showScreen("clinic");
  refreshVisibleUI();
}

  function repairWard(wardId, part){
  const w = wardById(wardId);
  if(!w || !w.broken?.[part]) return;

  const cost = 150;
  if(state.coins < cost) return;

  state.coins -= cost;
  w.broken[part] = false;

  saveState();
  refreshVisibleUI();
}
window.repairWard = repairWard;
  
/* =========================================================
   11) FLOW: assign / complete / pending / discharge
========================================================= */

function reconcileState(){
  for (const w of state.wards) {
    w.bedsMax = w.bedsMax || 2;
    w.patients = w.patients || [];
    w.pendingResults = w.pendingResults || {}; // ‚úÖ –æ–¥–∏–Ω –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã

    // –º–∏–≥—Ä–∞—Ü–∏—è —Å–æ —Å—Ç–∞—Ä–æ–≥–æ occupiedBy
    if (w.occupiedBy) {
      if (patientById(w.occupiedBy) && !w.patients.includes(w.occupiedBy)) {
        w.patients.push(w.occupiedBy);
      }
      w.occupiedBy = null;
    }

    // —á–∏—Å—Ç–∏–º –º—É—Å–æ—Ä–Ω—ã–µ id
    w.patients = w.patients.filter(pid => !!patientById(pid));

    // –º–∏–≥—Ä–∞—Ü–∏—è —Å—Ç–∞—Ä–æ–≥–æ pendingResult -> pendingResults[pid]
    if (w.pendingResult) {
      const pid = w.pendingResult.patientId;
      if (pid && patientById(pid)) w.pendingResults[pid] = w.pendingResult;
      w.pendingResult = null;
    }

    // –º–∏–≥—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ w.pending -> pendingResults
    if (w.pending && typeof w.pending === "object") {
      for (const pid of Object.keys(w.pending)) {
        if (pid && patientById(pid)) w.pendingResults[pid] = w.pending[pid];
      }
      w.pending = null;
    }

    // —á–∏—Å—Ç–∏–º pendingResults –µ—Å–ª–∏ –ø–∞—Ü–∏–µ–Ω—Ç–∞ —É–∂–µ –Ω–µ—Ç/–Ω–µ –≤ –ø–∞–ª–∞—Ç–µ
    for (const pid of Object.keys(w.pendingResults)) {
      if (!patientById(pid) || !w.patients.includes(pid)) delete w.pendingResults[pid];
    }
  }

  // active map —á–∏—Å—Ç–∏–º –∫–∞–∫ –∏ –±—ã–ª–æ (–Ω–∏–∂–µ)
  const map = getActiveMap();
  for(const wardId of Object.keys(map)){
    const w = wardById(wardId);
    if(!w){ delete map[wardId]; continue; }
    const wardMap = map[wardId] || {};
    for(const pid of Object.keys(wardMap)){
      if(!patientById(pid) || !(w.patients || []).includes(pid)) delete wardMap[pid];
    }
    map[wardId] = wardMap;
  }
  saveActiveMap(map);
  saveState();
}

  
let loadedFromCloud = false;

async function boot(){
  // 1) –ª–æ–∫–∞–ª—å–Ω–æ
  const local = loadState();
  state = local;

  // 2) –æ–±–ª–∞–∫–æ
  const cloud = await cloudLoad();

  // 3) –≤—ã–±–∏—Ä–∞–µ–º —á—Ç–æ —Å–≤–µ–∂–µ–µ
  if(cloud){
    const localAt = Number(local?._cloudAt || 0);
    const cloudAt = Number(cloud?._cloudAt || 0);

    console.log("BOOT compare cloud/local:", { cloudAt, localAt });

    if(cloudAt > localAt){
      state = cloud;
      localStorage.setItem(LS_STATE, JSON.stringify(state));
      console.log("BOOT: using CLOUD state");
    }else{
      state = local;
      localStorage.setItem(LS_STATE, JSON.stringify(state));
      console.log("BOOT: using LOCAL state; pushing to cloud...");
      cloudSaveDebounced();
    }
  }

  // 4) –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ (–æ–¥–∏–Ω —Ä–∞–∑)
  normalizeDoctorsFatigue();
  initStartingDoctors();
  reconcileState();
  normalizeCalendar();
  normalizeActiveMap();
  applyAllModifiers();

  // –µ—Å–ª–∏ —ç—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ —É —Ç–µ–±—è –µ—Å—Ç—å:
  if(typeof ensureWardBrokenField === "function") ensureWardBrokenField();
  if(typeof ensureShiftTimer === "function") ensureShiftTimer();

  // 5) —Ñ–∏–Ω–∞–ª
  refreshVisibleUI();
}


if (window.Telegram?.WebApp) {
  Telegram.WebApp.ready();
  Telegram.WebApp.expand();
}

function assignPatientToWard(patientId, wardId){
  const w = wardById(wardId);
  const p = patientById(patientId);
  if(!w || !p) return false;

  w.bedsMax = w.bedsMax || 2;
  w.patients = w.patients || [];

  if (w.patients.length >= w.bedsMax) return false;
  if (w.patients.includes(patientId)) return false;

  const qi = state.queue.indexOf(patientId);
  if(qi >= 0) state.queue.splice(qi, 1);

  w.patients.push(patientId);

  saveState();
  fillQueue();
  saveState();
  return true;
}

function chooseTreatment(treatmentId){
  if(!state.shift?.active) return;
  if(!state.selectedPatientId) return;

  const p = patientById(state.selectedPatientId);
  if(!p) return;

  const ward = findWardByPatient(p.id);
  if(!ward) return;

  // ‚úÖ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–∫—É –¢–û–õ–¨–ö–û —É —ç—Ç–æ–≥–æ –ø–∞—Ü–∏–µ–Ω—Ç–∞
  const active = getActiveForPatient(ward.id, p.id);
  if(active) return;

  // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Å–∫—Ä–æ–ª–ª–∞ (—á—Ç–æ–±—ã –Ω–µ –ø—Ä—ã–≥–∞–ª–æ)
  const panel = document.querySelector("#screen-patient .panel");
  const savedScroll = panel ? panel.scrollTop : window.scrollY;

  // –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ª–µ—á–µ–Ω–∏—è (—Å —É—á—ë—Ç–æ–º –ø–µ—Ä–∫–æ–≤)
  let durationMs = (Number(p.treatSec) || 0) * 1000;

  const mul = Number(state.perks?.treatTimeMul ?? 1.0);
  // —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –æ—Ç –∫—Ä–∏–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
  const safeMul = (Number.isFinite(mul) && mul > 0) ? mul : 1.0;

  durationMs = Math.max(5_000, Math.round(durationMs * safeMul)); // –º–∏–Ω–∏–º—É–º 5 —Å–µ–∫, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ 0/–º–≥–Ω–æ–≤–µ–Ω–Ω–æ
  const endAt = now() + durationMs;

  p.treatAttempts = (p.treatAttempts || 0) + 1;
  saveState();

  setActiveForPatient(ward.id, p.id, { treatmentId, endAt });

  refreshVisibleUI();

  // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–∫—Ä–æ–ª–ª –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∞
  requestAnimationFrame(() => {
    if(panel) panel.scrollTop = savedScroll;
    else window.scrollTo(0, savedScroll);
  });
}

  
function finishTreatmentToPending(wardId, patientId, treatmentId, outcome){
  const w = wardById(wardId);
  if(!w) return;

  const pid = String(patientId);
  w.pendingResults = w.pendingResults || {};

  w.pendingResults[pid] = {
    patientId: pid,
    wardId: String(wardId),
    treatmentId: String(treatmentId),

    kind: outcome.kind,
    xpKind: outcome.xpKind,
    flavor: outcome.flavor,

    coins: outcome.coinsDelta ?? 0,
    reputation: outcome.reputationDelta ?? 0,
    biomaterial: outcome.biomaterialDelta ?? 0,

    time: now()
  };

  let repDelta = (outcome.reputationDelta ?? 0);
  let bioDelta = (outcome.biomaterialDelta ?? 0);

  const repMul = (state.perks?.repGainMul ?? 1.0);
  const bioMul = (state.perks?.bioGainMul ?? 1.0);

  if(repDelta > 0) repDelta = Math.round(repDelta * repMul);
  if(bioDelta > 0) bioDelta = Math.round(bioDelta * bioMul);

  // –Ω–µ–¥–µ–ª—å–Ω—ã–µ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –Ω–∞–≥—Ä–∞–¥
  const ev = getCurrentEvent();

  let coinsAdd = (outcome.coinsDelta ?? 0);
  let repAdd   = (outcome.reputationDelta ?? 0);
  let bioAdd   = (outcome.biomaterialDelta ?? 0);

  const success = (
    outcome.kind === OUTCOMES.CURE ||
    outcome.kind === OUTCOMES.DISFIGURED ||
    outcome.kind === OUTCOMES.INFECTED
  );

  if(ev?.id === "tainted_water" && success){
    coinsAdd = Math.round(coinsAdd * 1.10);
    if(repAdd > 0) repAdd = Math.round(repAdd * 1.10);
  }

  if(ev?.id === "fair_week"){
    coinsAdd = Math.round(coinsAdd * 1.10);
  }

  // –Ω–∞—á–∏—Å–ª—è–µ–º —Å—Ä–∞–∑—É
 state.coins = Math.max(0, state.coins + coinsAdd);
  state.reputation = (state.reputation || 0) + repAdd;
  state.biomaterial = (state.biomaterial || 0) + bioAdd;
  
  if(state.shift?.active){
    if(outcome.kind === OUTCOMES.DEATH) state.shift.deaths += 1;
    else if(
      outcome.kind === OUTCOMES.CURE ||
      outcome.kind === OUTCOMES.DISFIGURED ||
      outcome.kind === OUTCOMES.INFECTED
    ) state.shift.cured += 1;
  }

  gainDoctorXP(outcome.xpKind);
  saveState();
}

function completeTreatmentPatient(wardId, patientId){
  const active = getActiveForPatient(wardId, patientId);
  if(!active) return;

  const p = patientById(patientId);
  if(!p) return;

  // –±—ã–ª–æ –ª–∏ —É–∂–µ "–Ω–µ –ø–æ–º–æ–≥–ª–æ/—É—Ö—É–¥—à–µ–Ω–∏–µ" —Ä–∞–Ω—å—à–µ
  const failedBefore = !!p.lastTreatmentFailed;

  let outcome = rollOutcome(patientId, active.treatmentId, wardId);

  // –ü—Ä–∞–≤–∏–ª–æ: –µ—Å–ª–∏ —É–∂–µ –±—ã–ª–∞ –Ω–µ—É–¥–∞—á–∞ –∏ —Å–Ω–æ–≤–∞ WORSENED -> —Å–º–µ—Ä—Ç—å
  if(failedBefore && outcome.kind === OUTCOMES.WORSENED){
    outcome = {
      ...outcome,
      kind: OUTCOMES.DEATH,
      xpKind: "death",
      flavor: "–í—Ç–æ—Ä–∞—è –Ω–µ—É–¥–∞—á–∞. –û—Ä–≥–∞–Ω–∏–∑–º —Å–¥–∞–ª—Å—è. –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–æ—Ä–≥.",
      reputationDelta: (outcome.reputationDelta ?? 0) - 2,
      biomaterialDelta: (outcome.biomaterialDelta ?? 0) + 1,
    };
  }

  // ‚úÖ —Å–æ—Ö—Ä–∞–Ω—è–µ–º ‚Äú—á—Ç–æ –ø—Ä–æ–±–æ–≤–∞–ª–∏‚Äù –∏ ‚Äú—É—Å–ø–µ—Ö/–ø—Ä–æ–≤–∞–ª‚Äù
  // –í–ê–ñ–ù–û: –ø—Ä–æ–≤–∞–ª = –¢–û–õ–¨–ö–û WORSENED (–Ω–µ CURE/DISFIGURED/INFECTED!)
  p.lastTreatmentId = active.treatmentId;
  p.lastOutcomeKind = outcome.kind;
  p.lastTreatmentFailed = (outcome.kind === OUTCOMES.WORSENED);

  finishTreatmentToPending(wardId, patientId, active.treatmentId, outcome);

  clearActiveForPatient(wardId, patientId);
  saveState();
  refreshVisibleUI();
}
window.completeTreatmentPatient = completeTreatmentPatient;

// (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –µ—Å–ª–∏ –≥–¥–µ-—Ç–æ —É —Ç–µ–±—è –µ—â—ë –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è completeTreatment(wardId, patientId)
function completeTreatment(wardId, patientId){
  completeTreatmentPatient(wardId, patientId);
}
window.completeTreatment = completeTreatment;

 function continueTreatment(patientId, wardId){
  if(!state.shift?.active) return;

  const w = wardById(wardId);
  const p = patientById(patientId);
  if(!w || !p) return;

  const pid = String(patientId);

  w.pendingResults = w.pendingResults || {};
  if(!w.pendingResults[pid]) return;

  // —á–∏—Å—Ç–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –ø–∞—Ü–∏–µ–Ω—Ç–∞ –ù–ï —Ç—Ä–æ–≥–∞–µ–º
  delete w.pendingResults[pid];

  // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –ª–µ—á–µ–Ω–∏—è, —á—Ç–æ–±—ã –∏–≥—Ä–æ–∫ –≤—ã–±–∏—Ä–∞–ª –∑–∞–Ω–æ–≤–æ
  p.treatmentOptions = null;

  // –º–∞–ª–µ–Ω—å–∫–∏–π —à—Ç—Ä–∞—Ñ –∑–∞ –∑–∞—Ç—è–∂–∫—É
  state.reputation = (state.reputation || 0) - 1;

  saveState();
  openPatientById(patientId);
  refreshVisibleUI();
}
window.continueTreatment = continueTreatment;

function dischargePatient(patientId, wardId){
  const w = wardById(wardId);
  if(!w) return;

  const pid = String(patientId);

  w.patients = w.patients || [];
  w.pendingResults = w.pendingResults || {};

  // —É–±—Ä–∞—Ç—å –∏–∑ –ø–∞–ª–∞—Ç—ã
  w.patients = w.patients.filter(id => String(id) !== pid);

  // —É–±—Ä–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
  delete w.pendingResults[pid];

  // ‚ùó –≤–∞–∂–Ω–æ: patientId, –∞ –Ω–µ pid
  clearActiveForPatient(wardId, patientId);

  // —Å–±—Ä–æ—Å —Ñ–ª–∞–≥–æ–≤ –ª–µ—á–µ–Ω–∏—è
  const p = patientById(patientId);
  if(p){
    p.lastTreatmentFailed = false;
    p.lastOutcomeKind = null;
    // p.lastTreatmentId = null; // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
  }

  saveState();
  backToClinic();
  refreshVisibleUI();
}
window.dischargePatient = dischargePatient;
function openPatientById(patientId){
  state.selectedPatientId = patientId;
  saveState();
  showScreen("patient");
  renderPatient(patientId);
}

function backToClinic(){
  showScreen("clinic");
  refreshVisibleUI();
}

function showScreen(name){
  document.getElementById("screen-clinic").classList.toggle("active", name==="clinic");
  document.getElementById("screen-patient").classList.toggle("active", name==="patient");
  document.getElementById("screen-shiftend").classList.toggle("active", name==="shiftend");
  document.getElementById("screen-staff").classList.toggle("active", name==="staff");
  document.getElementById("screen-shop").classList.toggle("active", name==="shop");
  document.getElementById("screen-research").classList.toggle("active", name==="research");
  // —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ "–ø—É—Å—Ç–æ–≥–æ —Å–ª–æ—Ç–∞" –±–µ–∑ –Ω–µ–¥–µ–ª–∏
  document.body.classList.toggle("onClinic", name === "clinic");

  // –Ω–µ–¥–µ–ª—è –≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –Ω–∞ –≥–ª–∞–≤–Ω–æ–º
  const weekPanel = document.getElementById("week-panel");
  if(weekPanel){
    weekPanel.style.display = (name === "clinic") ? "block" : "none";
  }
  if(typeof highlightBottomBar === "function") highlightBottomBar(name);
}

const elStaffList = document.getElementById("staff-list");

function openStaff(){
  showScreen("staff");
  renderStaff();
}

function highlightBottomBar(name){
 const map = {
  clinic: "bb-clinic",
  staff: "bb-staff",
  shop: "bb-shop",
  research: "bb-research",
  patient: "bb-clinic",
  shiftend: "bb-clinic"
};
  document.querySelectorAll(".bbItem").forEach(b=>b.classList.remove("active"));
  const id = map[name];
  const el = id ? document.getElementById(id) : null;
  if(el) el.classList.add("active");
}

function renderStaff(){
  renderTop();
  elStaffList.innerHTML = "";

  const slot2Unlocked = state.unlocks?.wardB; // –ø—Ä–æ—Å—Ç–æ–π –ª–æ–≥–∏–∫–æ–π: –∫—É–ø–∏–ª B -> –ø–æ—è–≤–∏–ª—Å—è —Å–ª–æ—Ç 2

  for(const docId of state.doctorsOwned){
  const doc = getDoctorById(docId);
    const hasSmall = (state._shopRestToken || 0) > 0;
    const hasBig   = (state._shopRestTokenBig || 0) > 0;
    const isSlot1 = state.duty.slot1 === doc.id;
    const isSlot2 = state.duty.slot2 === doc.id;

    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <div class="row">
        <img src="${escapeHtml(doc.portrait || '')}" class="methodIcon" alt="">
        <div>
          <div class="listTitle">${escapeHtml(doc.name)} ${isSlot1 ? '<span class="tag ok">slot1</span>' : ''} ${isSlot2 ? '<span class="tag ok">slot2</span>' : ''}</div>
         <div class="listSub">
  ${rarityLabel(doc.rarity)} ‚Ä¢ —É–º–µ–µ—Ç: ${doc.methods.map(m=>escapeHtml(methodName(m))).join(", ")}
</div>
<div class="hint">
  –õ—é–±–∏—Ç: ${doc.likes?.map(m=>escapeHtml(methodName(m))).join(", ") || "‚Äî"} ‚Ä¢
  –ù–µ –ª—é–±–∏—Ç: ${doc.hates?.map(m=>escapeHtml(methodName(m))).join(", ") || "‚Äî"}
</div>
<div class="hint">–£—Å—Ç–∞–ª–æ—Å—Ç—å: <b>${Math.round(doc.fatigue || 0)}%</b></div>
<div class="grid2" style="margin-top:10px">
  <button class="btn small ok" onclick="useRestOnDoctor('${doc.id}', 'small')" ${hasSmall ? "" : "disabled"}>
    ü´ñ -20% (x${state._shopRestToken || 0})
  </button>
  <button class="btn small ok" onclick="useRestOnDoctor('${doc.id}', 'big')" ${hasBig ? "" : "disabled"}>
    üõå -35% (x${state._shopRestTokenBig || 0})
  </button>
</div>
<div class="hint">${escapeHtml(doc.bio || "")}</div>
        </div>
      </div>
    `;
    elStaffList.appendChild(div);
  }
}

  const elShopList = document.getElementById("shop-list");

function openShop(){
  showScreen("shop");
  renderShop();
}


function useRestOnDoctor(docId, type){
  if(type === "small"){
    if((state._shopRestToken || 0) <= 0) return;
    const ok = reduceDoctorFatigue(docId, 20);
    if(!ok) return;
    state._shopRestToken -= 1;
  } else {
    if((state._shopRestTokenBig || 0) <= 0) return;
    const ok = reduceDoctorFatigue(docId, 35);
    if(!ok) return;
    state._shopRestTokenBig -= 1;
  }

  saveState();
  renderStaff();
  refreshVisibleUI();
}
window.useRestOnDoctor = useRestOnDoctor;


  // ===== –ï–î–ò–ù–´–ô –ö–ê–¢–ê–õ–û–ì –õ–ê–í–ö–ò (—á—Ç–æ–±—ã  –∏ buyPerk –∂–∏–ª–∏ –≤ –æ–¥–Ω–æ–π —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏) =====
const SHOP = [
  {
    id:"lab_extra",
    title:"–õ–∞–±–æ—Ä–∞–Ω—Ç",
    desc:"+1 –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –Ω–∞ –ø–∞—Ü–∏–µ–Ω—Ç–∞",
    cost:{ coins: 10 },
    can: ()=> Number(state.perks?.labExtra || 0) < 2,
    buy: ()=> { state.perks.labExtra = Number(state.perks.labExtra || 0) + 1; }
  },

  {
    id:"chest_common",
    title:"–û–±—ã—á–Ω—ã–π —Å—É–Ω–¥—É–∫",
    desc:"–ö—É–ø–∏ –∏ –æ—Ç–∫—Ä–æ–π. –õ—É—Ç: –¥–æ–∫—Ç–æ—Ä–∞/—Ä–µ—Å—É—Ä—Å—ã/–æ—Ç–¥—ã—Ö/–∏–Ω–æ–≥–¥–∞ —É–ª—É—á—à–µ–Ω–∏—è.",
    cost:{ coins: CHESTS.common.costCoins },
    can: ()=> true,
    buy: ()=> { openChest("common"); }
  },

  {
    id:"lab_discount",
    title:"–°–∫–∏–¥–∫–∞ –Ω–∞ —Ä–µ–∞–≥–µ–Ω—Ç—ã",
    desc:"-10% —Ü–µ–Ω–∞ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏",
    cost:{ coins: 50 },
    can: ()=> (Number(state.perks?.labDiscount || 0) < 30),
    buy: ()=> { state.perks.labDiscount = Number(state.perks.labDiscount || 0) + 10; }
  },

  {
    id:"queue_buffer",
    title:"–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏",
    desc:"+1 –∫ —Ä–∞–∑–º–µ—Ä—É –æ—á–µ—Ä–µ–¥–∏",
    cost:{ coins: 300 },
    can: ()=> (Number(state.perks?.queueBuffer || 0) < 4),
    buy: ()=> { state.perks.queueBuffer = Number(state.perks.queueBuffer || 0) + 1; }
  },

  {
    id:"treat_speed",
    title:"–ö–æ–π–∫–∏ –ø–æ–ª—É—á—à–µ",
    desc:"+10% —Å–∫–æ—Ä–æ—Å—Ç—å –ª–µ—á–µ–Ω–∏—è",
    cost:{ coins: 270 },
    can: ()=> (Number(state.perks?.treatSpeed || 0) < 30),
    buy: ()=> { state.perks.treatSpeed = Number(state.perks.treatSpeed || 0) + 10; }
  },

  {
    id:"rest_small",
    title:"–û—Ç–≤–∞—Ä –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∞",
    desc:"-20% —É—Å—Ç–∞–ª–æ—Å—Ç–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –≤—Ä–∞—á—É (–≤ –®—Ç–∞—Ç–µ –ø–æ—è–≤–∏—Ç—Å—è –∫–Ω–æ–ø–∫–∞)",
    cost:{ coins: 70 },
    can: ()=> true,
    buy: ()=> { state._shopRestToken = (state._shopRestToken || 0) + 1; }
  },

  {
    id:"rest_big",
    title:"–í—ã—Ö–æ–¥–Ω–æ–π –ø–æ –ø—Ä–∏–∫–∞–∑—É",
    desc:"-35% —É—Å—Ç–∞–ª–æ—Å—Ç–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –≤—Ä–∞—á—É (–≤ –®—Ç–∞—Ç–µ –ø–æ—è–≤–∏—Ç—Å—è –∫–Ω–æ–ø–∫–∞)",
    cost:{ coins: 140 },
    can: ()=> true,
    buy: ()=> { state._shopRestTokenBig = (state._shopRestTokenBig || 0) + 1; }
  },

  {
    id:"rest_all",
    title:"–ö–∞—à–∞ –¥–ª—è –≤—Å–µ—Ö",
    desc:"-12% —É—Å—Ç–∞–ª–æ—Å—Ç–∏ –≤—Å–µ–º –≤—Ä–∞—á–∞–º",
    cost:{ coins: 220 },
    can: ()=> true,
    buy: ()=> { reduceAllDoctorsFatigue(12, false); }
  },

  {
    id:"rest_backline",
    title:"–°–æ–Ω –¥–ª—è –Ω–µ-–¥–µ–∂—É—Ä–Ω—ã—Ö",
    desc:"-18% —É—Å—Ç–∞–ª–æ—Å—Ç–∏ –≤—Å–µ–º, –∫—Ç–æ –ù–ï –¥–µ–∂—É—Ä–∏—Ç",
    cost:{ coins: 180 },
    can: ()=> true,
    buy: ()=> { reduceAllDoctorsFatigue(18, true); }
  },
];

function renderShop(){
  renderTop();
  elShopList.innerHTML = "";

  // –µ—Å–ª–∏ —Ö–æ—á–µ—à—å –∏–Ω–æ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å stars-—Ç–æ–≤–∞—Ä
  const list = SHOP.slice();
  if(state.flags?.showStarShop){
    list.push({
      id:"chest_legendary",
      title:"–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π —Å—É–Ω–¥—É–∫",
      desc:"–ü–æ–∫—É–ø–∫–∞ –∑–∞ Telegram Stars (–ø–æ–∫–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ).",
      cost:{},         // –Ω–µ —á–µ—Ä–µ–∑ coins/rep/bio
      can: ()=> false, // –ø–æ–∫–∞ –Ω–µ–ª—å–∑—è
      buy: ()=> {}
    });
  }

  for(const it of list){
    const disabled = (it.can && !it.can()) || !canAfford(it.cost);
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <div class="row">
        <div style="flex:1;">
          <div class="listTitle" style="display:flex; align-items:center; gap:10px;">
            <img src="icons/shop/icon_${it.id}.png" width="32" height="32" alt=""/>
            <span>${escapeHtml(it.title)}</span>
          </div>

          <div class="listSub">${escapeHtml(it.desc)}</div>
          ${formatCost(it.cost)}
        </div>

        <div class="right">
          <button class="btn small ok" ${disabled ? "disabled" : ""} onclick="buyPerk('${it.id}')">
            –ö—É–ø–∏—Ç—å
          </button>
        </div>
      </div>
   ` ;
    elShopList.appendChild(div);
  }
}

function formatCost(c){
  const parts = [];
  if(c.coins) parts.push(`<span class="costPill"><img src="icons/topbar/icon_coins.png" alt="">${c.coins}</span>`);
  if(c.rep)   parts.push(`<span class="costPill"><img src="icons/topbar/icon_rep.png" alt="">${c.rep}</span>`);
  if(c.bio)   parts.push(`<span class="costPill"><img src="icons/topbar/icon_bio.png" alt="">${c.bio}</span>`);
  return parts.length ? `<div class="costLine">${parts.join("")}</div> `: "";
}

function canAfford(c){
  if(c.coins && state.coins < c.coins) return false;
  if(c.rep && (state.reputation||0) < c.rep) return false;
  if(c.bio && (state.biomaterial||0) < c.bio) return false;
  return true;
}

function payCost(c){
  if(c.coins) state.coins -= c.coins;
  if(c.rep) state.reputation -= c.rep;
  if(c.bio) state.biomaterial -= c.bio;
}

function buyPerk(id){
  const it = SHOP.find(x => x.id === id);
  if(!it) return;

  // —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞
  state.perks = state.perks || {};
  state.flags = state.flags || {};
  state.shopBought = state.shopBought || {};

  // –ø—Ä–∞–≤–∏–ª–∞
  if(it.can && !it.can()) return;
  if(!canAfford(it.cost)) return;

  // —Å–ø–∏—Å—ã–≤–∞–µ–º
  payCost(it.cost);

  // –ø—Ä–∏–º–µ–Ω—è–µ–º
  if(typeof it.buy === "function") it.buy();

  saveState();
  renderShop();
  refreshVisibleUI();
}
  
window.openShop = openShop;
window.buyPerk = buyPerk;

function assignDoctorToSlot(docId, slot){
  if(slot === 1){
    state.duty.slot1 = docId;
    if(state.duty.slot2 === docId) state.duty.slot2 = null;
  } else {
    if(!state.unlocks?.wardB) return; // —Å–ª–æ—Ç 2 –∑–∞–∫—Ä—ã—Ç
    state.duty.slot2 = docId;
    if(state.duty.slot1 === docId) state.duty.slot1 = pickRandomDoctorId();
  }

  // —Å–±—Ä–æ—Å–∏—Ç—å —Å–æ–≤–µ—Ç—ã –ø–∞—Ü–∏–µ–Ω—Ç–∞–º (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ ‚Äú—Å—Ç–∞—Ä—ã—Ö —Å–æ–≤–µ—Ç–æ–≤‚Äù)
  for(const p of state.patients) p.doctorAdviceCache = null;

  saveState();
  renderStaff();
  refreshVisibleUI();
}
  
/* =========================================================
   12) UI RENDER
========================================================= */
// ======================
// RESEARCH TREE (Skills)
// ======================

const RESEARCH = [
  {
    id:"reg_1",
    name:"–†–µ–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä–∞ I",
    desc:"–ê–≤—Ç–æ–≤—ã–ø–∏—Å–∫–∞: 1 –ø–∞—Ü–∏–µ–Ω—Ç / 60 –º–∏–Ω (–µ—Å–ª–∏ –µ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç).",
    costCoins: 220,
    costBio: 6,
    timeSec: 90,
    requires: [],
    apply(){ state.perks.autoDischargePerHour = 1; }
  },
  {
    id:"reg_2",
    name:"–†–µ–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä–∞ II",
    desc:"–ê–≤—Ç–æ–≤—ã–ø–∏—Å–∫–∞: 1 –ø–∞—Ü–∏–µ–Ω—Ç / 30 –º–∏–Ω.",
    costCoins: 650,
    costBio: 18,
    timeSec: 150,
    requires:["reg_1"],
    apply(){ state.perks.autoDischargePerHour = 2; }
  },
  {
    id:"reg_3",
    name:"–†–µ–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä–∞ III",
    desc:"–ê–≤—Ç–æ–≤—ã–ø–∏—Å–∫–∞: 2 –ø–∞—Ü–∏–µ–Ω—Ç–∞ / 30 –º–∏–Ω.",
    costCoins: 1400,
    costBio: 40,
    timeSec: 220,
    requires:["reg_2"],
    apply(){ state.perks.autoDischargePerHour = 4; }
  },

  {
    id:"triage_1",
    name:"–¢—Ä–∏–∞–∂ I",
    desc:"+1 –∫ –º–∞–∫—Å –æ—á–µ—Ä–µ–¥–∏.",
    costCoins: 260,
    costBio: 8,
    timeSec: 80,
    requires: [],
   apply(){
    state.perks.queueBuffer = (state.perks.queueBuffer || 0) + 1; }
  },
  {
    id:"triage_2",
    name:"–¢—Ä–∏–∞–∂ II",
    desc:"+1 –∫ –º–∞–∫—Å –æ—á–µ—Ä–µ–¥–∏ (–µ—â—ë).",
    costCoins: 780,
    costBio: 20,
    timeSec: 140,
    requires:["triage_1"],
    apply(){ state.maxQueue = Math.min(14, (state.maxQueue||6) + 1); }
  },

  {
    id:"treat_speed_1",
    name:"–ë—ã—Å—Ç—Ä—ã–µ —Ä—É–∫–∏ I",
    desc:"–õ–µ—á–µ–Ω–∏–µ –±—ã—Å—Ç—Ä–µ–µ –Ω–∞ 7%.",
    costCoins: 320,
    costBio: 10,
    timeSec: 90,
    requires: [],
    apply(){ state.perks.treatTimeMul = Math.max(0.60, (state.perks.treatTimeMul ?? 1.0) * 0.93); }
  },
  {
    id:"treat_speed_2",
    name:"–ë—ã—Å—Ç—Ä—ã–µ —Ä—É–∫–∏ II",
    desc:"–õ–µ—á–µ–Ω–∏–µ –±—ã—Å—Ç—Ä–µ–µ –µ—â—ë –Ω–∞ 7%.",
    costCoins: 900,
    costBio: 26,
    timeSec: 160,
    requires:["treat_speed_1"],
    apply(){ state.perks.treatTimeMul = Math.max(0.55, (state.perks.treatTimeMul ?? 1.0) * 0.93); }
  },

  {
    id:"repair_1",
    name:"–•–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω–∏–∫ I",
    desc:"–ß–∏–Ω–∏—Ç—å –¥–µ—à–µ–≤–ª–µ –Ω–∞ 15%.",
    costCoins: 420,
    costBio: 12,
    timeSec: 120,
    requires: [],
    apply(){ state.perks.repairCostMul = 0.85; }
  },
  {
    id:"repair_2",
    name:"–•–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω–∏–∫ II",
    desc:"–ß–∏–Ω–∏—Ç—å –¥–µ—à–µ–≤–ª–µ –Ω–∞ 30%.",
    costCoins: 1100,
    costBio: 30,
    timeSec: 200,
    requires:["repair_1"],
    apply(){ state.perks.repairCostMul = 0.70; }
  },
{
  id:"fatigue_slow",
  name:"–ö—Ä–µ–ø–∫–∏–µ –Ω–µ—Ä–≤—ã",
  desc:"–£—Å—Ç–∞–ª–æ—Å—Ç—å –≤—Ä–∞—á–µ–π –∫–æ–ø–∏—Ç—Å—è –º–µ–¥–ª–µ–Ω–Ω–µ–µ (‚àí20%)",
  icon:"img/research/placeholder.png",
  req:["handwork"],
  costCoins:120,
  costBio:3,
  timeSec:80,
  apply(){
    state.perks.fatigueGainMul = Math.min(1.0, state.perks.fatigueGainMul * 0.8);
  }
},
{
  id:"rep_bonus",
  name:"–î–æ–±—Ä–∞—è —Å–ª–∞–≤–∞",
  desc:"–ë–æ–ª—å—à–µ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏ –∑–∞ —Ö–æ—Ä–æ—à–∏–µ –∏—Å—Ö–æ–¥—ã (+25%)",
  icon:"img/research/placeholder.png",
  req:["triage"],
  costCoins:160,
  costBio:4,
  timeSec:90,
  apply(){
    state.perks.repGainMul = Math.max(state.perks.repGainMul || 1.0, 1.25);
  }
},
{
  id:"bio_bonus",
  name:"–•–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω—ã–π –º–æ—Ä–≥",
  desc:"–ë–æ–ª—å—à–µ –±–∏–æ–º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∑–∞ —Ö–æ—Ä–æ—à–∏–µ –∏—Å—Ö–æ–¥—ã (+30%)",
  icon:"img/research/placeholder.png",
  req:["rep_bonus"],
  costCoins:200,
  costBio:6,
  timeSec:110,
  apply(){
    state.perks.bioGainMul = Math.max(state.perks.bioGainMul || 1.0, 1.30);
  }
},
{
  id:"queue_wait_plus",
  name:"–¢–µ—Ä–ø–µ–Ω–∏–µ –Ω–∞—Ä–æ–¥–∞",
  desc:"–ü–∞—Ü–∏–µ–Ω—Ç—ã –¥–æ–ª—å—à–µ –∂–¥—É—Ç –≤ –æ—á–µ—Ä–µ–¥–∏ (+50% –≤—Ä–µ–º–µ–Ω–∏ –æ–∂–∏–¥–∞–Ω–∏—è)",
  icon:"img/research/placeholder.png",
  req:["queue_buffer"],
  costCoins:260,
  costBio:7,
  timeSec:130,
  apply(){
    state.perks.queueWaitMul = Math.max(state.perks.queueWaitMul || 1.0, 1.5);
  }
},
  {
  id:"queue_wait_plus",
  name:"–¢–µ—Ä–ø–µ–Ω–∏–µ –Ω–∞—Ä–æ–¥–∞",
  desc:"–ü–∞—Ü–∏–µ–Ω—Ç—ã –¥–æ–ª—å—à–µ –∂–¥—É—Ç –≤ –æ—á–µ—Ä–µ–¥–∏ (+50%)",
  costCoins: 250,
  costBio: 6,
  timeSec: 120,
  requires: [],
  apply(){
    state.perks.queueWaitMul = Math.max(state.perks.queueWaitMul || 1.0, 1.5);
  }
},
{
  id:"pharmacy_open",
  name:"–ê–ø—Ç–µ–∫–∞",
  desc:"–û—Ç–∫—Ä—ã–≤–∞–µ—Ç –∞–ø—Ç–µ–∫—É. –ö–ª–∏–µ–Ω—Ç—ã –ø—Ä–∏—Ö–æ–¥—è—Ç —Ä–µ–¥–∫–æ, –Ω–æ –¥–∞—é—Ç –¥–µ–Ω—å–≥–∏ –∏ —Ä–µ–ø—É—Ç–∞—Ü–∏—é.",
  costCoins: 900,
  costBio: 0,
  timeSec: 180,
  req: [],
  apply(){
    state.perks.pharmacyOpen = true;
    state.perks.pharmacySpawnMul = state.perks.pharmacySpawnMul ?? 1.0;
  }
},
{
  id:"pharmacy_rate1",
  name:"–°–ª—É—Ö–∏ –æ —Ü–µ–ª–µ–±–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤–∞—Ö",
  desc:"–ö–ª–∏–µ–Ω—Ç—ã –≤ –∞–ø—Ç–µ–∫—É –ø—Ä–∏—Ö–æ–¥—è—Ç —á–∞—â–µ.",
  costCoins: 700,
  costBio: 1,
  timeSec: 160,
  req:["pharmacy_open"],
  apply(){
    // –±—ã—Å—Ç—Ä–µ–µ –Ω–∞ 15%
    state.perks.pharmacySpawnMul = Math.max(0.55, (state.perks.pharmacySpawnMul ?? 1.0) * 0.85);
  }
},
{
  id:"pharmacy_rate2",
  name:"–û—á–µ—Ä–µ–¥—å —É –ø—Ä–∏–ª–∞–≤–∫–∞",
  desc:"–ö–ª–∏–µ–Ω—Ç—ã –≤ –∞–ø—Ç–µ–∫—É –ø—Ä–∏—Ö–æ–¥—è—Ç –µ—â—ë —á–∞—â–µ.",
  costCoins: 1100,
  costBio: 2,
  timeSec: 220,
  req:["pharmacy_rate1"],
  apply(){
    state.perks.pharmacySpawnMul = Math.max(0.45, (state.perks.pharmacySpawnMul ?? 1.0) * 0.80);
  }
},

];

const STUDY_COST_MUL = 3;
const REGISTRY_COST_MUL = 5;

function studyMul(def){
  // —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä–∞ –∏–º–±–∞ -> x5
  if(def.id === "registry") return REGISTRY_COST_MUL;
  return STUDY_COST_MUL;
}

function getStudyCost(def){
  const mul = studyMul(def);
  return {
    coins: Math.round((def.costCoins || 0) * mul),
    bio: Math.round((def.costBio || 0) * mul),
    timeSec: Math.round((def.timeSec || 0) * mul),
  };
}

function ensureResearchState(){
  state.perks = state.perks || {};
  state.perks.unlockedResearch = state.perks.unlockedResearch || {};
  state.perks.researching = state.perks.researching || null;

  // –∫–∞–∂–¥—ã–π —Ä–∞–∑ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç—ã –∏–∑ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π
  rebuildPerksFromResearch();
}

function rebuildPerksFromResearch(){
  state.perks = state.perks || {};

  // —Å–±—Ä–æ—Å –ø–µ—Ä–∫–æ–≤ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –≤ –¥–µ—Ñ–æ–ª—Ç
  state.perks.autoDischarge = false;
  state.perks.coinsMul = 1.0;
  state.perks.treatTimeMul = 1.0;

  state.perks.pharmacyOpen = false;
state.perks.pharmacySpawnMul = 1.0;

  // –Ω–æ–≤—ã–µ
  state.perks.fatigueGainMul = 1.0;  // < 1 = —É—Å—Ç–∞–ª–æ—Å—Ç—å –º–µ–¥–ª–µ–Ω–Ω–µ–µ
  state.perks.repGainMul = 1.0;      // > 1 = –±–æ–ª—å—à–µ —Ä–µ–ø—ã –∑–∞ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ
  state.perks.bioGainMul = 1.0;      // > 1 = –±–æ–ª—å—à–µ –±–∏–æ–º–∞—Ç–µ—Ä–∏–∞–ª–∞ –∑–∞ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ
  state.perks.queueWaitMul = 1.0;    // > 1 = –¥–æ–ª—å—à–µ –∂–¥—É—Ç
  state.perks.queueBuffer = 0;       // + –∫ maxQueue (–≤ applyPerks)

  // –ø—Ä–∏–º–µ–Ω—è–µ–º apply() –≤—Å–µ—Ö –æ—Ç–∫—Ä—ã—Ç—ã—Ö –Ω–æ–¥–æ–≤
  const unlocked = state.perks.unlockedResearch || {};
  for(const def of RESEARCH){
    if(unlocked[def.id] && typeof def.apply === "function"){
      def.apply();
    }
  }

  // –ø–µ—Ä–µ—Å—á—ë—Ç –∑–∞–≤–∏—Å–∏–º—ã—Ö —à—Ç—É–∫ (–æ—á–µ—Ä–µ–¥—å –∏ —Ç.–¥.)
  applyPerks();
  saveState();
}

function startResearch(id){
  ensureResearchState();
  if(state.perks.researching) return;

  const def = RESEARCH.find(x => x.id === id);
  if(!def) return;

  // —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–æ
  if(state.perks.unlockedResearch?.[id]) return;

  // –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
  if(def.req){
    const ok = def.req.every(rid => state.perks.unlockedResearch?.[rid]);
    if(!ok) return;
  }

  const c = getStudyCost(def);

  // –æ–ø–ª–∞—Ç–∞
  if((state.coins || 0) < c.coins) return;
  if((state.biomaterial || 0) < c.bio) return;

  state.coins -= c.coins;
  state.biomaterial -= c.bio;

  state.perks.researching = {
    id,
    endAt: now() + c.timeSec * 1000
  };

  saveState();
  refreshVisibleUI();
}

function finishResearch(){
  ensureResearchState();
  const cur = state.perks.researching;
  if(!cur) return;

  const def = RESEARCH.find(x => x.id === cur.id);
  if(def){
    state.perks.unlockedResearch[cur.id] = true;
  }

  state.perks.researching = null;

  // –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –ø–µ—Ä–∫–∏ –∏–∑ –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ
  rebuildPerksFromResearch();

  saveState();
  refreshVisibleUI();
}

function processResearchTick(){
  ensureResearchState();
  const cur = state.perks.researching;
  if(!cur) return;
  if(now() >= Number(cur.endAt)) finishResearch();
}
function isResearchUnlocked(id){
  return !!state?.perks?.unlockedResearch?.[id];
}
function isResearchAvailable(node){
  return (node.requires||[]).every(r => isResearchUnlocked(r));
}
function getResearchNode(id){
  return RESEARCH.find(n=>n.id===id) || null;
}


function renderResearch(){
  ensureResearchState();

  const elTree = document.getElementById("research-tree");
  const elActive = document.getElementById("research-active");
  if(!elTree || !elActive) return;

  // –∞–∫—Ç–∏–≤–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ
  const r = state.perks.researching;
  if(r){
    const node = getResearchNode(r.id);
    const leftMs = Math.max(0, Number(r.endAt) - now());
    const leftSec = Math.ceil(leftMs/1000);
    elActive.style.display = "block";
    elActive.innerHTML = `
      <div class="listTitle">‚è≥ –ò–∑—É—á–∞–µ—Ç—Å—è: ${node ? node.name : r.id}</div>
      <div class="listSub">–û—Å—Ç–∞–ª–æ—Å—å: <b>${leftSec}—Å</b></div>
    `;
  } else {
    elActive.style.display = "none";
    elActive.innerHTML = "";
  }

  // –¥–µ—Ä–µ–≤–æ
  let html = "";
  for(const n of RESEARCH){
    const c = getStudyCost(n);
    const locked = !isResearchUnlocked(n.id);
    const available = isResearchAvailable(n);
    const disabled = (!available) || (!!state.perks.researching) || !locked;

    const reqText = (n.requires && n.requires.length)
      ? `–¢—Ä–µ–±—É–µ—Ç: ${n.requires.map(x => getResearchNode(x)?.name || x).join(", ")}`
      : "–î–æ—Å—Ç—É–ø–Ω–æ —Å—Ä–∞–∑—É";

    html += `
      <div class="card" style="margin-top:10px;">
        <div class="row" style="align-items:flex-start;">
          <div style="flex:1;">
            <div class="listTitle">${isResearchUnlocked(n.id) ? "‚úÖ" : (available ? "üîì" : "üîí")} ${n.name}</div>
            <div class="listSub">${n.desc}</div>
            <div class="listSub" style="margin-top:6px; opacity:.8;">${reqText}</div>
          </div>
          <div style="text-align:right; min-width:120px;">
            <div class="listSub">üí∞ ${c.coins}</div>
            <div class="listSub">üß´ ${c.bio}</div>
            <div class="listSub">‚è±Ô∏è ${c.timeSec}—Å</div>
          </div>
        </div>

        ${
          isResearchUnlocked(n.id)
          ? `<div class="hint" style="color:var(--ok); margin-top:8px;">–ò–∑—É—á–µ–Ω–æ</div>`
          : `<button class="btn ${disabled ? "" : "ok"}" style="margin-top:10px; ${disabled ? "opacity:.55; pointer-events:none;" : ""}"
               onclick="startResearch('${n.id}')">
               ${available ? "–ò–∑—É—á–∏—Ç—å" : "–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ"}
             </button>`
        }
      </div>
    `;
  }
  elTree.innerHTML = html;
}
window.renderResearch = renderResearch;
  

const elCoins = document.getElementById("coins");
const elRep = document.getElementById("rep");
const elBio = document.getElementById("bio");
const elShiftTimer = document.getElementById("shift-timer");
const elWeekTitleText = document.getElementById("week-title-text");
const elWeekDesc  = document.getElementById("week-desc");
const elWeekShift = document.getElementById("week-shift");

const elWards = document.getElementById("wards");
const elQueueUpgrades = document.getElementById("queue-upgrades");
const elQueue = document.getElementById("queue");
const elDuty = document.getElementById("duty");

const elPatientTitle = document.getElementById("patient-title");
const elPatientSub = document.getElementById("patient-sub");
const elPatientClue = document.getElementById("patient-clue");
const elPatientDiagnosis = document.getElementById("patient-diagnosis");
const elAdvice = document.getElementById("doctor-advice");

const elTreatPanel = document.getElementById("treat-panel");
const elTreatmentButtons = document.getElementById("treatment-buttons");

const elActiveTreatment = document.getElementById("active-treatment");
const elActiveName = document.getElementById("active-treatment-name");
const elActiveTimer = document.getElementById("active-treatment-timer");

const elResultPanel = document.getElementById("result-panel");
const elResultText = document.getElementById("result-text");
const elRewardList = document.getElementById("reward-list");
const elRewardHint = document.getElementById("reward-hint");
const elNextShiftBtn = document.getElementById("btn-next-shift");
  elNextShiftBtn.addEventListener("click", (e) => {
  e.preventDefault();
  startNewShift();
});

const elLabBtn = document.getElementById("btn-lab");
const elLabSub = document.getElementById("lab-sub");
const elLabHint = document.getElementById("lab-hint");

function renderTop(){
  elCoins.textContent = state.coins;
  elRep.textContent = state.reputation;
  elBio.textContent = state.biomaterial;

  // —Ç–∞–π–º–µ—Ä —Å–º–µ–Ω—ã (—á–∞—Å—ã:–º–∏–Ω—É—Ç—ã)
  const left = (state.shift?.endAt ?? now()) - now();
  elShiftTimer.textContent = state.shift?.active ? formatShiftLeft(left) : "00:00";

  // –±–∞–Ω–Ω–µ—Ä —Ç–µ—Ö—Ä–∞–±–æ—Ç
  const banner = document.getElementById("maintenance-banner");
  if(banner){
    const on = !!state.maintenance?.active;
    banner.style.display = on ? "block" : "none";
    banner.textContent = on ? (state.maintenance.text || "‚ö†Ô∏è –ò–¥—É—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã. –ó–∞–π–¥–∏ –ø–æ–∑–∂–µ.") : "";
  }

  // –Ω–µ–¥–µ–ª—è/–∏–≤–µ–Ω—Ç
  const ev = getCurrentEvent();
  const week = state.calendar?.week ?? 1;
  const shiftInWeek = state.calendar?.shiftInWeek ?? 1;

if(elWeekTitleText)
  elWeekTitleText.textContent = `–ù–µ–¥–µ–ª—è ${week}: ${ev ? ev.name : "--"}`;
  if(elWeekDesc)  elWeekDesc.textContent  = `–≠—Ñ—Ñ–µ–∫—Ç—ã: ${ev ? ev.desc : "‚Äî"}`;
  if(elWeekShift) elWeekShift.textContent = `–°–º–µ–Ω–∞: ${shiftInWeek}/7`;
}

function renderClinic(){
  renderTop();

  // ========== –ü–ê–õ–ê–¢–´ ==========
  elWards.innerHTML = "";

  for(const w of state.wards){
    // –∑–∞—â–∏—Ç–∞ –æ—Ç —Å—Ç–∞—Ä—ã—Ö —Å–µ–π–≤–æ–≤
    w.bedsMax = w.bedsMax || 2;
    w.patients = w.patients || [];
    w.pendingResults = w.pendingResults || {};

    const pending = w.pendingResults;

    // --- —Å–ø–∏—Å–æ–∫ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤ –≤ –ø–∞–ª–∞—Ç–µ (–¢–û–õ–¨–ö–û –∏–º—è + —Ç–∞–π–º–µ—Ä/–∫–Ω–æ–ø–∫–∏) ---
   const list = (w.patients || []);
const leftList  = list.slice(0, 4);
const rightList = list.slice(4, 8);

function renderPatientRow(pid){
  const p = patientById(pid);
  if(!p) return "";

  const a = getActiveForPatient(w.id, pid);
  const pend = pending[pid];

  // 1) –µ—Å—Ç—å –≥–æ—Ç–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å)
  if(pend){
    return `
      <div class="wardPatientRow st-result" onclick="openPatientById('${pid}')">
        <div class="wardPatientName">${escapeHtml(p.name)}</div>
        <div class="wardPatientStatus" title="–†–µ–∑—É–ª—å—Ç–∞—Ç">üëÅ</div>
      </div>
   ` ;
  }

  // 2) –ª–µ—á–∏—Ç—Å—è —Å–µ–π—á–∞—Å
  if(a){
    const left = a.endAt - now();

    // 2.1) –ª–µ—á–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–∏–ª–æ—Å—å (–∑–∞–±—Ä–∞—Ç—å)
    if(left <= 0){
      return `
        <div class="wardPatientRow st-done" onclick="completeTreatmentPatient('${w.id}','${pid}')">
          <div class="wardPatientName">${escapeHtml(p.name)}</div>
          <div class="wardPatientStatus" title="–ó–∞–±—Ä–∞—Ç—å">‚úÖ</div>
        </div>
      `;
    }

    // 2.2) –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ (—Ç–∞–π–º–µ—Ä –æ—Å—Ç–∞–≤–ª—è–µ–º, –Ω–æ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —à–∏—Ä–∏–Ω—ã)
    return `
      <div class="wardPatientRow st-active" onclick="openPatientById('${pid}')">
        <div class="wardPatientName">${escapeHtml(p.name)}</div>
        <div class="wardPatientTimer" title="–ò–¥—ë—Ç –ª–µ—á–µ–Ω–∏–µ">‚è≥ ${formatLeft(left)}</div>
      </div>
   ` ;
  }

  // 3) –ª–µ–∂–∏—Ç, –Ω–æ –ª–µ—á–µ–Ω–∏–µ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ (–æ—Ç–∫—Ä—ã—Ç—å)
  return `
    <div class="wardPatientRow st-idle" onclick="openPatientById('${pid}')">
      <div class="wardPatientName">${escapeHtml(p.name)}</div>
      <div class="wardPatientStatus" title="–û—Ç–∫—Ä—ã—Ç—å">üßæ</div>
    </div>
 ` ;
}

const patientsHtml = `
  <div class="wardPatientsGrid">
    <div class="wardCol">${leftList.map(renderPatientRow).join("")}</div>
    <div class="wardCol">${rightList.map(renderPatientRow).join("")}</div>
  </div>
`;

    // --- –∫–Ω–æ–ø–∫–∞ –∫—É–ø–∏—Ç—å –∫–æ–π–∫—É (–±–µ–∑ –Ω–∞–¥–ø–∏—Å–µ–π 3/3/8) ---
   const bedsCap = 8;
const bedBtnDisabled = (w.bedsMax >= bedsCap) ? "disabled" : "";
const bedCost = bedCostForWard(w);

const bedsLine = `
  <div class="row" style="margin-top:10px; justify-content:center;">
    <button class="btn small" onclick="buyBed('${w.id}')" ${bedBtnDisabled}>
      –ö—É–ø–∏—Ç—å –∫–æ–π–∫—É <span class="muted">(ü™ô ${bedCost})</span>
    </button>
  </div>
`;

    // --- –∫–∞—Ä—Ç–æ—á–∫–∞ –ø–∞–ª–∞—Ç—ã ---
    const card = document.createElement("div");
card.className = "card wardCard";
card.innerHTML = `
  <div class="wardHeaderCenter">
    <div class="chip" style="gap:10px;">
      <img src="img/wards/ward_icon.png" class="wardIcon" alt="">
      <div>
        <div class="listTitle">${escapeHtml(w.name)} ‚Ä¢ –£—Ä. ${w.level}</div>
        <div class="listSub">–ü–∞—Ü–∏–µ–Ω—Ç—ã: <b>${w.patients.length}/${w.bedsMax}</b></div>
      </div>
    </div>
  </div>

  ${bedsLine}

  <div class="wardPatientsBox">
    ${patientsHtml || `<div class="hint" style="margin-top:10px">–ü–∞–ª–∞—Ç–∞ –ø—É—Å—Ç–∞.</div>`}
  </div>
`;
          // --- –∞–ø–≥—Ä–µ–π–¥—ã –ø–æ–¥ –ø–∞–ª–∞—Ç–æ–π ---
    const upgrades = document.createElement("div");
    upgrades.className = "card";
    upgrades.style.marginTop = "10px";
  upgrades.innerHTML = `
  <div class="statRow" style="margin-top:2px">
    <span class="statPill">–ö–æ–º—Ñ–æ—Ä—Ç <b>${w.comfort}</b></span>
    <span class="statPill">–í–µ–Ω—Ç <b>${w.ventilation}</b></span>
    <span class="statPill">–°–≤–µ—Ç <b>${w.light}</b></span>
    <span class="statPill">–ß–∏—Å—Ç–æ—Ç–∞ <b>${w.cleanliness}</b></span>
  </div>

  ${
    (w.broken?.ventilation)
      ? `<div class="hint" style="color:var(--warn); margin-top:8px;">
           –í–µ–Ω—Ç–∏–ª—è—Ü–∏—è —Å–ª–æ–º–∞–Ω–∞ (‚àí1 –∫ –≤–µ–Ω—Ç–∏–ª—è—Ü–∏–∏)
           <button class="btn small" onclick="repairWard('${w.id}','ventilation')">–ü–æ—á–∏–Ω–∏—Ç—å (150 üí∞)</button>
         </div>`
      : ``
  }

  ${
    (w.broken?.light)
      ? `<div class="hint" style="color:var(--warn); margin-top:8px;">
           –°–≤–µ—Ç —Å–ª–æ–º–∞–Ω (‚àí1 –∫ —Å–≤–µ—Ç—É)
           <button class="btn small" onclick="repairWard('${w.id}','light')">–ü–æ—á–∏–Ω–∏—Ç—å (150 üí∞)</button>
         </div>`
      : ``
  }

  ${
    (w.broken?.cleanliness)
      ? `<div class="hint" style="color:var(--warn); margin-top:8px;">
           –ß–∏—Å—Ç–æ—Ç–∞ —É–ø–∞–ª–∞ (‚àí1 –∫ —á–∏—Å—Ç–æ—Ç–µ)
           <button class="btn small" onclick="repairWard('${w.id}','cleanliness')">–ü–æ—á–∏–Ω–∏—Ç—å (150 üí∞)</button>
         </div>`
      : ``
  }

  ${
    (w.broken?.comfort)
      ? `<div class="hint" style="color:var(--warn); margin-top:8px;">
           –ö–æ–º—Ñ–æ—Ä—Ç —Å–ª–æ–º–∞–Ω (‚àí1 –∫ –∫–æ–º—Ñ–æ—Ä—Ç—É)
           <button class="btn small" onclick="repairWard('${w.id}','comfort')">–ü–æ—á–∏–Ω–∏—Ç—å (150 üí∞)</button>
         </div>`
      : ``
  }

  <div class="grid2" style="margin-top:10px">
    ${renderWardUpgradeBtn(w, "comfort", "–ö–æ–º—Ñ–æ—Ä—Ç", "–ú–µ–Ω—å—à–µ —Å—Ç—Ä–∞–¥–∞–Ω–∏–π –ø–∞—Ü–∏–µ–Ω—Ç–∞")}
    ${renderWardUpgradeBtn(w, "ventilation", "–í–µ–Ω—Ç–∏–ª—è—Ü–∏—è", "–ú–∏–∞–∑–º—ã —É—Ö–æ–¥—è—Ç")}
    ${renderWardUpgradeBtn(w, "light", "–°–≤–µ—Ç", "–õ—É—á—à–∏–µ –∏—Å—Ö–æ–¥—ã")}
    ${renderWardUpgradeBtn(w, "cleanliness", "–ß–∏—Å—Ç–æ—Ç–∞", "–ú–µ–Ω—å—à–µ –∑–∞—Ä–∞–∂–µ–Ω–∏–π")}
  </div>
`;

    elWards.appendChild(card);
    elWards.appendChild(upgrades);
  }

  // –∫–Ω–æ–ø–∫–∞ –ø–æ–∫—É–ø–∫–∏ –≤—Ç–æ—Ä–æ–π –ø–∞–ª–∞—Ç—ã
  if(!state.unlocks?.wardB){
    const cost = 3500;
    const disabled = state.coins < cost ? "disabled" : "";
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <div class="row">
        <div>
          <div class="listTitle">üîí –ü–∞–ª–∞—Ç–∞ B</div>
          <div class="listSub">–û—Ç–∫—Ä–æ–π –≤—Ç–æ—Ä—É—é –ø–∞–ª–∞—Ç—É, —á—Ç–æ–±—ã –ª–µ—á–∏—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ.</div>
        </div>
        <div class="right">
          <button class="btn small ok" onclick="buyWardB()" ${disabled}>–ö—É–ø–∏—Ç—å (${cost})</button>
        </div>
      </div>
   ` ;
    elWards.appendChild(div);
  }

  // ========== –î–ï–ñ–£–†–ù–´–ï –í–†–ê–ß–ò ==========
  elDuty.innerHTML = "";
  const [d1, d2] = dutyDoctors();

  renderDutySlot(1, d1);

  if(state.unlocks?.wardB){
    renderDutySlot(2, d2);
  } else {
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <div class="row">
        <div>
          <div class="listTitle">–°–ª–æ—Ç 2: üîí –ó–∞–∫—Ä—ã—Ç</div>
          <div class="listSub">–û—Ç–∫—Ä–æ–π –ü–∞–ª–∞—Ç—É B, —á—Ç–æ–±—ã –Ω–∞–∑–Ω–∞—á–∞—Ç—å –≤—Ç–æ—Ä–æ–≥–æ –≤—Ä–∞—á–∞.</div>
        </div>
        <button class="btn small" onclick="buyWardB()">–ö—É–ø–∏—Ç—å –ø–∞–ª–∞—Ç—É</button>
      </div>
    `;
    elDuty.appendChild(div);
  }

// ===== –∞–ø–≥—Ä–µ–π–¥—ã –æ—á–µ—Ä–µ–¥–∏ (–¥–≤–µ –∫–Ω–æ–ø–∫–∏ –Ω–∞–¥ –æ—á–µ—Ä–µ–¥—å—é) =====
if(elQueueUpgrades){
  const capLvl = state.queueUpg?.capLvl ?? 0;
  const waitLvl = state.queueUpg?.waitLvl ?? 0;

  const capMax = 3;
  const waitMax = 6;

  const capCost = capLvl >= capMax ? null : queueCapCost(capLvl);
  const waitCost = waitLvl >= waitMax ? null : queueWaitCost(waitLvl);

  // –í–ê–ñ–ù–û: –µ—Å–ª–∏ capCost null -> MAX, –∏–Ω–∞—á–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ
  const capDisabled = (capLvl >= capMax) || (capCost !== null && state.coins < capCost);
  const waitDisabled = (waitLvl >= waitMax) || (waitCost !== null && state.coins < waitCost) || ((state.queue || []).length === 0);

  elQueueUpgrades.innerHTML = `
    <button class="btn" ${capDisabled ? "disabled" : ""} onclick="upgradeQueueCap()">
      <div class="row" style="gap:10px; align-items:center;">
        <img src="icons/shop/icon_queue_buffer.png" style="width:22px;height:22px" alt="">
        <div style="text-align:left;">
          <div><b>–£–≤–µ–ª–∏—á–∏—Ç—å –æ—á–µ—Ä–µ–¥—å</b> (—É—Ä. ${capLvl}/${capMax})</div>
          <div class="muted">+1 –º–µ—Å—Ç–æ ‚Ä¢ –¶–µ–Ω–∞: ${capCost ?? "MAX"}</div>
        </div>
      </div>
    </button>

    <button class="btn" ${waitDisabled ? "disabled" : ""} onclick="upgradeQueueWait()">
      <div class="row" style="gap:10px; align-items:center;">
        <img src="icons/shop/icon_times.png" style="width:22px;height:22px" alt="">
        <div style="text-align:left;">
          <div><b>–£–≤–µ–ª–∏—á–∏—Ç—å –æ–∂–∏–¥–∞–Ω–∏–µ</b> (—É—Ä. ${waitLvl}/${waitMax})</div>
          <div class="muted">+${queueWaitBonusSecPerBuy()} —Å–µ–∫ –≤—Å–µ–º (${(state.queue||[]).length}) ‚Ä¢ –¶–µ–Ω–∞: ${waitCost ?? "MAX"}</div>
        </div>
      </div>
    </button>
  `;
}

 // ========== –û–ß–ï–†–ï–î–¨ (–∞–≤–∞—Ç–∞—Ä–∫–∏ 3 –≤ —Ä—è–¥) ==========
elQueue.innerHTML = "";

if(state.queue.length===0){
  elQueue.innerHTML = `<div class="hint">–û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞. –≠—Ç–æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ.</div>`;
} else {
  const grid = document.createElement("div");
  grid.className = "queueGrid";

  for(const pidRaw of state.queue){
    const pid = String(pidRaw);
    const p = patientById(pid);
    if(!p) continue;

    const btn = document.createElement("div");

    const rarityClass =
      (p.rarity===RARITY.LEGENDARY) ? "legendary" :
      (p.rarity===RARITY.RARE) ? "rare" : "common";

    btn.className = "queueAvatarBtn " + rarityClass;
    btn.onclick = ()=> openPatientById(pid);

    const img = document.createElement("img");
    img.className = "queueAvatarImg";
    img.src = ensurePatientPortrait(p);  // ‚úÖ —Ç–∞ –∂–µ –ª–æ–≥–∏–∫–∞, —á—Ç–æ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞
    img.alt = "";

    const dot = document.createElement("div");
    dot.className = "queueRarityDot";

    // –º–∞–ª–µ–Ω—å–∫–∏–π —Ç–∞–π–º–µ—Ä-–ø–æ–ª–æ—Å–∫–∞ (—á—Ç–æ–±—ã –±—ã–ª–æ –≤–∏–¥–Ω–æ, —á—Ç–æ –æ–Ω ‚Äú–≥–æ—Ä–∏—Ç‚Äù)
    const left = Math.max(0, Number(p.leaveAt) - now());
    const total = Math.max(1, Number(state.baseWaitSec || 120) * 1000);
    const k = Math.max(0, Math.min(1, left / total));

    const bar = document.createElement("div");
    const timeText = document.createElement("div");
    timeText.className = "queueTimeText " + (left < 15000 ? "bad" : left < 40000 ? "warn" : "ok");
    timeText.textContent = formatLeft(left); // —É —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å formatLeft
    bar.className = "queueTimerTiny";
    bar.innerHTML = `<i style="width:${Math.round(k*100)}%"></i>`;

    btn.appendChild(img);
    btn.appendChild(dot);
    btn.appendChild(bar);
    btn.appendChild(timeText); 

    grid.appendChild(btn);
  }

  elQueue.appendChild(grid);
}
}

function openPharmacy(){
  showScreen("pharmacy");
  renderPharmacy();
}
window.openPharmacy = openPharmacy;

function openPharmacyMeds(){
  showScreen("pharm-meds");
  renderPharmacyMeds();
}
window.openPharmacyMeds = openPharmacyMeds;

function openPharmOrder(clientId){
  state.pharmacy.selectedClientId = String(clientId);
  saveState();
  showScreen("pharm-order");
  renderPharmOrder();
}
window.openPharmOrder = openPharmOrder;

function openPharmResult(){
  showScreen("pharm-result");
  renderPharmResult();
}
window.openPharmResult = openPharmResult;

function renderPharmacy(){
  ensurePharmacyState();
  const el = document.getElementById("pharmacy-queue");
  if(!el) return;

  if(!pharmacyUnlocked()){
    el.innerHTML =` <div class="hint">–ê–ø—Ç–µ–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞. –û—Ç–∫—Ä–æ–π –µ—ë –≤ ‚Äú–ò–∑—É—á–µ–Ω–∏–∏‚Äù.</div>`;
    return;
  }

  if(state.pharmacy.queue.length === 0){
    el.innerHTML =` <div class="hint">–ö–ª–∏–µ–Ω—Ç–æ–≤ –Ω–µ—Ç. –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ —Ç–∏—Ö–æ.</div>`;
    return;
  }

  const grid = document.createElement("div");
  grid.className = "queueGrid";

  for(const cid of state.pharmacy.queue){
    const c = state.pharmacy.clients[cid];
    if(!c) continue;

    const btn = document.createElement("div");
    btn.className = "queueAvatarBtn common";
    btn.onclick = ()=> openPharmOrder(c.id);

    const img = document.createElement("img");
    img.className = "queueAvatarImg";
    img.src = c.portrait || "img/patients/placeholder.png";

    btn.appendChild(img);
    grid.appendChild(btn);
  }

  el.innerHTML = "";
  el.appendChild(grid);
}

function studiedMedsMatching(keywords){
  const studied = state.pharmacy.medsStudied || {};
  const res = [];
  for(const m of PHARM_MEDICINES){
    if(!studied[m.id]) continue;
    if(m.tags.some(t => keywords.includes(t))) res.push(m);
  }
  return res;
}

function renderPharmOrder(){
  ensurePharmacyState();
  const c = state.pharmacy.clients[state.pharmacy.selectedClientId];
  const elText = document.getElementById("pharm-order-text");
  const elAns  = document.getElementById("pharm-order-answers");
  const elMeds = document.getElementById("pharm-order-meds");
  if(!c || !elText || !elAns || !elMeds){
    openPharmacy();
    return;
  }

  elText.textContent = c.text;

  elAns.innerHTML = "";
  c.answers.forEach((a, idx)=>{
    const b = document.createElement("button");
    b.className = "btn";
    b.style.marginTop = "8px";
    b.textContent = a.text;
    b.onclick = ()=> answerPharm(c.id, idx);
    elAns.appendChild(b);
  });

  const match = studiedMedsMatching(c.keywords);
  if(match.length === 0){
    elMeds.textContent = "–ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –∏–∑—É—á–µ–Ω–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤.";
  }else{
    elMeds.innerHTML = match.map(m => `‚Ä¢ ${m.name}`).join("<br>");
  }
}

function answerPharm(clientId, answerIndex){
  ensurePharmacyState();
  const c = state.pharmacy.clients[String(clientId)];
  if(!c) return;

  const ans = c.answers[answerIndex];
  if(!ans) return;

  // –±–∞–∑–æ–≤—ã–µ –Ω–∞–≥—Ä–∞–¥—ã/—à—Ç—Ä–∞—Ñ—ã
  let coins = 0;
  let rep = 0;
  let text = "";

  if(ans.kind === "good"){
    coins = 35; rep = +3;
    text = "–ö–ª–∏–µ–Ω—Ç –¥–æ–≤–æ–ª–µ–Ω. –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ, –Ω–æ –ø—Ä–∏—è—Ç–Ω–æ.";
    state.pharmacy.perfect += 1;
  }else if(ans.kind === "neutral"){
    coins = 15; rep = +1;
    text = "–°—Ä–∞–±–æ—Ç–∞–ª–æ‚Ä¶ –≤—Ä–æ–¥–µ. –ù–∏–∫—Ç–æ –Ω–µ —É–º–µ—Ä, —É–∂–µ —É—Å–ø–µ—Ö.";
  }else if(ans.kind === "bad"){
    coins = 10; rep = -2;
    text = "–í—ã—à–ª–æ —Å–æ–º–Ω–∏—Ç–µ–ª—å–Ω–æ. –°–ª—É—Ö–∏ –ø–æ—à–ª–∏ –±—ã—Å—Ç—Ä–µ–µ, —á–µ–º –ª–µ—á–µ–Ω–∏–µ.";
  }else if(ans.kind === "lethal"){
    coins = 0; rep = -4;
    text = "–õ–µ—Ç–∞–ª—å–Ω—ã–π –∏—Å—Ö–æ–¥. –°—Ä–µ–¥–Ω–µ–≤–µ–∫–æ–≤—å–µ –æ–¥–æ–±—Ä—è–µ—Ç —Ç–≤–æ—é –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É.";
  }

  // –Ω–µ–¥–µ–ª—å–Ω—ã–µ –º–æ–¥—ã, –µ—Å–ª–∏ —É —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å getCurrentEvent()
  const ev = (typeof getCurrentEvent === "function") ? getCurrentEvent() : null;
  if(ev?.id === "tainted_water"){
    // +10% –º–æ–Ω–µ—Ç –∏ —Ä–µ–ø—ã —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ
    if(coins > 0) coins = Math.round(coins * 1.10);
    if(rep > 0) rep = Math.round(rep * 1.10);
  }

  state.coins = Math.max(0, (state.coins||0) + coins);
  state.reputation = (state.reputation||0) + rep;

  state.pharmacy.served += 1;
  // —É–±—Ä–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ –æ—á–µ—Ä–µ–¥–∏
  state.pharmacy.queue = state.pharmacy.queue.filter(x => String(x) !== String(clientId));
  delete state.pharmacy.clients[String(clientId)];
  state.pharmacy.selectedClientId = null;

  state.pharmacy.lastResult = { text, coins, rep };
  saveState();

  openPharmResult();
}
window.answerPharm = answerPharm;

function renderPharmResult(){
  ensurePharmacyState();
  const r = state.pharmacy.lastResult;
  const elT = document.getElementById("pharm-result-text");
  const elR = document.getElementById("pharm-result-reward");
  if(!elT || !elR) return;

  if(!r){
    elT.textContent = "–ü—É—Å—Ç–æ. –ó–Ω–∞—á–∏—Ç, –∫—Ç–æ-—Ç–æ –≥–¥–µ-—Ç–æ –≤—Å—ë —Å–ª–æ–º–∞–ª.";
    elR.textContent = "";
    return;
  }

  elT.textContent = r.text;
  elR.innerHTML = `–ù–∞–≥—Ä–∞–¥–∞: <b>${r.coins} üí∞</b> ‚Ä¢ –†–µ–ø—É—Ç–∞—Ü–∏—è: <b>${r.rep}</b>`;
}

function renderPharmacyMeds(){
  ensurePharmacyState();

  const elActive = document.getElementById("pharm-meds-active");
  const elList = document.getElementById("pharm-meds-list");
  if(!elActive || !elList) return;

  // –∞–∫—Ç–∏–≤–Ω–æ–µ –∏–∑—É—á–µ–Ω–∏–µ
  const a = state.pharmacy.medsStudying;
  if(a){
    const m = medById(a.id);
    const leftMs = Math.max(0, Number(a.endAt) - now());
    elActive.style.display = "block";
    elActive.innerHTML = `‚è≥ –ò–∑—É—á–∞–µ—Ç—Å—è: <b>${m ? m.name : a.id}</b> ‚Ä¢ –æ—Å—Ç–∞–ª–æ—Å—å ${Math.ceil(leftMs/1000)}—Å`;
  }else{
    elActive.style.display = "none";
    elActive.innerHTML = "";
  }

  const studied = state.pharmacy.medsStudied || {};

  let html = "";
  for(const m of PHARM_MEDICINES){
    const isStudied = !!studied[m.id];

    // —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
    const needServed = m.req?.served || 0;
    const needPerfect = m.req?.perfect || 0;
    const okReq = (state.pharmacy.served >= needServed) && (state.pharmacy.perfect >= needPerfect);

    const disabled = !!state.pharmacy.medsStudying || isStudied || !okReq;

    html += `
      <div class="card" style="margin-top:10px;">
        <div class="row" style="align-items:flex-start;">
          <div style="flex:1;">
            <div class="listTitle">${isStudied ? "‚úÖ" : "üß™"} ${m.name}</div>
            <div class="listSub" style="opacity:.85;">–¢–µ–≥–∏: ${m.tags.join(", ")}</div>
            <div class="listSub" style="margin-top:6px; opacity:.75;">
              –¢—Ä–µ–±—É–µ—Ç: –æ–±—Å–ª—É–∂–µ–Ω–æ ${needServed}, –∏–¥–µ–∞–ª—å–Ω–æ ${needPerfect}
            </div>
            ${isStudied ? `<div class="hint" style="margin-top:8px;">${m.desc}</div>` : ``}
          </div>
          <div style="text-align:right; min-width:120px;">
            <div class="listSub">üí∞ ${m.studyCoins}</div>
            <div class="listSub">‚è±Ô∏è ${m.studyTimeSec}—Å</div>
          </div>
        </div>

        ${
          isStudied
            ? `<div class="hint" style="color:var(--ok); margin-top:8px;">–ò–∑—É—á–µ–Ω–æ</div>`
            :` <button class="btn ${disabled ? "" : "ok"}" style="margin-top:10px; ${disabled ? "opacity:.55; pointer-events:none;" : ""}"
                 onclick="startMedStudy('${m.id}')">
                 ${okReq ? "–ò–∑—É—á–∏—Ç—å" : "–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ"}
               </button>`
        }
      </div>
    `;
  }

  elList.innerHTML = html;
}

function startMedStudy(medId){
  ensurePharmacyState();
  if(state.pharmacy.medsStudying) return;

  const m = medById(medId);
  if(!m) return;

  // —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
  const needServed = m.req?.served || 0;
  const needPerfect = m.req?.perfect || 0;
  if(state.pharmacy.served < needServed) return;
  if(state.pharmacy.perfect < needPerfect) return;

  if((state.coins||0) < m.studyCoins) return;

  state.coins -= m.studyCoins;
  state.pharmacy.medsStudying = { id: m.id, endAt: now() + m.studyTimeSec*1000 };

  saveState();
  renderPharmacyMeds();
}
window.startMedStudy = startMedStudy;

function processPharmStudyTick(){
  ensurePharmacyState();
  const a = state.pharmacy.medsStudying;
  if(!a) return;
  if(now() >= Number(a.endAt)){
    state.pharmacy.medsStudied[a.id] = true;
    state.pharmacy.medsStudying = null;
    saveState();
  }
}
  

function renderDutySlot(idx, d){
  const div = document.createElement("div");
  div.className = "card";

  if(!d){
    div.innerHTML = `
      <div class="row">
        <div>
          <div class="listTitle">–°–ª–æ—Ç ${idx}: –ø—É—Å—Ç–æ</div>
          <div class="listSub">–ù–∞–∑–Ω–∞—á—å –≤—Ä–∞—á–∞ –≤ ‚Äú–®—Ç–∞—Ç–µ‚Äù.</div>
        </div>
        <button class="btn small" onclick="toggleDutyPicker(${idx})">–ù–∞–∑–Ω–∞—á–∏—Ç—å</button>
      </div>
   ` ;
  } else {
    const f = Math.round(d.fatigue || 0);
    const fCls = fatigueClass(f);
    const fLbl = fatigueLabel(f);

    div.innerHTML = `
      <div class="row">
       <img src="${escapeHtml(d.portrait || '')}" class="methodIcon" alt="">
        <div>
          <div class="listTitle">–°–ª–æ—Ç ${idx}: ${escapeHtml(d.name)}</div>
          <div class="listSub">
            ${rarityLabel(d.rarity)} ‚Ä¢ –º–µ—Ç–æ–¥—ã: ${d.methods.map(m=>escapeHtml(methodName(m))).join(", ")}
          </div>
          <div class="hint">
            –£—Å—Ç–∞–ª–æ—Å—Ç—å: <b class="${fCls}">${f}%</b> ‚Ä¢ ${escapeHtml(fLbl)}
          </div>
        </div>
        <button class="btn small" type="button" onclick="toggleDutyPicker(${idx})">–°–º–µ–Ω–∏—Ç—å</button>
      </div>
   ` ;
  }

  elDuty.appendChild(div);

if(dutyPickSlot === idx){
  elDuty.appendChild(renderDutyPicker(idx));
}
return;
}

let dutyPickSlot = null; // 1 | 2 | null ‚Äî –∫–∞–∫–æ–π —Å–ª–æ—Ç —Å–µ–π—á–∞—Å –≤—ã–±–∏—Ä–∞–µ–º
  
function rerollDuty(slot){
  if(slot==="slot1"){
    state.duty.slot1 = pickRandomDoctorId();
    if(state.duty.slot2===state.duty.slot1) state.duty.slot2 = pickRandomDoctorId(true);
  } else {
    state.duty.slot2 = pickRandomDoctorId(true);
  }
  for (const p of state.patients){
  p.doctorAdviceCache = null;
}
saveState();
refreshVisibleUI();
}

function toggleDutyPicker(slot){
  dutyPickSlot = (dutyPickSlot === slot) ? null : slot;
  refreshVisibleUI();
}

function renderDutyPicker(slot){
  const wrap = document.createElement("div");
  wrap.className = "card";
  wrap.innerHTML = `
    <div class="listTitle">–í—ã–±–æ—Ä –≤—Ä–∞—á–∞ –¥–ª—è —Å–ª–æ—Ç–∞ ${slot}</div>
    <div class="hint">–î–∞, –≤—Ä—É—á–Ω—É—é. –î–∞, –∫–∞–∫ –≤–∑—Ä–æ—Å–ª—ã–µ.</div>
 ` ;

  for(const docId of (state.doctorsOwned || [])){
    const doc = getDoctorById(docId);

    // –∑–∞–ø—Ä–µ—Ç –≤—ã–±—Ä–∞—Ç—å —Ç–æ–≥–æ –∂–µ –≤—Ä–∞—á–∞ –≤ –æ–±–∞ —Å–ª–æ—Ç–∞
    const other = (slot === 1) ? state.duty.slot2 : state.duty.slot1;
    const disabled = (doc.id === other);

    const btn = document.createElement("button");
    btn.className = "btn";
    btn.disabled = disabled;
    btn.innerHTML = `${escapeHtml(doc.name)} <span class="muted">(${rarityLabel(doc.rarity)})</span>`;
    btn.onclick = () => {
      assignDoctorToSlot(doc.id, slot);
      dutyPickSlot = null; // –∑–∞–∫—Ä—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
      refreshVisibleUI();
    };
    wrap.appendChild(btn);
  }

  const close = document.createElement("button");
  close.className = "btn danger";
  close.textContent = "–ó–∞–∫—Ä—ã—Ç—å";
  close.onclick = () => { dutyPickSlot = null; refreshVisibleUI(); };
  wrap.appendChild(close);

  return wrap;
}

function tryPlaceOrOpen(patientId){
  if(!state.shift?.active) { openPatientById(patientId); return; }
  // –µ—Å–ª–∏ –ø–∞—Ü–∏–µ–Ω—Ç —É–∂–µ –≤ –ø–∞–ª–∞—Ç–µ/–æ–∂–∏–¥–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ ‚Äî –æ—Ç–∫—Ä—ã—Ç—å
  const ward = findWardByPatient(patientId);
  if(ward){
    openPatientById(patientId);
    return;
  }

  // –∏–Ω–∞—á–µ –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª–æ–∂–∏—Ç—å –≤ –ø–µ—Ä–≤—É—é —Å–≤–æ–±–æ–¥–Ω—É—é –ø–∞–ª–∞—Ç—É
  const free = state.wards.find(w => (w.patients?.length || 0) < (w.bedsMax || 2));
  if(!free){
    // –Ω–µ—Ç –º–µ—Å—Ç–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É
    openPatientById(patientId);
    return;
  }

  const ok = assignPatientToWard(patientId, free.id);
  if(ok){
    openPatientById(patientId);
  } 
}

function bedCostForWard(w){
  // w.bedsMax ‚Äî —Å–∫–æ–ª—å–∫–æ –∫–æ–µ–∫ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–æ (—Å—Ç–∞—Ä—Ç 2)
  w.bedsMax = w.bedsMax || 2;

  // –ö–∞–∫–∞—è –ø–æ —Å—á—ë—Ç—É –ø–æ–∫—É–ø–∫–∞: 3-—è –∫–æ–π–∫–∞ => n=1, 4-—è => n=2 ... 8-—è => n=6
  const n = (w.bedsMax - 2) + 1;

  // –ñ—ë—Å—Ç–∫–∏–π —Ä–æ—Å—Ç —Ü–µ–Ω—ã (–∫–≤–∞–¥—Ä–∞—Ç–∏—á–Ω—ã–π). –≠—Ç–æ —É–∂–µ ‚Äú–Ω–æ—Ä–º–∞–ª—å–Ω–∞—è –±–æ–ª—å‚Äù.
  // –ü—Ä–∏–º–µ—Ä–Ω–æ –ø–æ–ª—É—á–∏—Ç—Å—è: 3-—è~140, 4-—è~260, 5-—è~420, 6-—è~620, 7-—è~860, 8-—è~1140
  const cost = Math.round(90 + (n*n)*35 + n*15);

  return cost;
}

function buyBed(wardId){
  const w = wardById(wardId);
  if(!w) return;

  w.bedsMax = w.bedsMax || 2;
  const bedsCap = 8;
  if(w.bedsMax >= bedsCap) return;

  const cost = bedCostForWard(w);
  if(state.coins < cost) return;

  state.coins -= cost;
  w.bedsMax += 1;

  saveState();
  refreshVisibleUI();
}

function renderPatient(patientId){
  renderTop();

  const p = patientById(patientId);
  if(!p){
    backToClinic();
    return;
  }

  // ‚úÖ –í—Å–µ–≥–¥–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π
if(elPatientActions){
  elPatientActions.style.display = "block";
}

const ward = findWardByPatient(patientId);
const inWard = !!ward;

const pid = String(patientId);

if(ward?.pendingResults?.[pid]){
  // ‚úÖ –∫–æ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç - –ø—Ä—è—á–µ–º –¥–µ–π—Å—Ç–≤–∏—è
  if(elPatientActions) elPatientActions.style.display = "none";
  showResultForPatient(patientId);
  return;
}

  elPatientTitle.textContent = p.name;

  // –∞–≤–∞—Ç–∞—Ä 
const ava = document.getElementById("patient-avatar");
if(ava){
  ava.src = ensurePatientPortrait(p);
}

// —Ä–µ–¥–∫–æ—Å—Ç—å
const rar = document.getElementById("patient-rarity");
if(rar){
  rar.textContent = rarityLabel(p.rarity || RARITY.COMMON).toLowerCase();
}

const disease = getDiseaseById(p.trueDiseaseId);

if(!p.clue){
  p.clue = pickClueForDisease(disease);
  saveState();
}

const failNote =
  (p.lastTreatmentFailed && p.lastTreatmentId)
    ?  `‚Ä¢ ${methodName(p.lastTreatmentId)} –Ω–µ –ø–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞–ª–æ`
    : "";

elPatientSub.textContent = `${(p.visibleSymptoms || []).join(", ")} ‚Ä¢ ${p.clue}${failNote}`;
if(elPatientClue) elPatientClue.textContent = (p.clue || "?");
if(elPatientDiagnosis) elPatientDiagnosis.textContent = getDiseaseDisplayLine(p);

  
  elPatientActions.innerHTML = "";

if(!inWard){
  const free = state.wards.find(w => (w.patients?.length || 0) < (w.bedsMax || 2));

 elPatientActions.innerHTML = `
  <h2>–î–µ–π—Å—Ç–≤–∏—è</h2>

  <div class="grid2" style="margin-top:10px;">
    <button class="btn ok" ${free ? "" : "disabled"} onclick="placeSelectedToFreeWard()">
      üõè –ü–æ–ª–æ–∂–∏—Ç—å –≤ –ø–∞–ª–∞—Ç—É
      <div class="muted">${free ? "–û—Ç–ø—Ä–∞–≤–∏—Ç –≤ –ø–µ—Ä–≤—É—é —Å–≤–æ–±–æ–¥–Ω—É—é –ø–∞–ª–∞—Ç—É" : "–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö –ø–∞–ª–∞—Ç"}</div>
    </button>

    <button class="btn" onclick="backToClinic()">
      ‚úñ –ó–∞–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É
      <div class="muted">–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∫–ª–∏–Ω–∏–∫—É</div>
    </button>
  </div>
`;
} else {
  elPatientActions.innerHTML = `
    <h2>–î–µ–π—Å—Ç–≤–∏—è</h2>
    <div class="hint">–ü–∞—Ü–∏–µ–Ω—Ç —É–∂–µ –≤ –ø–∞–ª–∞—Ç–µ: ${escapeHtml(ward.name)}</div>
 ` ;
}

  // 1) —Ñ–∏–∫—Å–∏—Ä—É–µ–º 4 –æ–ø—Ü–∏–∏ –ª–µ—á–µ–Ω–∏—è –æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞ –ø–∞—Ü–∏–µ–Ω—Ç–∞
  if(!p.treatmentOptions){
    p.treatmentOptions = pickTreatmentOptions(p);
    saveState();
  }
  const options = p.treatmentOptions;

  // 2) —Ñ–∏–∫—Å–∏—Ä—É–µ–º —Å–æ–≤–µ—Ç—ã –æ–¥–∏–Ω —Ä–∞–∑, –ø–æ–∫–∞ –Ω–µ —Å–º–µ–Ω–∏–ª–∏ –≤—Ä–∞—á–µ–π
  if(!p.doctorAdviceCache){
    const docs = dutyDoctors().filter(Boolean);
    p.doctorAdviceCache = docs.map(d => doctorAdviceText(d, options));
    saveState();
  }
  elAdvice.innerHTML = p.doctorAdviceCache.join("<br>");

 // --- LAB UI (–æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏) ---
const baseMax = state.lab?.maxPerPatient ?? 2;
const max = baseMax + (state.perks?.labExtra ?? 0);

const used = p.labUsed ?? 0;

const baseCost = state.lab?.costCoins ?? 15;
const discount = Math.min(50, state.perks?.labDiscount ?? 0);
const cost = Math.max(1, Math.round(baseCost * (1 - discount/100)));

  const shown = new Set(p.visibleSymptoms || []);
  const hidden = (disease.symptoms || []).filter(s => !shown.has(s));

  const canLab = state.shift?.active
    && used < max
    && state.coins >= cost
    && hidden.length > 0;

  elLabBtn.disabled = !canLab;
 // —Å–Ω–∞—á–∞–ª–∞ –≤—Å–µ–≥–¥–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º
elLabHint.textContent = "";

if((p.labUsed ?? 0) === 0){
  elLabHint.textContent = "–ü–æ—Å–ª–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è 2 –≤–µ—Ä—Å–∏–∏ –¥–∏–∞–≥–Ω–æ–∑–∞.";
} else if((p.labUsed ?? 0) === 1){
  elLabHint.textContent = "–ü–æ—Å–ª–µ –≤—Ç–æ—Ä–æ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –æ—Å—Ç–∞–Ω–µ—Ç—Å—è 1 –≤–µ—Ä—Å–∏—è (–ø–æ–¥ –≤–æ–ø—Ä–æ—Å–æ–º).";
}

  // --- –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: —Ä–µ–∑—É–ª—å—Ç–∞—Ç / –∞–∫—Ç–∏–≤–Ω–æ–µ –ª–µ—á–µ–Ω–∏–µ ---
 // --- –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –∞–∫—Ç–∏–≤–Ω–æ–µ –ª–µ—á–µ–Ω–∏–µ (—Ä–µ–∑—É–ª—å—Ç–∞—Ç —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–ª–∏ —Å–≤–µ—Ä—Ö—É) ---
const active = ward ? getActiveForPatient(ward.id, patientId) : null;

if(active){
  // ‚úÖ –∫–æ–≥–¥–∞ –ª–µ—á–µ–Ω–∏–µ —É–∂–µ –≤—ã–±—Ä–∞–Ω–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–∏–¥—ë—Ç –ª–µ—á–µ–Ω–∏–µ", –∞ –Ω–µ –º–µ—Ç–æ–¥—ã
  if(elPatientActions) elPatientActions.style.display = "block";
  showActive(active);
  return;
}
  // –∏–Ω–∞—á–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –ª–µ—á–µ–Ω–∏—è
  showTreat(options);
}

 function getDiseaseDisplayLine(p){
  // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¢–û–õ–¨–ö–û —Ç–µ–∫—Å—Ç –¥–∏–∞–≥–Ω–æ–∑–∞ (–±–µ–∑ "–î–∏–∞–≥–Ω–æ–∑:"), —á—Ç–æ–±—ã UI —Å–∞–º —Ä–µ—à–∞–ª –∫–∞–∫ —Ä–∏—Å–æ–≤–∞—Ç—å

  // 0) –¥–æ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
  if(!p?.diffCandidates && !p?.diffFinalId){
    return "???";
  }

  // 1) –ø–æ—Å–ª–µ 1 –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è: –¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞
  if(Array.isArray(p.diffCandidates) && p.diffCandidates.length === 2 && !p.diffFinalId){
    const a = getDiseaseById(p.diffCandidates[0])?.name || "???";
    const b = getDiseaseById(p.diffCandidates[1])?.name || "???";
    return `${a} –∏–ª–∏ ${b}`;
  }

  // 2) –ø–æ—Å–ª–µ 2 –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è: –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç, –Ω–æ —Å–æ–º–Ω–µ–Ω–∏–µ –æ—Å—Ç–∞—ë—Ç—Å—è
  if(p.diffFinalId){
    const a = getDiseaseById(p.diffFinalId)?.name || "???";
    return `${a} (–ø–æ–¥ –≤–æ–ø—Ä–æ—Å–æ–º)`;
  }

  return "???";
}

  function scoreDiseaseBySymptoms(disease, symptoms){
  // —Å–∫–æ–ª—å–∫–æ —Å–∏–º–ø—Ç–æ–º–æ–≤ —Å–æ–≤–ø–∞–ª–æ
  const ds = new Set(disease.symptoms || []);
  let hit = 0;
  for(const s of symptoms){
    if(ds.has(s)) hit++;
  }
  // –º–∞–ª–µ–Ω—å–∫–∏–π —à—É–º, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –∏–¥–µ–∞–ª—å–Ω–æ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ
  return hit + Math.random()*0.05;
}

function pickTwoDiseaseCandidates(p){
  const symptoms = p.visibleSymptoms || [];
  const scored = DISEASES
    .map(d => ({ id:d.id, score: scoreDiseaseBySymptoms(d, symptoms) }))
    .sort((a,b)=> b.score - a.score);

  // –í–∞–∂–Ω–æ: —á—Ç–æ–±—ã –Ω–∞—Å—Ç–æ—è—â–∏–π –¥–∏–∞–≥–Ω–æ–∑ –∏–º–µ–ª —à–∞–Ω—Å –±—ã—Ç—å –≤ —Ç–æ–ø–µ (–æ–±—ã—á–Ω–æ –±—É–¥–µ—Ç)
  // –Ω–æ —á—Ç–æ–±—ã –∏–Ω–æ–≥–¥–∞ –º–æ–∂–Ω–æ –±—ã–ª–æ –æ—à–∏–±–∞—Ç—å—Å—è, –æ—Å—Ç–∞–≤–∏–º –∫–∞–∫ –µ—Å—Ç—å, –±–µ–∑ "—Ñ–æ—Ä—Å trueDisease"
  const a = scored[0]?.id || p.trueDiseaseId;
  let b = scored.find(x => x.id !== a)?.id || p.trueDiseaseId;

  // –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –ø–æ–ª—É—á–∏–ª–æ—Å—å –æ–¥–∏–Ω–∞–∫–æ–≤–æ
  if(b === a){
    b = DISEASES.find(d => d.id !== a)?.id || a;
  }

  return [a,b];
}

  function pickFinalDiseaseFromCandidates(p){
  // –µ—Å–ª–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –Ω–µ—Ç, –ø—Ä–æ—Å—Ç–æ —Å—Ç–∞–≤–∏–º "—Å–∞–º—ã–π –ø–æ–¥—Ö–æ–¥—è—â–∏–π" –ø–æ —Å–∏–º–ø—Ç–æ–º–∞–º
  const candidates = (p.diffCandidates && p.diffCandidates.length) ? p.diffCandidates : DISEASES.map(d=>d.id);

  const symptoms = p.visibleSymptoms || [];
  const scored = candidates
    .map(id => {
      const d = getDiseaseById(id);
      return { id, score: scoreDiseaseBySymptoms(d, symptoms) };
    })
    .sort((a,b)=> b.score - a.score);

  return scored[0]?.id || p.trueDiseaseId;
}

function upgradeQueueSize(){
  const cost = 40 + (state.maxQueue - 4) * 30; // –ø—Ä–∏–º–µ—Ä
  if(state.money < cost) return;
  state.money -= cost;
  state.maxQueue += 2;
  saveState(); refreshVisibleUI();
}

function upgradeWaitTime(){
  const cost = 50 + Math.floor((120 - state.baseWaitSec) / 10) * 25;
  if(state.money < cost) return;
  state.money -= cost;
  state.baseWaitSec += 20; // +10 —Å–µ–∫ —Ç–µ—Ä–ø–µ–Ω–∏—è
  saveState(); refreshVisibleUI();
}

  function placeSelectedToFreeWard(){
  if(!state.shift?.active) return;
  const pid = state.selectedPatientId;
  if(!pid) return;

  const free = state.wards.find(w => (w.patients?.length || 0) < (w.bedsMax || 2) && !w.pendingResult);
  if(!free) return;

  const ok = assignPatientToWard(pid, free.id);
  if(ok){
    saveState();
    renderPatient(pid);
    refreshVisibleUI();
  }
}
window.placeSelectedToFreeWard = placeSelectedToFreeWard;

function labResearchSelected(){
  if(!state.shift?.active) return;
  if(!state.selectedPatientId) return;
  const p = patientById(state.selectedPatientId);
  if(!p) return;

  // –ª–∏–º–∏—Ç –Ω–∞ –ø–∞—Ü–∏–µ–Ω—Ç–∞
 const baseMax = state.lab?.maxPerPatient ?? 2;
const max = baseMax + (state.perks?.labExtra ?? 0);

if((p.labUsed ?? 0) >= max) return;

const baseCost = state.lab?.costCoins ?? 15;
const discount = Math.min(50, state.perks?.labDiscount ?? 0);
const cost = Math.max(1, Math.round(baseCost * (1 - discount/100)));

const labSub = document.getElementById("lab-sub");
if(labSub){
  elLabSub.innerHTML = `
  –û—Ç–∫—Ä–æ–µ—Ç –Ω–æ–≤—ã–π —Å–∏–º–ø—Ç–æ–º ‚Ä¢ –¶–µ–Ω–∞: ${cost}
  <img src="img/topbar/icon_coins.png" class="coinIcon" alt="">
`;
}

if(state.coins < cost) return;

  const d = getDiseaseById(p.trueDiseaseId);

  // –∫–∞–∫–∏–µ —Å–∏–º–ø—Ç–æ–º—ã —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω—ã
  const shown = new Set(p.visibleSymptoms || []);
  const hidden = (d.symptoms || []).filter(s => !shown.has(s));

  // –µ—Å–ª–∏ –Ω–µ—á–µ–≥–æ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å
  if(hidden.length === 0) return;

  // —Å–ø–∏—Å—ã–≤–∞–µ–º –æ–ø–ª–∞—Ç—É
  state.coins -= cost;

  // –æ—Ç–∫—Ä—ã–≤–∞–µ–º 1 –Ω–æ–≤—ã–π —Å–∏–º–ø—Ç–æ–º
  const newSym = pick(hidden);
  p.visibleSymptoms.push(newSym);

  // —Å—á–µ—Ç—á–∏–∫
  p.labUsed = (p.labUsed ?? 0) + 1;

  // –≤–∞–∂–Ω–æ–µ: –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–∏–º–ø—Ç–æ–º–æ–≤ –º–æ–∂–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å –∫–µ—à —Å–æ–≤–µ—Ç–æ–≤,
  // —á—Ç–æ–±—ã –≤—Ä–∞—á–∏ "–æ—Ç—Ä–µ–∞–≥–∏—Ä–æ–≤–∞–ª–∏" (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ –≤–∫—É—Å–Ω–æ)
  p.doctorAdviceCache = null;
  p.clue = null;

  // –î–∏–∞–≥–Ω–æ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω, –µ—Å–ª–∏ —Å–¥–µ–ª–∞–ª–∏ max –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π –ò–õ–ò –µ—Å–ª–∏ —Å–∫—Ä—ã—Ç—ã—Ö —Å–∏–º–ø—Ç–æ–º–æ–≤ –±–æ–ª—å—à–µ –Ω–µ—Ç
const disease2 = getDiseaseById(p.trueDiseaseId);

const shown2 = new Set(p.visibleSymptoms || []);
const hidden2 = (disease2.symptoms || []).filter(s => !shown2.has(s));

if((p.labUsed ?? 0) >= max || hidden2.length === 0){
}

// 1-–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ -> –ø–æ–∫–∞–∑—ã–≤–∞–µ–º 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞
if((p.labUsed ?? 0) === 1){
  p.diffCandidates = pickTwoDiseaseCandidates(p);
  p.diffFinalId = null;
}

// 2-–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ -> –æ—Å—Ç–∞–≤–ª—è–µ–º 1 –≤–∞—Ä–∏–∞–Ω—Ç (–ø–æ–¥ –≤–æ–ø—Ä–æ—Å–æ–º)
if((p.labUsed ?? 0) >= 2){
  p.diffFinalId = pickFinalDiseaseFromCandidates(p);
}  

if(p.knownDisease && !p.diagnosisRewarded){
  p.diagnosisRewarded = true;

  let repBonus = 1;
  const ev = getCurrentEvent();
  if(ev?.id === "holy_week") repBonus = 2; // —Å–≤—è—Ç–æ—Å—Ç—å –≤ –∫—Ä–µ–¥–∏—Ç

  state.reputation = (state.reputation || 0) + repBonus;
  state.coins += 3;
}

  saveState();
  renderPatient(p.id);
  refreshVisibleUI();
}

function showTreat(options){
  elTreatPanel.style.display = "block";
  elActiveTreatment.style.display = "none";
  elResultPanel.style.display = "none";

  // üëá –ù–ï–î–ï–õ–Ø –°–í–Ø–¢–û–ì–û –®–ï–°–¢–í–ò–Ø: —Ç–æ–ª—å–∫–æ –º–æ–ª–∏—Ç–≤–∞
  const ev = getCurrentEvent();
  if(ev?.id === "holy_week"){
    options = ["prayer"];
  }

  elTreatmentButtons.innerHTML = "";

  for(const mid of options){
    const b = document.createElement("button");
    b.className = "btn";
    b.onclick = ()=> chooseTreatment(mid);
    const hint = methodHintLine(mid);

const icon = METHOD_ICONS[mid] || "";

b.classList.add("methodBtn");

b.innerHTML = `
  <img class="methodIcon" src="${icon}" alt="${mid}" loading="lazy"
       onerror="this.style.display='none'">
  <div class="methodMeta">
    <div style="font-weight:900">${escapeHtml(methodName(mid))}</div>
    <div class="muted">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –Ω–∞–∑–Ω–∞—á–∏—Ç—å</div>
    ${hint ? `<div class="hint">${escapeHtml(hint)}</div>` : ""}
  </div>
`;
    elTreatmentButtons.appendChild(b);
  }
}

function showActive(active){
  elTreatPanel.style.display = "none";
  elActiveTreatment.style.display = "block";
  elResultPanel.style.display = "none";

  elActiveName.textContent = methodName(active.treatmentId);
  elActiveTimer.textContent = formatLeft(active.endAt - now());
}

function showResultForPatient(patientId){
  const ward = findWardByPatient(patientId);
  if(!ward) return;

 ward.pendingResults = ward.pendingResults || {};
const pid = String(patientId);
const r = ward.pendingResults[pid];
if(!r) return;

  elTreatPanel.style.display = "none";
  elActiveTreatment.style.display = "none";
  elResultPanel.style.display = "block";

  const kind = r.kind;

  const label =
    kind===OUTCOMES.CURE ? "‚úÖ –í—ã–ª–µ—á–µ–Ω" :
    kind===OUTCOMES.DISFIGURED ? "‚úÖ –í—ã–ª–µ—á–µ–Ω (–Ω–æ –ø–æ–∫–∞–ª–µ—á–µ–Ω)" :
    kind===OUTCOMES.INFECTED ? "‚úÖ –í—ã–ª–µ—á–µ–Ω (–Ω–æ –∏–Ω—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω)" :
    kind===OUTCOMES.WORSENED ? "‚ö†Ô∏è –°—Ç–∞–ª–æ —Ö—É–∂–µ" :
    "‚ò†Ô∏è –°–º–µ—Ä—Ç—å";

  let primaryBtnHtml = "";

  if(kind === OUTCOMES.WORSENED){
    primaryBtnHtml = `
      <button class="btn warn" onclick="continueTreatment('${patientId}','${ward.id}')">
        üîÅ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ª–µ—á–µ–Ω–∏–µ
        <div class="muted">–ü–∞—Ü–∏–µ–Ω—Ç –≤ –∫—Ä–∏–∑–∏—Å–µ: –ª–∏–±–æ –≤—ã—Ç–∞—â–∏–º, –ª–∏–±–æ –æ–Ω –æ—Ç—ä–µ–¥–µ—Ç</div>
      </button>
      <button class="btn" onclick="dischargePatient('${patientId}','${ward.id}')">
        ‚úñ –ó–∞–∫—Ä—ã—Ç—å —Å–ª—É—á–∞–π
        <div class="muted">–¢—ã —Å–¥–∞—ë—à—å—Å—è. –†–µ–ø—É—Ç–∞—Ü–∏—è –≤—Å—ë –∑–∞–ø–æ–º–Ω–∏—Ç.</div>
      </button>
   ` ;
  } else {
    const btnText = (kind===OUTCOMES.DEATH) ? "–í –º–æ—Ä–≥ (–∑–∞–∫—Ä—ã—Ç—å —Å–ª—É—á–∞–π)" : "–í—ã–ø–∏—Å–∞—Ç—å";
    primaryBtnHtml = `
      <button class="btn ok" onclick="dischargePatient('${patientId}','${ward.id}')">
        ${btnText}
        <div class="muted">–û—Å–≤–æ–±–æ–¥–∏—Ç –ø–∞–ª–∞—Ç—É</div>
      </button>
    `;
  }

  elResultText.innerHTML = `
    <div class="listTitle">${label}</div>
    <div class="listSub">${escapeHtml(r.flavor || "")}</div>
    <div class="sep"></div>
    <div class="hint">
      üí∞ ${r.coins>=0?"+":""}${r.coins} ‚Ä¢ ‚≠ê ${r.reputation>=0?"+":""}${r.reputation} ‚Ä¢ üß´ ${r.biomaterial>=0?"+":""}${r.biomaterial}
    </div>
    <div class="sep"></div>
    ${primaryBtnHtml}
  `;
}
window.showResultForPatient = showResultForPatient;
function refreshVisibleUI(){
  // –µ—Å–ª–∏ —Å–º–µ–Ω–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å ‚Äî –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ç–æ–≥–∏ –∏ —Å—Ç–æ–ø–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω–æ–π —Ä–µ–Ω–¥–µ—Ä
  if(!state.shift?.active){
    renderShiftEnd();
    showScreen("shiftend");
    return;
  }

  const clinicVisible = document.getElementById("screen-clinic").classList.contains("active");
  const patientVisible = document.getElementById("screen-patient").classList.contains("active");
  const staffVisible = document.getElementById("screen-staff").classList.contains("active");
  const shopVisible  = document.getElementById("screen-shop").classList.contains("active");
  const researchVisible = document.getElementById("screen-research").classList.contains("active");
if(researchVisible){
  renderResearch();
}

  if(clinicVisible) renderClinic();
  if(patientVisible && state.selectedPatientId) renderPatient(state.selectedPatientId);
  if(staffVisible) renderStaff();
  if(shopVisible) renderShop();
}

/* =========================================================
   13) TICKS (queue + treatments + patient timer)
========================================================= */

let uiTick = null;

function startUITick(){
  if(uiTick) return;
  uiTick = setInterval(()=>{
    // –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–µ—Ä —Ç–æ–ª—å–∫–æ –Ω–∞ —ç–∫—Ä–∞–Ω–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞, –µ—Å–ª–∏ –æ–Ω –æ—Ç–∫—Ä—ã—Ç
    const patientVisible = document.getElementById("screen-patient").classList.contains("active");
    if(patientVisible && state.selectedPatientId){
      const ward = findWardByPatient(state.selectedPatientId);
if(ward){
  const a = getActiveForPatient(ward.id, state.selectedPatientId);
  if(a){
    if(now() >= a.endAt){
      completeTreatmentPatient(ward.id, state.selectedPatientId);
    } else {
      showActive({ treatmentId: a.treatmentId, endAt: a.endAt });
    }
  }
}
    }
  }, 250);
}

function processTreatmentsTick(){
  const map = getActiveMap();
  const t = now();
  let changed = false;

  for(const wardId of Object.keys(map)){
    const wardMap = map[wardId] || {};
    for(const patientId of Object.keys(wardMap)){
      const a = wardMap[patientId];
      if(!a) continue;

      if(t >= Number(a.endAt)){
        completeTreatmentPatient(wardId, patientId);
        changed = true;
      }
    }
  }

  if(changed) refreshVisibleUI();
}

setInterval(()=>{
  try{
    ensureShiftTimer();

    processResearchTick();

    // ‚úÖ –õ–û–ú–ê–õ–ö–ê –ê–ü–ì–†–ï–ô–î–û–í (1 —Ä–∞–∑ –∑–∞ —Ç–∏–∫)
    if(state.shift?.active){
      (state.wards || []).forEach(w => maybeBreakWardUpgrade(w));
    }

    const endAt = Number(state.shift?.endAt);
    if(state.shift?.active && Number.isFinite(endAt) && now() >= endAt){
      endShift();
      return;
    }

    fillQueue(); 
    processQueueTick();
    processTreatmentsTick();
    processPharmStudyTick();
    processPharmacyTick();
    state.wards.forEach(w => maybeBreakWardUpgrade(w));
    refreshVisibleUI();
  }catch(err){
    console.log("TICK CRASH", err);
    alert("TICK CRASH:\n" + (err?.stack || err));
  }
}, 500);

startUITick();

const LS_TUTORIAL_DONE = "plague_tutorial_done_v1";

const tut = {
  active:false,
  step:0,
  steps:[]
};

const elTutOverlay = document.getElementById("tut-overlay");
const elTutTitle = document.getElementById("tut-title");
const elTutText  = document.getElementById("tut-text");
const elTutHint  = document.getElementById("tut-hint");
const elTutSpot  = document.getElementById("tut-spot");
const elTutPrev  = document.getElementById("tut-prev");
const elTutNext  = document.getElementById("tut-next");
const elTutClose = document.getElementById("tut-close");

function qs(x){ return document.querySelector(x); }

function buildTutorialSteps(){
  return [
    {
      title:"–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —á—É–º–Ω—É—é –∫–ª–∏–Ω–∏–∫—É",
      text:"–¢—ã –ª–µ—á–∏—à—å –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤ –≤ —ç–ø–æ—Ö—É, –∫–æ–≥–¥–∞ –º–µ–¥–∏—Ü–∏–Ω–∞ —ç—Ç–æ —Å–ª—É—Ö–∏ –∏ —Å–º–µ–ª–æ—Å—Ç—å. –ü–∞—Ü–∏–µ–Ω—Ç—ã –ø—Ä–∏—Ö–æ–¥—è—Ç –≤ –æ—á–µ—Ä–µ–¥—å, —Ç—ã –∫–ª–∞–¥—ë—à—å –∏—Ö –≤ –ø–∞–ª–∞—Ç—ã, –≤—ã–±–∏—Ä–∞–µ—à—å –ª–µ—á–µ–Ω–∏–µ, –∏–Ω–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ. –î–∞, –ª—é–¥–∏ –±—É–¥—É—Ç —É–º–∏—Ä–∞—Ç—å. –≠—Ç–æ –Ω–µ –±–∞–≥, —ç—Ç–æ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç—å.",
      hint:"–¶–µ–ª—å: –ø–µ—Ä–µ–∂–∏—Ç—å —Å–º–µ–Ω—É, –ª–µ—á–∏—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ, —Ä–∞—Å—à–∏—Ä—è—Ç—å—Å—è, –∫–æ–ø–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã.",
      focus: ".topbar"
    },

    {
      title:"–í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å: —Ä–µ—Å—É—Ä—Å—ã",
      text:"üí∞ –ú–æ–Ω–µ—Ç—ã: –ø–æ–∫—É–ø–∫–∞ –∫–æ–µ–∫/–∞–ø–≥—Ä–µ–π–¥–æ–≤/–∏–∑—É—á–µ–Ω–∏–π. ‚≠ê –†–µ–ø—É—Ç–∞—Ü–∏—è: –≤–ª–∏—è–µ—Ç –Ω–∞ —ç–∫–æ–Ω–æ–º–∏–∫—É –∏ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –ø—Ä–æ–≤–∞–ª–æ–≤. üß´ –ë–∏–æ–º–∞—Ç–µ—Ä–∏–∞–ª: –≤–∞–ª—é—Ç–∞ –¥–ª—è —Å—Ç—Ä–∞–Ω–Ω—ã—Ö —É–ª—É—á—à–µ–Ω–∏–π. ‚è≥ –¢–∞–π–º–µ—Ä —Å–º–µ–Ω—ã: –ø–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—é –±—É–¥–µ—Ç –Ω–∞–≥—Ä–∞–¥–∞.",
      hint:"–†–µ–ø—É—Ç–∞—Ü–∏—è –≤ –º–∏–Ω—É—Å–µ –¥–µ–ª–∞–µ—Ç –∂–∏–∑–Ω—å –¥–æ—Ä–æ–∂–µ –∏ —Ö—É–∂–µ. –ö–∞–∫ –∏ –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏.",
      focus: ".topbar"
    },

    {
      title:"–û—á–µ—Ä–µ–¥—å –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤",
      text:"–û—á–µ—Ä–µ–¥—å —ç—Ç–æ –Ω–∞–±–æ—Ä –ª—é–¥–µ–π —Å —Ç–∞–π–º–µ—Ä–æ–º: –µ—Å–ª–∏ –¥–æ–∂–¥–∞–ª–∏—Å—å –∫–æ–Ω—Ü–∞, –æ–Ω–∏ —É—Ö–æ–¥—è—Ç –∏–ª–∏ —É–º–∏—Ä–∞—é—Ç, –∞ —Ç–µ–±–µ –ø—Ä–∏–ª–µ—Ç–∞–µ—Ç —Ä–µ–ø—É—Ç–∞—Ü–∏–æ–Ω–Ω–∞—è –±–æ–ª—å. –û—á–µ—Ä–µ–¥—å –º–æ–∂–Ω–æ –ø—Ä–æ–∫–∞—á–∏–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ (–µ—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å –∞–ø–≥—Ä–µ–π–¥—ã –æ—á–µ—Ä–µ–¥–∏).",
      hint:"–ù–µ –¥–∞–≤–∞–π –æ—á–µ—Ä–µ–¥–∏ –≥–Ω–∏—Ç—å. –≠—Ç–æ —Ñ–∞–±—Ä–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º.",
      focus: "#queue"
    },

    {
      title:"–†–µ–¥–∫–æ—Å—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤ (–í–ê–ñ–ù–û)",
      text:"–ü–∞—Ü–∏–µ–Ω—Ç—ã –±—ã–≤–∞—é—Ç: Common / Rare / Legendary. –û—Ç —Ä–µ–¥–∫–æ—Å—Ç–∏ –∑–∞–≤–∏—Å–∏—Ç –í–†–ï–ú–Ø –ª–µ—á–µ–Ω–∏—è –∏ –ù–ê–ì–†–ê–î–ê.\n‚Ä¢ Common: 2‚Äì5 –º–∏–Ω—É—Ç, –Ω–∞–≥—Ä–∞–¥–∞ x1\n‚Ä¢ Rare: 8‚Äì15 –º–∏–Ω—É—Ç, –Ω–∞–≥—Ä–∞–¥–∞ x1.5\n‚Ä¢ Legendary: 13‚Äì20 –º–∏–Ω—É—Ç, –Ω–∞–≥—Ä–∞–¥–∞ x2",
      hint:"–†–µ–¥–∫–∏—Ö –ª–µ—á–∏—Ç—å –¥–æ–ª—å—à–µ, –Ω–æ –æ–Ω–∏ –∫–æ—Ä–º—è—Ç —Ç–µ–±—è –ª—É—á—à–µ.",
      focus: "#queue"
    },

    {
      title:"–ü–∞–ª–∞—Ç—ã –∏ –∫–æ–π–∫–∏",
      text:"–ü–∞–ª–∞—Ç–∞ —Ö—Ä–∞–Ω–∏—Ç –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤. –£ –ø–∞–ª–∞—Ç—ã –µ—Å—Ç—å –ª–∏–º–∏—Ç –∫–æ–µ–∫: —Å—Ç–∞—Ä—Ç 2, –º–∞–∫—Å–∏–º—É–º 8. –ö–Ω–æ–ø–∫–∞ ¬´–ö—É–ø–∏—Ç—å –∫–æ–π–∫—É¬ª —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –ª–∏–º–∏—Ç –º–µ—Å—Ç.",
      hint:"–ë–µ–∑ –∫–æ–µ–∫ —Ç—ã –ø—Ä–æ—Å—Ç–æ —Å–º–æ—Ç—Ä–∏—à—å, –∫–∞–∫ –ª—é–¥–∏ —É—Ö–æ–¥—è—Ç. –û—Ç–ª–∏—á–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –¥–ª—è –≤—Ä–∞–≥–∞.",
      focus: "#wards"
    },

    {
      title:"–£–ª—É—á—à–µ–Ω–∏—è –ø–∞–ª–∞—Ç—ã + –ø–æ–ª–æ–º–∫–∏",
      text:"–ö–æ–º—Ñ–æ—Ä—Ç/–ß–∏—Å—Ç–æ—Ç–∞/–í–µ–Ω—Ç–∏–ª—è—Ü–∏—è/–°–≤–µ—Ç –≤–ª–∏—è—é—Ç –Ω–∞ –∏—Å—Ö–æ–¥—ã –ª–µ—á–µ–Ω–∏—è. –ù–æ —Ç–µ–ø–µ—Ä—å –æ–Ω–∏ –º–æ–≥—É—Ç –õ–û–ú–ê–¢–¨–°–Ø –∏ –¥–∞–≤–∞—Ç—å —à—Ç—Ä–∞—Ñ (–Ω–∞–ø—Ä–∏–º–µ—Ä ‚àí1 –∫ –ø–∞—Ä–∞–º–µ—Ç—Ä—É), –ø–æ–∫–∞ —Ç—ã –Ω–µ –ø–æ—á–∏–Ω–∏—à—å –∑–∞ –º–æ–Ω–µ—Ç—ã.",
      hint:"–ê–ø–≥—Ä–µ–π–¥—ã —ç—Ç–æ —Å–∏–ª–∞. –ü–æ–ª–æ–º–∫–∏ —ç—Ç–æ –Ω–∞–ª–æ–≥ –Ω–∞ –∂–∏–∑–Ω—å.",
      focus: "#wards"
    },

    {
      title:"–ö–∞—Ä—Ç–æ—á–∫–∞ –ø–∞—Ü–∏–µ–Ω—Ç–∞",
      text:"–û—Ç–∫—Ä—ã–≤–∞–π –ø–∞—Ü–∏–µ–Ω—Ç–∞, —Å–º–æ—Ç—Ä–∏ —Å–∏–º–ø—Ç–æ–º—ã. –ù–∞–∑–Ω–∞—á–∞–µ—à—å –ª–µ—á–µ–Ω–∏–µ –∏ –∂–¥—ë—à—å —Ç–∞–π–º–µ—Ä. –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –≤—ã–ø–∏—Å–∞—Ç—å / –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å / –º–æ—Ä–≥ (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∏—Å—Ö–æ–¥–∞).",
      hint:"–ï—Å–ª–∏ –ª–µ—á–µ–Ω–∏–µ –Ω–µ –ø–æ–º–æ–≥–ª–æ: –æ–±—ã—á–Ω–æ –¥–∞—ë—Ç—Å—è –≤—ã–±–æ—Ä –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–ª–∏ –≤—ã–ø–∏—Å–∞—Ç—å. –ü–æ—Å–ª–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –Ω–µ—É–¥–∞—á–∏ –ø–∞—Ü–∏–µ–Ω—Ç –º–æ–∂–µ—Ç —É–º–µ—Ä–µ—Ç—å (–µ—Å–ª–∏ —É —Ç–µ–±—è —Ç–∞–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ).",
      focus: "#screen-patient"
    },

    {
      title:"–û–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ (–±—ã–≤—à–∞—è –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è)",
      text:"–û–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –Ω–æ–≤—ã–π —Å–∏–º–ø—Ç–æ–º –∏ –ø–æ–º–æ–≥–∞–µ—Ç —Å—É–∑–∏—Ç—å –¥–∏–∞–≥–Ω–æ–∑. –°—Ç–æ–∏—Ç –º–æ–Ω–µ—Ç—ã –∏ –∏–º–µ–µ—Ç –ª–∏–º–∏—Ç –Ω–∞ –ø–∞—Ü–∏–µ–Ω—Ç–∞.",
      hint:"–û–±—Å–ª–µ–¥—É–π —Ä–µ–¥–∫–∏—Ö –∏ –Ω–µ–ø–æ–Ω—è—Ç–Ω—ã—Ö. –ù–∞ –≤—Å–µ—Ö –ø–æ–¥—Ä—è–¥ —Ä–∞–∑–æ—Ä–∏—à—å—Å—è.",
      focus: "#btn-lab"
    },

    {
      title:"–ò–∑—É—á–µ–Ω–∏–µ (–¥–µ—Ä–µ–≤–æ –Ω–∞–≤—ã–∫–æ–≤)",
      text:"–í –º–µ–Ω—é –µ—Å—Ç—å –≤–∫–ª–∞–¥–∫–∞ ¬´–ò–∑—É—á–µ–Ω–∏–µ¬ª. –¢–∞–º —Ç—ã –∏—Å—Å–ª–µ–¥—É–µ—à—å —É–ª—É—á—à–µ–Ω–∏—è –∑–∞ –º–æ–Ω–µ—Ç—ã/–±–∏–æ–º–∞—Ç–µ—Ä–∏–∞–ª –∏ –≤—Ä–µ–º—è. –≠—Ç–æ –¥–æ–ª–≥–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å: –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –Ω–∞–≤—ã–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä ¬´–†–µ–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä–∞¬ª) –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –¥–æ—Ä–æ–≥–∏–º–∏ –∏ –∏–∑—É—á–∞—Ç—å—Å—è –¥–æ–ª–≥–æ.",
      hint:"–ò–∑—É—á–µ–Ω–∏–µ —ç—Ç–æ –º–µ—Ç–∞-–ø—Ä–æ–≥—Ä–µ—Å—Å –º–µ–∂–¥—É —Å–º–µ–Ω–∞–º–∏. –î–µ–ª–∞–π —ç—Ç–æ —Ü–µ–ª—å—é –Ω–∞ –¥–æ–ª–≥—É—é –∏–≥—Ä—É.",
      focus: "#screen-research"
    },

    {
      title:"–ù–µ–¥–µ–ª–∏ –∏ —Å–æ–±—ã—Ç–∏—è",
      text:"–ö–∞–∂–¥–∞—è –Ω–µ–¥–µ–ª—è –º–æ–∂–µ—Ç –¥–∞–≤–∞—Ç—å –±–∞—Ñ—ã/–¥–µ–±–∞—Ñ—ã: –º–µ–Ω—è–µ—Ç—Å—è –æ—á–µ—Ä–µ–¥—å, —ç–∫–æ–Ω–æ–º–∏–∫–∞, –∏—Å—Ö–æ–¥—ã –∏ –ø—Ä–∞–≤–∏–ª–∞. –≠—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–º–µ–Ω—ã —Ä–∞–∑–Ω—ã–º–∏.",
      hint:"–ï—Å–ª–∏ –Ω–µ–¥–µ–ª—è –ø–ª–æ—Ö–∞—è, —Å—Ç—Ä–∞–¥–∞—é—Ç –≤—Å–µ. –í–∫–ª—é—á–∞—è —Ç–µ–±—è.",
      focus: ".topbar"
    },

    {
      title:"–ö–æ–Ω–µ—Ü —Å–º–µ–Ω—ã –∏ –Ω–∞–≥—Ä–∞–¥—ã",
      text:"–ö–æ–≥–¥–∞ —Å–º–µ–Ω–∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è, –ø–æ—è–≤–ª—è–µ—Ç—Å—è —ç–∫—Ä–∞–Ω –Ω–∞–≥—Ä–∞–¥. –¢—ã –≤—ã–±–∏—Ä–∞–µ—à—å –æ–¥–∏–Ω –±–æ–Ω—É—Å –∏–∑ —Ç—Ä—ë—Ö. –≠—Ç–æ —É—Å–∫–æ—Ä—è–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ —Å—Ç–∏–ª—å –∏–≥—Ä—ã.",
      hint:"–í—ã–±–∏—Ä–∞–π –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ: —ç–∫–æ–Ω–æ–º–∏–∫—É, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∏–ª–∏ —É—Å–∫–æ—Ä–µ–Ω–∏–µ.",
      focus: "#screen-shiftend"
    }

    tut.steps.push({
  title:"–ê–ø—Ç–µ–∫–∞",
  text:"üè∫ –ü–æ—è–≤–∏–ª–∞—Å—å –ê–ø—Ç–µ–∫–∞. –ö–ª–∏–µ–Ω—Ç—ã –ø—Ä–∏—Ö–æ–¥—è—Ç —Ä–µ–¥–∫–æ, –Ω–æ –¥–∞—é—Ç –¥–µ–Ω—å–≥–∏ –∏ —Ä–µ–ø—É—Ç–∞—Ü–∏—é. –ß–∞—Å—Ç–æ—Ç—É –º–æ–∂–Ω–æ –ø—Ä–æ–∫–∞—á–∞—Ç—å –≤–æ –≤–∫–ª–∞–¥–∫–µ ‚Äú–ò–∑—É—á–µ–Ω–∏–µ‚Äù."
});

tut.steps.push({
  title:"–õ–µ–∫–∞—Ä—Å—Ç–≤–∞",
  text:"üß™ –í –ê–ø—Ç–µ–∫–µ –º–æ–∂–Ω–æ –∏–∑—É—á–∞—Ç—å –ª–µ–∫–∞—Ä—Å—Ç–≤–∞ –∑–∞ –¥–µ–Ω—å–≥–∏ –∏ –≤—Ä–µ–º—è. –ò–∑—É—á–µ–Ω–Ω—ã–µ –ª–µ–∫–∞—Ä—Å—Ç–≤–∞ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞—é—Ç—Å—è –∫–∞–∫ ‚Äú–ø–æ–¥—Ö–æ–¥—è—â–∏–µ‚Äù –∫ –∑–∞–ø—Ä–æ—Å–∞–º –∫–ª–∏–µ–Ω—Ç–æ–≤."
});
    
  ];
}

function startTutorial(fromButton=false){
  tut.steps = buildTutorialSteps();
  tut.active = true;
  tut.step = 0;

  elTutOverlay.classList.add("active");
  renderTutorialStep();

  // –ï—Å–ª–∏ —ç—Ç–æ –∞–≤—Ç–æ-–æ–±—É—á–µ–Ω–∏–µ (–ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫), –æ—Ç–º–µ—Ç–∏–º ‚Äú–≤–∏–¥–µ–ª‚Äù
  if(!fromButton){
    localStorage.setItem(LS_TUTORIAL_DONE, "1");
  }
}

function stopTutorial(){
  tut.active = false;
  elTutOverlay.classList.remove("active");
  elTutSpot.style.display = "none";
}

function renderTutorialStep(){
  if(!tut.active) return;

  const s = tut.steps[tut.step];
  if(!s){ stopTutorial(); return; }
  elTutTitle.textContent = `${tut.step+1}/${tut.steps.length} ‚Ä¢ ${s.title}`;
  elTutText.textContent  = s.text;
  elTutHint.textContent  = s.hint || "";

  // –∫–Ω–æ–ø–∫–∏
  elTutPrev.disabled = tut.step === 0;
  elTutNext.textContent = (tut.step === tut.steps.length-1) ? "–ì–æ—Ç–æ–≤–æ" : "–î–∞–ª–µ–µ ‚Üí";

  // —Ñ–æ–∫—É—Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π
  const node = s.focus ? qs(s.focus) : null;
  if(!node){
    elTutSpot.style.display = "none";
    return;
  }

  // –µ—Å–ª–∏ –Ω—É–∂–Ω—ã–π —ç–∫—Ä–∞–Ω –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω, –Ω–µ –ª–æ–º–∞–µ–º—Å—è
  const rect = node.getBoundingClientRect();
  const pad = 8;

  elTutSpot.style.display = "block";
  elTutSpot.style.left   = Math.max(8, rect.left - pad) + "px";
  elTutSpot.style.top    = Math.max(8, rect.top - pad) + "px";
  elTutSpot.style.width  = Math.max(40, rect.width + pad*2) + "px";
  elTutSpot.style.height = Math.max(40, rect.height + pad*2) + "px";
}

elTutPrev.addEventListener("click", (e)=>{
  e.preventDefault();
  if(tut.step>0){ tut.step--; renderTutorialStep(); }
});

elTutNext.addEventListener("click", (e)=>{
  e.preventDefault();
  if(tut.step >= tut.steps.length-1){
    stopTutorial();
  } else {
    tut.step++;
    renderTutorialStep();
  }
});

elTutClose.addEventListener("click", (e)=>{
  e.preventDefault();
  stopTutorial();
});

// —á—Ç–æ–±—ã –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –Ω–µ —Å—ä–µ–∑–∂–∞–ª–∞ –ø—Ä–∏ —Ä–µ—Å–∞–π–∑–µ/—Å–∫—Ä–æ–ª–ª–µ
window.addEventListener("resize", ()=> { if(tut.active) renderTutorialStep(); });
window.addEventListener("scroll",  ()=> { if(tut.active) renderTutorialStep(); }, true);

// —ç–∫—Å–ø–æ—Ä—Ç
window.startTutorial = startTutorial;

  
const elLootOverlay = document.getElementById("loot-overlay");
const elLootTitle   = document.getElementById("loot-title");
const elLootText    = document.getElementById("loot-text");
const elLootHint    = document.getElementById("loot-hint");
const elLootOk      = document.getElementById("loot-ok");

function showLootModal({ title, text, hint }){
  elLootTitle.textContent = title || "–ù–∞–≥—Ä–∞–¥–∞";
  elLootText.innerHTML = text || "";
  elLootHint.textContent = hint || "";

  elLootOverlay.style.display = "block";
  elLootOverlay.classList.add("active");
}

function closeLootModal(){
  elLootOverlay.classList.remove("active");
  elLootOverlay.style.display = "none";
}

elLootOk.addEventListener("click", (e)=>{
  e.preventDefault();
  closeLootModal();
});

  
/* =========================================================
   14) INIT
========================================================= */

boot().then(() => {
  showScreen("clinic"); // –µ—Å–ª–∏ —Ç–µ–±–µ –Ω–∞–¥–æ –≤—Å–µ–≥–¥–∞ —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å —Å –∫–ª–∏–Ω–∏–∫–∏

  if(!localStorage.getItem(LS_TUTORIAL_DONE)){
    startTutorial(false);
  }

  refreshVisibleUI();
}).catch(err => {
  showCrash("BOOT CRASH", err);
});
  
 
/* =========================================================
   15) GLOBAL EXPORTS (for onclick)
========================================================= */

window.openPatientById = openPatientById;
window.backToClinic = backToClinic;
window.chooseTreatment = chooseTreatment;
window.upgradeWardStat = upgradeWardStat;
window.dischargePatient = dischargePatient;
window.rerollDuty = rerollDuty;
window.buyWardB = buyWardB;
window.startNewShift = startNewShift;  
window.openStaff = openStaff;
window.assignDoctorToSlot = assignDoctorToSlot;  
window.labResearchSelected = labResearchSelected;
window.chooseReward = chooseReward;  

</script>
</body>
</html>
